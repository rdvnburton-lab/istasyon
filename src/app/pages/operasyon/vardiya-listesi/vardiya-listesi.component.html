<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- GLOBAL LOADING OVERLAY -->
<div *ngIf="showGlobalLoading" class="fixed inset-0 bg-black/70 z-[9999] flex items-center justify-center">
    <div class="bg-white dark:bg-surface-800 rounded-2xl p-8 shadow-2xl max-w-md w-full mx-4">
        <div class="text-center">
            <p-progressSpinner styleClass="w-16 h-16 mx-auto mb-4"></p-progressSpinner>
            <h3 class="text-xl font-bold text-[var(--text-color)] mb-2">{{ islemDurumu }}</h3>
            <p-progressBar [value]="islemYuzdesi" [showValue]="false" styleClass="mb-4"></p-progressBar>
            <p class="text-sm text-[var(--text-color-secondary)]">Lütfen bekleyiniz, işlem devam ediyor...</p>
            <div class="mt-4 flex items-center justify-center gap-2 text-xs text-[var(--text-color-secondary)]">
                <i class="pi pi-info-circle"></i>
                <span>Adım {{ currentStep + 1 }} / {{ processingSteps.length }}</span>
            </div>
        </div>
    </div>
</div>

<!-- MOBILE NATIVE VIEW -->
<div class="vardiya-page block md:hidden">
    <!-- Mobile Native Header -->
    <div class="mobile-page-header">
        <h1 class="page-title">Vardiya Mutabakatı</h1>
        <p class="page-subtitle">Otomasyon dosyalarını yönetin</p>
    </div>

    <!-- Summary Cards -->
    <div class="summary-scroll">
        <div class="summary-card blue" (click)="dosyaDialogAc()">
            <div class="summary-icon"><i class="pi pi-folder-open"></i></div>
            <div class="summary-value">{{ vardiyalar.length }}</div>
            <div class="summary-label">Yüklenen</div>
        </div>
        <div class="summary-card orange">
            <div class="summary-icon"><i class="pi pi-hourglass"></i></div>
            <div class="summary-value">{{ getMutabakatBekleyenSayisi() }}</div>
            <div class="summary-label">Bekleyen</div>
        </div>
        <div class="summary-card green">
            <div class="summary-icon"><i class="pi pi-check-circle"></i></div>
            <div class="summary-value">{{ getTamamlananSayisi() }}</div>
            <div class="summary-label">Tamamlanan</div>
        </div>
        <div class="summary-card purple">
            <div class="summary-icon"><i class="pi pi-wallet"></i></div>
            <div class="summary-value">{{ formatShortNumber(summary.toplamCiro) }}₺</div>
            <div class="summary-label">Toplam</div>
        </div>
    </div>

    <!-- Otomatik Dosyalar Section -->
    <div class="otomatik-section" *ngIf="otomatikDosyalar.length > 0">
        <div class="section-title-bar">
            <div class="section-title">
                <i class="pi pi-bolt text-blue-500"></i>
                Otomatik Dosyalar
                <span class="count-badge">{{ otomatikDosyalar.length }}</span>
            </div>
        </div>
        <div class="otomatik-list">
            <div *ngFor="let file of otomatikDosyalar.slice(autoFirst, autoFirst + autoRows)"
                class="otomatik-card cursor-pointer hover:bg-blue-50 dark:hover:bg-blue-900/20"
                (click)="otomatikDosyaIsle(file)">
                <div class="otomatik-icon">
                    <i class="pi pi-file-import"></i>
                </div>
                <div class="otomatik-info">
                    <div class="otomatik-name">{{ file.dosyaAdi }}</div>
                    <div class="otomatik-meta">
                        {{ file.yuklemeTarihi | date:'dd.MM.yyyy HH:mm' }}
                        <p-tag *ngIf="isNextProcess(file)" value="Önerilen Sıra" severity="success"
                            styleClass="ml-2 text-[10px] py-0 px-1"></p-tag>
                    </div>
                </div>
                <div class="otomatik-arrow">
                    <i class="pi pi-arrow-right"></i>
                </div>
            </div>

            <p-paginator (onPageChange)="onAutoPageChange($event)" [first]="autoFirst" [rows]="autoRows"
                [totalRecords]="otomatikDosyalar.length" [rowsPerPageOptions]="[6,12,24]"
                *ngIf="otomatikDosyalar.length > autoRows">
            </p-paginator>
        </div>
    </div>

    <!-- Vardiya Cards Section -->
    <div class="vardiya-section">
        <div class="section-title-bar">
            <div class="section-title">Yüklenen Vardiyalar</div>
        </div>

        <div class="vardiya-list" *ngIf="vardiyalar.length > 0">
            <div *ngFor="let vardiya of vardiyalar" class="vardiya-card">
                <div class="vardiya-header">
                    <div class="file-icon">
                        <i class="pi pi-file"></i>
                    </div>
                    <div class="vardiya-info">
                        <div class="vardiya-name">{{ vardiya.dosyaAdi }}</div>
                        <div class="vardiya-meta">
                            <i class="pi pi-clock"></i>
                            <span>{{ vardiya.yuklemeTarihi | date:'dd.MM.yyyy HH:mm' }}</span>
                        </div>
                    </div>
                    <p-tag [value]="getDurumLabel(vardiya.durum)" [severity]="getDurumSeverity(vardiya.durum)"
                        [style]="{fontSize: '0.65rem'}"></p-tag>
                </div>

                <div class="vardiya-stats">
                    <div class="stat-box">
                        <div class="stat-label">Personel</div>
                        <div class="stat-value">{{ vardiya.personelSayisi }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">İşlem</div>
                        <div class="stat-value">{{ vardiya.islemSayisi }}</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-label">Tutar</div>
                        <div class="stat-value">{{ vardiya.toplamTutar | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
                    </div>
                </div>

                <div class="vardiya-footer">
                    <div class="vardiya-date" *ngIf="vardiya.baslangicTarih">
                        <span style="font-weight: 600; color: #1e293b;">{{ vardiya.baslangicTarih | date:'dd MMM'
                            }}</span>
                        <span style="color: #94a3b8; margin-left: 0.5rem;">{{ vardiya.baslangicTarih | date:'HH:mm'
                            }}</span>
                    </div>
                    <div class="vardiya-actions">
                        <!-- İncele Butonu - Tüm Vardiyalar İçin -->
                        <button class="action-btn info" (click)="incele(vardiya)">
                            <i class="pi pi-search"></i>
                        </button>
                        <!-- Mutabakat Başlat - Sadece Açık Vardiyalar İçin -->
                        <button *ngIf="vardiya.durum === 'ACIK' || vardiya.durum === 'REDDEDILDI'"
                            class="action-btn success" (click)="mutabakatYap(vardiya)">
                            <i class="pi pi-calculator"></i>
                        </button>
                        <button class="action-btn info" (click)="dosyaIndir(vardiya)">
                            <i class="pi pi-download"></i>
                        </button>
                        <!-- Sil Butonu -->
                        <button
                            *ngIf="vardiya.durum !== 'ONAY_BEKLIYOR' && vardiya.durum !== 'SILINME_ONAYI_BEKLIYOR' && vardiya.durum !== 'SILINDI' && !(userRole !== 'admin' && userRole !== 'patron' && vardiya.durum === 'ONAYLANDI')"
                            class="action-btn danger" (click)="vardiyaSil(vardiya)">
                            <i class="pi pi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Empty State -->
        <div *ngIf="vardiyalar.length === 0" class="empty-state">
            <div class="empty-icon">
                <i class="pi pi-upload"></i>
            </div>
            <div class="empty-title">Henüz vardiya verisi yok</div>
            <div class="empty-text">Otomasyon TXT dosyasını yükleyerek başlayın</div>
            <button class="empty-btn" (click)="dosyaDialogAc()">
                <i class="pi pi-upload"></i>
                <span>Dosya Yükle</span>
            </button>
        </div>
    </div>

    <!-- FAB Upload Button -->
    <button class="fab-upload" (click)="dosyaDialogAc()">
        <i class="pi pi-plus"></i>
    </button>
</div>

<!-- DESKTOP VIEW -->
<div class="grid grid-cols-12 gap-6 hidden md:grid">
    <!-- Başlık -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-[var(--text-color)] dark:text-surface-100 m-0">
                        <i class="pi pi-list mr-2 text-blue-500"></i>Vardiya Mutabakatı
                    </h2>
                    <p class="text-[var(--text-color-secondary)] mt-2">
                        Otomasyon TXT dosyasını yükleyin ve mutabakat işlemini gerçekleştirin
                    </p>
                </div>

            </div>
        </div>
    </div>

    <!-- Özet Kartları -->
    <div class="col-span-12 md:col-span-6 lg:col-span-3">
        <div class="card h-full cursor-pointer transition-all duration-300 hover:shadow-lg border-t-4 border-t-blue-500 p-0 overflow-hidden"
            (click)="dosyaDialogAc()">
            <div class="p-4">
                <div class="flex justify-between items-start mb-4">
                    <div
                        class="w-12 h-12 rounded-xl flex items-center justify-center bg-blue-500/10 dark:bg-blue-500/20 text-blue-600 dark:text-blue-400">
                        <i class="pi pi-folder-open text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span
                            class="text-xs font-semibold uppercase tracking-wider text-[var(--text-color-secondary)]">Yüklenen</span>
                        <h3 class="text-3xl font-bold m-0 text-[var(--text-color)]">{{ vardiyalar.length }}</h3>
                    </div>
                </div>
                <div class="pt-3 border-t border-[var(--surface-border)]">
                    <div class="flex items-center gap-2 text-[var(--text-color-secondary)]">
                        <i class="pi pi-plus-circle text-xs"></i>
                        <span class="text-xs font-medium">Yeni dosya yüklemek için tıklayın</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-12 md:col-span-6 lg:col-span-3">
        <div
            class="card h-full transition-all duration-300 hover:shadow-lg border-t-4 border-t-amber-500 p-0 overflow-hidden">
            <div class="p-4">
                <div class="flex justify-between items-start mb-4">
                    <div
                        class="w-12 h-12 rounded-xl flex items-center justify-center bg-amber-500/10 dark:bg-amber-500/20 text-amber-600 dark:text-amber-400">
                        <i class="pi pi-hourglass text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span
                            class="text-xs font-semibold uppercase tracking-wider text-[var(--text-color-secondary)]">Bekleyen</span>
                        <h3 class="text-3xl font-bold m-0 text-[var(--text-color)]">{{ getMutabakatBekleyenSayisi() }}
                        </h3>
                    </div>
                </div>
                <div class="pt-3 border-t border-[var(--surface-border)]">
                    <div class="flex items-center gap-2"
                        [ngClass]="getMutabakatBekleyenSayisi() > 0 ? 'text-amber-600 dark:text-amber-400' : 'text-[var(--text-color-secondary)]'">
                        <i class="pi pi-exclamation-triangle text-xs"></i>
                        <span class="text-xs font-medium">
                            {{ getMutabakatBekleyenSayisi() > 0 ? 'Mutabakat işlemi bekliyor!' : 'Tüm işlemler tamam' }}
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-12 md:col-span-6 lg:col-span-3">
        <div
            class="card h-full transition-all duration-300 hover:shadow-lg border-t-4 border-t-emerald-500 p-0 overflow-hidden">
            <div class="p-4">
                <div class="flex justify-between items-start mb-4">
                    <div
                        class="w-12 h-12 rounded-xl flex items-center justify-center bg-emerald-500/10 dark:bg-emerald-500/20 text-emerald-600 dark:text-emerald-400">
                        <i class="pi pi-check-circle text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span
                            class="text-xs font-semibold uppercase tracking-wider text-[var(--text-color-secondary)]">Tamamlanan</span>
                        <h3 class="text-3xl font-bold m-0 text-[var(--text-color)]">{{ getTamamlananSayisi() }}</h3>
                    </div>
                </div>
                <div class="pt-3 border-t border-[var(--surface-border)]">
                    <div
                        class="flex items-center justify-between mb-2 text-xs font-medium text-[var(--text-color-secondary)]">
                        <span>Başarı Oranı</span>
                        <span class="text-[var(--text-color)]">{{ getBasariOrani() }}%</span>
                    </div>
                    <div class="w-full bg-[var(--surface-ground)] rounded-full h-1.5">
                        <div class="bg-emerald-500 rounded-full h-1.5 transition-all duration-500"
                            [style.width.%]="getBasariOrani()"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-span-12 md:col-span-6 lg:col-span-3">
        <div
            class="card h-full transition-all duration-300 hover:shadow-lg border-t-4 border-t-violet-500 p-0 overflow-hidden">
            <div class="p-4">
                <div class="flex justify-between items-start mb-4">
                    <div
                        class="w-12 h-12 rounded-xl flex items-center justify-center bg-violet-500/10 dark:bg-violet-500/20 text-violet-600 dark:text-violet-400">
                        <i class="pi pi-wallet text-xl"></i>
                    </div>
                    <div class="text-right">
                        <span
                            class="text-xs font-semibold uppercase tracking-wider text-[var(--text-color-secondary)]">Toplam
                            Ciro</span>
                        <h3 class="text-2xl font-bold m-0 text-[var(--text-color)]">{{
                            formatShortNumber(summary.toplamCiro) }} ₺</h3>
                    </div>
                </div>
                <div class="pt-3 border-t border-[var(--surface-border)]">
                    <div class="flex items-center gap-3 text-xs font-medium text-[var(--text-color-secondary)]">
                        <div class="flex items-center gap-1">
                            <i class="pi pi-receipt"></i>
                            <span>{{ formatShortNumber(summary.toplamIslem) }} işlem</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <i class="pi pi-users"></i>
                            <span>{{ summary.benzersizPersonelSayisi }} personel</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Otomatik Gelen Dosyalar (Kapalı Sistem) -->
    <div class="col-span-12" *ngIf="otomatikDosyalar.length > 0">
        <div class="card border-2 border-blue-100 dark:border-blue-900 bg-blue-50/30 dark:bg-blue-900/10">
            <div class="flex justify-between items-center mb-4">
                <h5 class="font-bold m-0 flex items-center gap-2 text-blue-700 dark:text-blue-300">
                    <i class="pi pi-bolt text-blue-500"></i>
                    Otomatik Gelen Dosyalar (İstasyon Bazlı)
                    <p-tag [value]="otomatikDosyalar.length.toString()" severity="info" styleClass="ml-2"></p-tag>
                </h5>
                <span class="text-xs text-blue-600 dark:text-blue-400 italic">
                    <i class="pi pi-shield mr-1"></i> Bu dosyalar sistem tarafından otomatik olarak aktarılmıştır ve
                    müdahale edilmemiştir.
                </span>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <div *ngFor="let file of otomatikDosyalar.slice(autoFirst, autoFirst + autoRows)"
                    class="p-3 rounded-xl border shadow-sm transition-all group relative border-blue-200 dark:border-blue-800 bg-[var(--surface-card)] dark:bg-surface-900 hover:shadow-md cursor-pointer"
                    (click)="otomatikDosyaIsle(file)">

                    <!-- Sıra Badge -->
                    <div class="absolute top-2 right-2">
                        <p-tag *ngIf="isNextProcess(file)" value="Önerilen Sıra" severity="success"></p-tag>
                    </div>

                    <div class="flex items-start gap-3">
                        <div
                            class="w-12 h-12 rounded-xl flex items-center justify-center text-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 group-hover:scale-105 transition-transform flex-shrink-0">
                            <i class="pi pi-file-excel"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <!-- Vardiya Tarihi ve Sırası (Büyük) -->
                            <ng-container *ngIf="parseFileNameInfo(file.dosyaAdi) as fileInfo">
                                <div *ngIf="fileInfo.valid"
                                    class="font-bold text-base text-[var(--text-color)] mb-0.5 truncate">
                                    {{ getVardiyaDate(fileInfo.date) | date:'d MMMM yyyy':'':'tr' }}
                                </div>
                                <div *ngIf="fileInfo.valid" class="text-sm text-[var(--text-color-secondary)] mb-1">
                                    {{ fileInfo.sequence }}. Vardiya
                                </div>
                                <!-- Dosya Adı (Küçük) -->
                                <div class="text-xs text-[var(--text-color-secondary)] opacity-60 truncate">
                                    {{ file.dosyaAdi }}
                                </div>
                            </ng-container>
                            <!-- Fallback: Parse edilemezse dosya adını göster -->
                            <ng-container *ngIf="!parseFileNameInfo(file.dosyaAdi).valid">
                                <div class="font-bold text-sm text-[var(--text-color)] truncate">
                                    {{ file.dosyaAdi }}
                                </div>
                                <div class="text-xs text-[var(--text-color-secondary)] mt-1">
                                    {{ file.yuklemeTarihi | date:'dd.MM.yyyy HH:mm' }}
                                </div>
                            </ng-container>
                        </div>
                    </div>

                    <!-- İstasyon Adı ve Ok - En Altta -->
                    <div
                        class="flex items-center justify-between mt-3 pt-2 border-t border-blue-100 dark:border-blue-800">
                        <span
                            class="text-xs px-2 py-1 rounded font-medium bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400 truncate flex-1 mr-2">
                            <i class="pi pi-map-marker mr-1 text-[10px]"></i>{{ file.istasyonAd }}
                        </span>
                        <i
                            class="pi pi-arrow-right text-blue-500 text-sm group-hover:translate-x-1 transition-transform"></i>
                    </div>
                </div>
            </div>

            <p-paginator (onPageChange)="onAutoPageChange($event)" [first]="autoFirst" [rows]="autoRows"
                [totalRecords]="otomatikDosyalar.length" [rowsPerPageOptions]="[6,9,18,36]"
                styleClass="mt-4 border-t border-[var(--surface-border)]" *ngIf="otomatikDosyalar.length > autoRows">
            </p-paginator>
        </div>
    </div>

    <!-- Vardiya Listesi -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex justify-between items-center mb-4">
                <h5 class="font-bold m-0 flex items-center gap-2">
                    <i class="pi pi-list text-blue-500"></i>
                    Yüklenen Vardiyalar
                </h5>
                <p-button label="Yeni Dosya Yükle" icon="pi pi-upload" severity="primary" (onClick)="dosyaDialogAc()">
                </p-button>
            </div>

            <p-table [value]="vardiyalar" [paginator]="vardiyalar.length > rowsPerPage" [rows]="rowsPerPage" #dt
                [globalFilterFields]="['dosyaAdi']">
                styleClass="p-datatable-striped">

                <ng-template pTemplate="caption">
                    <div class="flex justify-end">
                        <p-iconfield>
                            <p-inputicon class="pi pi-search" />
                            <input pInputText type="text" placeholder="Dosya adı ara..."
                                (input)="dt.filterGlobal($any($event.target).value, 'contains')" />
                        </p-iconfield>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr class="text-sm">
                        <th class="font-bold">Dosya Bilgisi</th>
                        <th class="font-bold">Vardiya Saati</th>
                        <th class="font-bold text-center">Personel</th>
                        <th class="font-bold text-center">İşlem</th>
                        <th class="font-bold text-right">Toplam Tutar</th>
                        <th class="font-bold text-center">Durum</th>
                        <th></th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-vardiya>
                    <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                        <td>
                            <div class="flex flex-col">
                                <span class="font-bold text-lg text-gray-800 dark:text-gray-200">
                                    {{ vardiya.yuklemeTarihi | date:'dd.MM.yyyy HH:mm' }}
                                </span>
                                <span class="text-sm text-gray-400 mt-1 flex items-center gap-1">
                                    <i class="pi pi-file text-xs"></i>
                                    {{ vardiya.dosyaAdi }}
                                </span>
                            </div>
                        </td>

                        <td>
                            <div *ngIf="vardiya.baslangicTarih" class="flex flex-col">
                                <span class="font-bold text-[var(--text-color)] dark:text-surface-100">{{
                                    vardiya.baslangicTarih
                                    | date:'dd MMMM yyyy':'':'tr' }}</span>
                                <span class="text-sm flex items-center gap-1" style="color: #6366f1;">
                                    <i class="pi pi-clock text-xs"></i>
                                    {{ vardiya.baslangicTarih | date:'HH:mm' }} - {{
                                    vardiya.bitisTarih | date:'HH:mm'
                                    }}
                                </span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg"
                                style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
                                <i class="pi pi-users" style="color: #22c55e;"></i>
                                <span class="font-bold" style="color: #16a34a;">{{
                                    vardiya.personelSayisi }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <div class="inline-flex items-center gap-2 px-3 py-2 rounded-lg"
                                style="background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
                                <i class="pi pi-receipt" style="color: #f59e0b;"></i>
                                <span class="font-bold" style="color: #d97706;">{{
                                    vardiya.islemSayisi }}</span>
                            </div>
                        </td>
                        <td class="text-right">
                            <div class="inline-block px-4 py-2 rounded-xl"
                                style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);">
                                <span class="font-bold text-lg text-white">{{
                                    vardiya.toplamTutar |
                                    currency:'TRY':'symbol-narrow':'1.2-2':'tr'
                                    }}</span>
                            </div>
                        </td>
                        <td class="text-center">
                            <p-tag [value]="getDurumLabel(vardiya.durum)" [severity]="getDurumSeverity(vardiya.durum)"
                                styleClass="text-sm px-3 py-1 cursor-pointer"
                                [pTooltip]="vardiya.durum === 'REDDEDILDI' ? vardiya.redNedeni : undefined"
                                tooltipPosition="bottom">
                            </p-tag>
                        </td>
                        <td>
                            <div class="flex gap-2 justify-end">
                                <!-- İncele Butonu - Tüm Vardiyalar İçin -->
                                <button pButton pRipple icon="pi pi-eye"
                                    class="p-button-rounded p-button-info p-button-text" (click)="incele(vardiya)"
                                    pTooltip="Vardiya Detaylarını Görüntüle" tooltipPosition="bottom"></button>

                                <!-- Mutabakat Başlat - Sadece Açık/Reddedilmiş Vardiyalar -->
                                <button *ngIf="vardiya.durum === 'ACIK' || vardiya.durum === 'REDDEDILDI'" pButton
                                    pRipple icon="pi pi-calculator"
                                    class="p-button-rounded p-button-success p-button-text mr-2"
                                    (click)="mutabakatYap(vardiya)"
                                    [pTooltip]="vardiya.durum === 'REDDEDILDI' ? 'Mutabakatı Düzenle' : 'Mutabakat Başlat'"
                                    tooltipPosition="top"></button>

                                <!-- Rapor Butonları (Onaya Gönderildi veya Onaylandı) -->
                                <button *ngIf="vardiya.durum === 'ONAY_BEKLIYOR' || vardiya.durum === 'ONAYLANDI'"
                                    pButton pRipple icon="pi pi-file-excel"
                                    class="p-button-rounded p-button-success p-button-text"
                                    (click)="excelIndir(vardiya)" pTooltip="Excel Raporu"
                                    tooltipPosition="top"></button>
                                <button *ngIf="vardiya.durum === 'ONAY_BEKLIYOR' || vardiya.durum === 'ONAYLANDI'"
                                    pButton pRipple icon="pi pi-file-pdf"
                                    class="p-button-rounded p-button-danger p-button-text mr-2"
                                    (click)="pdfIndir(vardiya)" pTooltip="PDF Raporu" tooltipPosition="top"></button>

                                <button pButton pRipple icon="pi pi-download"
                                    class="p-button-rounded p-button-info p-button-text mr-2"
                                    (click)="dosyaIndir(vardiya)" pTooltip="Dosyayı İndir"
                                    tooltipPosition="top"></button>
                                <button pButton pRipple icon="pi pi-trash"
                                    class="p-button-rounded p-button-danger p-button-text" (click)="vardiyaSil(vardiya)"
                                    pTooltip="Sil" tooltipPosition="top"
                                    *ngIf="vardiya.durum !== 'ONAY_BEKLIYOR' && vardiya.durum !== 'SILINME_ONAYI_BEKLIYOR' && vardiya.durum !== 'SILINDI' && !(userRole !== 'admin' && userRole !== 'patron' && vardiya.durum === 'ONAYLANDI')"></button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center py-12">
                            <div class="flex flex-col items-center">
                                <div
                                    class="w-24 h-24 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center mb-4">
                                    <i class="pi pi-upload text-4xl text-surface-400"></i>
                                </div>
                                <h4 class="text-surface-600 dark:text-surface-300 m-0">Henüz
                                    vardiya verisi yok</h4>
                                <p class="text-surface-400 text-sm m-0 mt-2">
                                    Otomasyon TXT dosyasını yükleyerek başlayın
                                </p>
                                <p-button label="Dosya Yükle" icon="pi pi-upload" severity="success" styleClass="mt-4"
                                    (onClick)="dosyaDialogAc()">
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>

<!-- Dosya Yükleme Dialog -->
<p-dialog [header]="isAutomaticFile ? 'Otomatik Veriyi İşle' : 'Otomasyon Verisi Yükle'"
    [(visible)]="dosyaDialogVisible" [modal]="true" [style]="{width: '600px'}">

    <div class="flex flex-col gap-4">
        <!-- Otomatik Dosya Bilgi Banner -->
        <div *ngIf="isAutomaticFile" class="p-4 rounded-xl bg-blue-600 text-white shadow-lg mb-2">
            <div class="flex items-center gap-3">
                <i class="pi pi-shield text-2xl"></i>
                <div>
                    <p class="font-bold m-0 text-lg">Güvenli Otomatik Aktarım</p>
                    <p class="text-xs m-0 opacity-90">Bu veri istasyondan doğrudan gelmiştir.
                        İçerik bütünlüğü
                        doğrulanmıştır.</p>
                </div>
            </div>
        </div>

        <!-- Dosya Seçme -->
        <div *ngIf="!isAutomaticFile"
            class="border-2 border-dashed border-surface-300 dark:border-surface-600 rounded-xl p-8 text-center"
            [ngClass]="{'border-green-500 bg-green-50': secilenDosya}">

            <input type="file" accept=".zip,.ZIP" (change)="dosyaSec($event)" #fileInput class="hidden">

            <div *ngIf="!secilenDosya">
                <i class="pi pi-cloud-upload text-5xl text-surface-400 mb-4"></i>
                <p class="text-surface-600 dark:text-surface-300 font-semibold m-0">
                    Otomasyon ZIP dosyasını sürükleyin veya seçin
                </p>
                <p class="text-surface-400 text-sm m-0 mt-1">
                    Desteklenen uzantılar: .ZIP
                </p>
                <p-button label="Dosya Seç" icon="pi pi-folder-open" severity="secondary" styleClass="mt-4"
                    (onClick)="fileInput.click()">
                </p-button>
            </div>

            <div *ngIf="secilenDosya" class="text-green-700 dark:text-green-300">
                <i class="pi pi-file text-5xl mb-4"></i>
                <p class="font-semibold m-0">{{ secilenDosya.name }}</p>
                <p class="text-sm m-0 mt-1">{{ (secilenDosya.size / 1024).toFixed(1) }} KB</p>
                <p-button label="Değiştir" icon="pi pi-refresh" severity="secondary" size="small" styleClass="mt-3"
                    (onClick)="fileInput.click()">
                </p-button>
            </div>
        </div>

        <!-- ZIP Dosyası Bilgisi ve Onay -->
        <div *ngIf="secilenDosya && !yukleniyor"
            class="p-4 rounded-lg bg-blue-50 dark:bg-blue-900/20 text-blue-700 dark:text-blue-300">
            <div class="flex items-center gap-2 mb-2">
                <i class="pi pi-info-circle text-xl"></i>
                <span class="font-semibold">Dosya Yükleme</span>
            </div>
            <p class="m-0 text-sm">Seçilen dosya sunucuya yüklenecek ve otomatik olarak işlenecektir.</p>
        </div>

        <!-- İşlem Progress -->
        <div *ngIf="yukleniyor" class="p-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
            <div class="flex items-center gap-3 mb-3">
                <i class="pi pi-spin pi-spinner text-2xl text-blue-500"></i>
                <div>
                    <p class="font-semibold text-blue-700 dark:text-blue-300 m-0">Dosya
                        İşleniyor...</p>
                    <p class="text-blue-600 dark:text-blue-400 text-sm m-0">{{ islemDurumu }}
                    </p>
                </div>
            </div>
            <p-progressBar [value]="islemYuzdesi" [showValue]="true" [style]="{'height': '8px'}"></p-progressBar>
            <div class="flex justify-between text-xs text-blue-500 mt-2">
                <span>{{ bulunanKayit }} kayıt bulundu</span>
                <span>{{ gecenSure }}s</span>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary" (onClick)="dosyaDialogKapat()"></p-button>
        <p-button label="Yükle ve Devam Et" icon="pi pi-check" severity="success"
            [disabled]="!secilenDosya || yukleniyor" (onClick)="dosyaYukle()">
        </p-button>
    </ng-template>
</p-dialog><!-- Silme Talebi Dialog -->
<p-dialog header="Vardiya Silme Talebi" [(visible)]="silmeTalebiDialogVisible" [modal]="true"
    [style]="{width: '500px'}">
    <div class="flex flex-col gap-4">
        <p class="text-surface-600 dark:text-surface-300">
            <strong>{{ secilenVardiya?.dosyaAdi }}</strong> dosyasını silmek istediğinize emin
            misiniz?
        </p>
        <p class="text-sm text-[var(--text-color-secondary)]">
            Bu işlem onaya gönderilecek ve patron/admin onayından sonra vardiya silinmiş olarak
            işaretlenecektir.
        </p>
        <div class="flex flex-col gap-2">
            <label for="silmeNedeni" class="font-bold">Silme Nedeni <span class="text-red-500">*</span></label>
            <textarea id="silmeNedeni" [(ngModel)]="silmeNedeni" rows="4"
                class="w-full p-3 border border-surface-300 dark:border-surface-600 rounded-lg"
                placeholder="Örn: Yanlış dosya yüklendi, tekrar yüklenecek..." [required]="true">
            </textarea>
            <small class="text-[var(--text-color-secondary)]">En az 10 karakter giriniz</small>
        </div>
    </div>
    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" [text]="true" (onClick)="silmeTalebiDialogKapat()"></p-button>
        <p-button label="Silme Talebini Gönder" icon="pi pi-send" severity="danger"
            [disabled]="!silmeNedeni || silmeNedeni.trim().length < 10" (onClick)="silmeTalebiGonder()">
        </p-button>
    </ng-template>
</p-dialog>

<!-- Detay Modalı -->
<p-dialog [(visible)]="detayVisible" [modal]="true" [style]="{ width: '90vw' }" [maximizable]="true" [draggable]="false"
    [resizable]="false">

    <ng-template pTemplate="header">
        <div class="flex flex-col justify-center">
            <span class="font-bold text-base md:text-xl text-[var(--text-color)]">
                {{ seciliVardiyaDetay?.baslangicTarih | date:'dd.MM.yyyy' }}
            </span>
            <span class="text-xs md:text-sm text-muted-color">
                {{ seciliVardiyaDetay?.baslangicTarih | date:'HH:mm' }} - {{ seciliVardiyaDetay?.bitisTarih |
                date:'HH:mm' }}
            </span>
        </div>
    </ng-template>

    <div *ngIf="seciliVardiyaDetay && genelOzet" class="flex flex-col gap-6">

        <!-- MOBILE: Horizontal Scroll Summary Cards -->
        <div class="summary-scroll block md:hidden">
            <div class="summary-card blue">
                <div class="summary-icon"><i class="pi pi-chart-line"></i></div>
                <div class="summary-value">{{ pompaciSatisTutar | number:'1.0-0' }}₺</div>
                <div class="summary-label">Pompa Cirosu</div>
            </div>
            <div class="summary-card green">
                <div class="summary-icon"><i class="pi pi-users"></i></div>
                <div class="summary-value">{{ pompaCiroGosterim | number:'1.0-0' }}₺</div>
                <div class="summary-label">Pompacı Satış</div>
            </div>
            <div class="summary-card purple" (click)="openKrediKartiDetay()">
                <div class="summary-icon"><i class="pi pi-credit-card"></i></div>
                <div class="summary-value">{{ toplamKrediKarti | number:'1.0-0' }}₺</div>
                <div class="summary-label">Kredi Kartı</div>
            </div>
            <div class="summary-card orange">
                <div class="summary-icon"><i class="pi pi-money-bill"></i></div>
                <div class="summary-value">{{ pompaciNakitToplam | number:'1.0-0' }}₺</div>
                <div class="summary-label">Nakit</div>
            </div>
            <!-- Dinamik Kartlar (Mobile) -->
            <div *ngIf="digerOdemelerToplamTutar > 0" class="summary-card purple">
                <div class="summary-icon"><i class="pi pi-tags"></i></div>
                <div class="summary-value">{{ digerOdemelerToplamTutar | number:'1.0-0' }}₺</div>
                <div class="summary-label">Diğer Tahsilatlar</div>
            </div>
            <div class="summary-card" [ngClass]="{
                'green': pompaFarkDurumRenk === 'success',
                'orange': pompaFarkDurumRenk === 'warn',
                'red': pompaFarkDurumRenk === 'danger'
            }">
                <div class="summary-icon">
                    <i class="pi" [ngClass]="{
                        'pi-check-circle': pompaFarkDurumRenk === 'success',
                        'pi-exclamation-circle': pompaFarkDurumRenk !== 'success'
                    }"></i>
                </div>
                <div class="summary-value">{{ pompaFark | number:'1.0-0' }}₺</div>
                <div class="summary-label">Fark</div>
            </div>
        </div>

        <!-- DESKTOP: Grid Summary Cards -->
        <div class="hidden md:grid grid-cols-1 md:grid-cols-5 gap-4">
            <div
                class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Pompa
                    Cirosu</span>
                <span class="text-3xl font-bold text-primary">{{ pompaciSatisTutar |
                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div
                class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Pompacı
                    Satışları</span>
                <span class="text-3xl font-bold text-green-600">{{ pompaCiroGosterim |
                    currency:'TRY':'symbol-narrow':'1.2-2'
                    }}</span>
            </div>
            <!-- Toplam Kredi Kartı Kartı -->
            <div class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center cursor-pointer hover:bg-surface-50 transition-colors"
                (click)="openKrediKartiDetay()">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Toplam
                    K.
                    Kartı</span>
                <span class="text-3xl font-bold text-blue-600">{{ toplamKrediKarti |
                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                <span class="text-xs text-muted-color mt-1"><i class="pi pi-search mr-1"></i>Detay</span>
            </div>
            <div
                class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Toplam
                    Nakit</span>
                <span class="text-3xl font-bold text-red-500">{{ pompaciNakitToplam |
                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <!-- Dinamik Kartlar (Desktop) -->
            <div *ngIf="digerOdemelerToplamTutar > 0"
                class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Diğer
                    Tahsilatlar</span>
                <span class="text-3xl font-bold text-indigo-600">{{ digerOdemelerToplamTutar |
                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
            </div>
            <div
                class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center bg-gray-50 dark:bg-gray-800">
                <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Fark
                    Durumu</span>
                <div class="flex items-center gap-2">
                    <i class="pi pi-circle-fill text-xs"
                        [ngClass]="{'text-green-500': pompaFarkDurumRenk === 'success', 'text-warning-500': pompaFarkDurumRenk === 'warn', 'text-red-500': pompaFarkDurumRenk === 'danger'}"></i>
                    <span class="text-3xl font-bold"
                        [ngClass]="{'text-green-600': pompaFarkDurumRenk === 'success', 'text-orange-600': pompaFarkDurumRenk === 'warn', 'text-red-600': pompaFarkDurumRenk === 'danger'}">
                        {{ pompaFark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                    </span>
                </div>
            </div>
        </div>

        <p-tabs [(value)]="activeTab">
            <p-tablist>
                <p-tab value="0">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-users"></i>
                        <span class="hidden sm:inline">Personel</span>

                    </div>
                </p-tab>
                <p-tab value="1">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-credit-card"></i>
                        <span class="hidden sm:inline">Tahsilat</span>

                    </div>
                </p-tab>
                <p-tab value="2">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-shopping-cart"></i>
                        <span class="hidden sm:inline">Market</span>

                    </div>
                </p-tab>
                <p-tab value="3">
                    <div class="flex items-center gap-2">
                        <i class="pi pi-database"></i>
                        <span class="hidden sm:inline">Tank</span>

                    </div>
                </p-tab>
            </p-tablist>

            <p-tabpanels>
                <!-- SEKME 1: POMPA & PERSONEL -->
                <p-tabpanel value="0">
                    <!-- MOBILE VIEW: Personel Cards -->
                    <div class="personel-detay-list block md:hidden mt-4">
                        <div *ngFor="let item of farkAnalizi" class="personel-detay-card">
                            <div class="personel-detay-header">
                                <div class="personel-detay-avatar">
                                    <i class="pi pi-user"></i>
                                </div>
                                <span class="personel-detay-name">{{ item.personelAdi }}</span>
                                <p-tag *ngIf="item.farkDurum === 'UYUMLU'" value="Uyumlu" severity="success"
                                    [style]="{fontSize: '0.65rem'}"></p-tag>
                                <p-tag *ngIf="item.farkDurum === 'ACIK'" value="Açık" severity="danger"
                                    [style]="{fontSize: '0.65rem'}"></p-tag>
                                <p-tag *ngIf="item.farkDurum === 'FAZLA'" value="Fazla" severity="warn"
                                    [style]="{fontSize: '0.65rem'}"></p-tag>
                            </div>

                            <div class="personel-detay-grid">
                                <!-- Otomasyon Satış -->
                                <div class="personel-stat highlight-blue">
                                    <div class="personel-stat-label">Otomasyon Satış</div>
                                    <div class="personel-stat-value">{{ item.otomasyonToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                </div>
                                <!-- Pusula Toplam -->
                                <div class="personel-stat highlight-green">
                                    <div class="personel-stat-label">Pusula Toplam</div>
                                    <div class="personel-stat-value">{{ item.pusulaToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                </div>
                                <!-- Nakit -->
                                <div class="personel-stat">
                                    <div class="personel-stat-label">Nakit</div>
                                    <div class="personel-stat-value">{{ item.pusulaDokum.nakit |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                </div>
                                <!-- Kredi Kartı -->
                                <div class="personel-stat">
                                    <div class="personel-stat-label">Kredi Kartı</div>
                                    <div class="personel-stat-value">{{ item.pusulaDokum.krediKarti |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                </div>
                                <!-- Paro Puan -->
                                <!-- Dinamik Diğer Ödemeler -->
                                <div *ngFor="let odeme of item.pusulaDokum.digerOdemeler" class="personel-stat">
                                    <div class="personel-stat-label">{{ odeme.turAdi }}</div>
                                    <div class="personel-stat-value">{{ odeme.tutar |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                </div>
                            </div>

                            <div class="personel-detay-footer">
                                <span style="font-size: 0.75rem; color: #94a3b8;">Fark:</span>
                                <div class="fark-badge" [ngClass]="{
                                    'success': item.farkDurum === 'UYUMLU',
                                    'danger': item.farkDurum === 'ACIK',
                                    'warn': item.farkDurum === 'FAZLA'
                                }">
                                    <i class="pi" [ngClass]="{
                                        'pi-check': item.farkDurum === 'UYUMLU',
                                        'pi-arrow-down': item.farkDurum === 'ACIK',
                                        'pi-arrow-up': item.farkDurum === 'FAZLA'
                                    }"></i>
                                    {{ item.fark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DESKTOP VIEW: Table -->
                    <div class="hidden md:grid grid-cols-1 mt-4">
                        <p-table [value]="farkAnalizi" styleClass="p-datatable-sm p-datatable-striped"
                            [rowHover]="true">
                            <ng-template pTemplate="header">
                                <tr>
                                    <th>Personel</th>
                                    <th class="text-right">Otomasyon Satış</th>
                                    <th class="text-right">Nakit</th>
                                    <th class="text-right">Kredi Kartı</th>
                                    <th class="text-right">Diğer Ödemeler</th>
                                    <th class="text-right">Pusula Toplam</th>
                                    <th class="text-right">Fark</th>
                                    <th class="text-center">Durum</th>
                                </tr>
                            </ng-template>
                            <ng-template pTemplate="body" let-item>
                                <tr>
                                    <td class="font-medium">{{ item.personelAdi }}</td>
                                    <td class="text-right text-muted-color">{{
                                        item.otomasyonToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                    <td class="text-right">{{ item.pusulaDokum.nakit |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                    <td class="text-right">{{ item.pusulaDokum.krediKarti |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                    <td class="text-right">
                                        <div *ngIf="item.pusulaDokum.digerOdemeler?.length > 0">
                                            <div *ngFor="let odeme of item.pusulaDokum.digerOdemeler"
                                                class="flex justify-end gap-1 text-xs">
                                                <span class="font-semibold text-gray-500">{{ odeme.turAdi }}:</span>
                                                <span>{{ odeme.tutar | number:'1.2-2' }}</span>
                                            </div>
                                        </div>
                                        <span *ngIf="!item.pusulaDokum.digerOdemeler?.length"
                                            class="text-gray-300">-</span>
                                    </td>
                                    <td class="text-right font-bold">{{ item.pusulaToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                    <td class="text-right"
                                        [ngClass]="{'text-red-500': item.fark < -1, 'text-green-500': item.fark > 1}">
                                        {{ item.fark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                                    </td>
                                    <td class="text-center">
                                        <p-tag *ngIf="item.farkDurum === 'UYUMLU'" value="Uyumlu"
                                            severity="success"></p-tag>
                                        <p-tag *ngIf="item.farkDurum === 'ACIK'" value="Açık" severity="danger"></p-tag>
                                        <p-tag *ngIf="item.farkDurum === 'FAZLA'" value="Fazla" severity="warn"></p-tag>
                                    </td>
                                </tr>
                            </ng-template>
                        </p-table>
                    </div>
                </p-tabpanel>
                <p-tabpanel value="1">
                    <!-- MOBILE VIEW: Card-based Layout -->
                    <div class="block md:hidden mt-4">
                        <!-- Tahsilat Özeti Card -->
                        <div class="personel-detay-card mb-4">
                            <div class="personel-detay-header" style="border: none; margin: 0; padding-bottom: 0;">
                                <div class="personel-detay-avatar"
                                    style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                                    <i class="pi pi-wallet" style="color: white;"></i>
                                </div>
                                <span class="personel-detay-name">Tahsilat Özeti</span>
                            </div>
                            <div style="margin-top: 0.75rem;">
                                <div class="personel-detay-grid">
                                    <div class="personel-stat highlight-green">
                                        <div class="personel-stat-label">Nakit</div>
                                        <div class="personel-stat-value">{{ genelOzet.toplamNakit |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                    <div class="personel-stat highlight-blue">
                                        <div class="personel-stat-label">Kredi Kartı</div>
                                        <div class="personel-stat-value">{{ genelOzet.toplamKrediKarti |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                    <!-- Dinamik Kartlar (Mobile) -->
                                    <div *ngFor="let item of genelOzet.digerOdemeler"
                                        class="personel-stat highlight-purple">
                                        <div class="personel-stat-label">{{ item.turAdi }}</div>
                                        <div class="personel-stat-value">{{ item.toplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                </div>
                                <div class="fark-badge success full"
                                    style="justify-content: space-between; margin-top: 0.5rem;">
                                    <span>Toplam Tahsilat</span>
                                    <span style="font-size: 1rem;">{{ (genelOzet.toplamNakit +
                                        genelOzet.toplamKrediKarti + digerOdemelerToplamTutar) |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Kredi Kartı Detayları Card -->
                        <div class="personel-detay-card">
                            <div class="personel-detay-header" style="border: none; margin: 0; padding-bottom: 0;">
                                <div class="personel-detay-avatar"
                                    style="background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);">
                                    <i class="pi pi-credit-card" style="color: white;"></i>
                                </div>
                                <span class="personel-detay-name">Kredi Kartı Detayları</span>
                            </div>
                            <div style="margin-top: 0.75rem;">
                                <div *ngFor="let item of pusulaKrediKartiDetaylari" class="personel-stat full"
                                    style="margin-bottom: 0.5rem;" [ngClass]="{'highlight-blue': item.isSpecial}">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <span class="personel-stat-label"
                                            style="text-transform: none; font-size: 0.8rem;">{{ item.banka }}</span>
                                        <span class="personel-stat-value"
                                            [ngClass]="{'color': item.isSpecial ? '#8b5cf6' : '#1e293b'}">
                                            {{ item.tutar | currency:'TRY':'symbol-narrow':'1.2-2' }}
                                        </span>
                                    </div>
                                </div>
                                <div *ngIf="pusulaKrediKartiDetaylari.length === 0"
                                    style="text-align: center; padding: 1rem; color: #94a3b8;">
                                    Kredi kartı detayı bulunamadı
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DESKTOP VIEW: Original Layout -->
                    <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-8 mt-4">
                        <!-- Sol: Tahsilat Özeti -->
                        <div class="flex flex-col gap-4">
                            <h3 class="text-lg font-bold border-b pb-2">Tahsilat Özeti</h3>
                            <div class="flex justify-between p-3 bg-surface-50 rounded">
                                <span>Nakit</span>
                                <span class="font-bold">{{ genelOzet.toplamNakit |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between p-3 rounded">
                                <span>Kredi Kartı</span>
                                <span class="font-bold text-blue-600">{{
                                    genelOzet.toplamKrediKarti |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <!-- Dinamik Liste (Desktop) -->
                            <div *ngFor="let item of genelOzet.digerOdemeler"
                                class="flex justify-between p-3 bg-surface-50 rounded">
                                <span>{{ item.turAdi }}</span>
                                <span class="font-bold">{{ item.toplam |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between p-3 bg-green-50 rounded border border-green-100 mt-2">
                                <span class="font-bold text-green-800">Toplam Tahsilat</span>
                                <span class="font-bold text-green-800">{{ (genelOzet.toplamNakit +
                                    genelOzet.toplamKrediKarti + digerOdemelerToplamTutar) |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                        </div>

                        <!-- Sağ: Kredi Kartı Detayları -->
                        <div class="flex flex-col gap-4">
                            <h3 class="text-lg font-bold border-b pb-2">Kredi Kartı Detayları
                            </h3>
                            <p-table [value]="pusulaKrediKartiDetaylari" styleClass="p-datatable-sm p-datatable-striped"
                                [scrollable]="true" scrollHeight="300px">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Banka</th>
                                        <th class="text-right">Tutar</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-item>
                                    <tr
                                        [ngClass]="{'border-t-2 border-dashed border-surface-300 dark:border-surface-600': item.showSeparator}">
                                        <td
                                            [ngClass]="{'font-bold text-[var(--text-color)] dark:text-surface-0': item.isSpecial}">
                                            {{item.banka}}
                                        </td>
                                        <td class="text-right font-bold"
                                            [ngClass]="{'text-purple-600': item.isSpecial}">
                                            {{item.tutar |
                                            currency:'TRY':'symbol-narrow':'1.2-2'}}
                                        </td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="emptymessage">
                                    <tr>
                                        <td colspan="2" class="text-center p-4 text-muted-color">Kredi kartı
                                            detayı
                                            bulunamadı.</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </div>
                </p-tabpanel>

                <!-- SEKME 3: MARKET -->
                <p-tabpanel value="2">
                    <!-- MOBILE VIEW -->
                    <div class="block md:hidden mt-4" *ngIf="marketOzet">
                        <div class="personel-detay-card mb-4">
                            <div class="personel-detay-header" style="border: none; margin: 0; padding-bottom: 0;">
                                <div class="personel-detay-avatar"
                                    style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <i class="pi pi-shopping-cart" style="color: white;"></i>
                                </div>
                                <span class="personel-detay-name">Market Özeti</span>
                            </div>
                            <div style="margin-top: 0.75rem;">
                                <div class="personel-detay-grid">
                                    <div class="personel-stat highlight-blue">
                                        <div class="personel-stat-label">Z Raporu</div>
                                        <div class="personel-stat-value">{{ marketOzet.zRaporuToplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                    <div class="personel-stat">
                                        <div class="personel-stat-label">Toplam KDV</div>
                                        <div class="personel-stat-value">{{ marketOzet.kdvDokum.toplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                    <div class="personel-stat highlight-green">
                                        <div class="personel-stat-label">Tahsilat</div>
                                        <div class="personel-stat-value">{{ marketOzet.tahsilatToplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                    <div class="personel-stat highlight-red">
                                        <div class="personel-stat-label">Giderler</div>
                                        <div class="personel-stat-value" style="color: #dc2626;">-{{
                                            marketOzet.giderToplam | currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                                    </div>
                                </div>
                                <div class="fark-badge"
                                    style="background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); color: #1d4ed8; justify-content: space-between; margin-top: 0.5rem;">
                                    <span>Net Kasa</span>
                                    <span style="font-size: 1rem; font-weight: 700;">{{ marketOzet.netKasa |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- DESKTOP VIEW -->
                    <div class="hidden md:grid grid-cols-1 md:grid-cols-2 gap-8 mt-4" *ngIf="marketOzet">
                        <div class="flex flex-col gap-4">
                            <h3 class="text-lg font-bold border-b pb-2">Z-Raporu ve Satışlar
                            </h3>
                            <div class="flex justify-between p-3 bg-surface-50 rounded">
                                <span>Z Raporu Toplamı</span>
                                <span class="font-bold">{{ marketOzet.zRaporuToplam |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between p-3 rounded">
                                <span>Toplam KDV</span>
                                <span>{{ marketOzet.kdvDokum.toplam |
                                    currency:'TRY':'symbol-narrow':'1.2-2'
                                    }}</span>
                            </div>
                        </div>
                        <div class="flex flex-col gap-4">
                            <h3 class="text-lg font-bold border-b pb-2">Kasa Durumu</h3>
                            <div class="flex justify-between p-3 bg-surface-50 rounded">
                                <span>Toplam Tahsilat (Nakit+KK)</span>
                                <span class="font-bold text-green-600">{{
                                    marketOzet.tahsilatToplam |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between p-3 rounded">
                                <span>Market Giderleri</span>
                                <span class="text-red-500">- {{ marketOzet.giderToplam |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                            <div class="flex justify-between p-3 bg-blue-50 rounded border border-blue-100">
                                <span class="font-bold text-blue-800">Net Kasa</span>
                                <span class="font-bold text-blue-800">{{ marketOzet.netKasa |
                                    currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                            </div>
                        </div>
                    </div>
                    <div *ngIf="!marketOzet" class="text-center p-8 text-muted-color">Market
                        verisi bulunamadı.
                    </div>
                </p-tabpanel>

                <!-- SEKME 4: TANK ENVANTER -->
                <p-tabpanel value="3">
                    <!-- MOBILE VIEW: Compact Tank Cards -->
                    <div class="block md:hidden mt-4">
                        <div *ngIf="tankEnvanter.length > 0" class="space-y-3">
                            <div *ngFor="let tank of tankEnvanter"
                                class="bg-white dark:bg-surface-800 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700 overflow-hidden">

                                <!-- Tank Header with Fuel Type Badge -->
                                <div class="flex items-center justify-between px-4 py-3 border-b border-surface-200 dark:border-surface-700"
                                    [ngClass]="{
                                        'bg-gradient-to-r from-blue-50 to-blue-100 dark:from-blue-900/30 dark:to-blue-800/20': tank.yakitTipi === 'MOTORIN',
                                        'bg-gradient-to-r from-green-50 to-green-100 dark:from-green-900/30 dark:to-green-800/20': tank.yakitTipi === 'BENZIN',
                                        'bg-gradient-to-r from-amber-50 to-amber-100 dark:from-amber-900/30 dark:to-amber-800/20': tank.yakitTipi !== 'MOTORIN' && tank.yakitTipi !== 'BENZIN'
                                    }">
                                    <div class="flex items-center gap-3">
                                        <div class="w-10 h-10 rounded-full flex items-center justify-center text-white font-bold text-sm"
                                            [ngClass]="{
                                                'bg-blue-500': tank.yakitTipi === 'MOTORIN',
                                                'bg-green-500': tank.yakitTipi === 'BENZIN',
                                                'bg-amber-500': tank.yakitTipi !== 'MOTORIN' && tank.yakitTipi !== 'BENZIN'
                                            }">
                                            {{ tank.tankNo }}
                                        </div>
                                        <div>
                                            <div class="font-bold text-[var(--text-color)]">{{ tank.tankAdi }}</div>
                                            <div class="text-xs text-[var(--text-color-secondary)]">{{ tank.yakitTipi }}
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Fark Badge -->
                                    <div class="px-2 py-1 rounded-full text-xs font-bold" [ngClass]="{
                                            'bg-green-100 text-green-700 dark:bg-green-900/50 dark:text-green-400': Math.abs(tank.farkMiktar) <= 20,
                                            'bg-yellow-100 text-yellow-700 dark:bg-yellow-900/50 dark:text-yellow-400': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                            'bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400': Math.abs(tank.farkMiktar) > 50
                                        }">
                                        <i class="pi text-[10px] mr-1" [ngClass]="{
                                            'pi-check': Math.abs(tank.farkMiktar) <= 20,
                                            'pi-exclamation-triangle': Math.abs(tank.farkMiktar) > 20
                                        }"></i>
                                        {{ tank.farkMiktar >= 0 ? '+' : '' }}{{ tank.farkMiktar | number:'1.0-0' }} L
                                    </div>
                                </div>

                                <!-- Tank Stats Grid -->
                                <div class="grid grid-cols-2 gap-px bg-surface-200 dark:bg-surface-700">
                                    <div class="bg-white dark:bg-surface-800 p-3 text-center">
                                        <div
                                            class="text-[10px] uppercase tracking-wide text-[var(--text-color-secondary)] mb-1">
                                            Başlangıç</div>
                                        <div class="font-bold text-sm text-[var(--text-color)]">{{ tank.baslangicStok |
                                            number:'1.0-0' }} L</div>
                                    </div>
                                    <div class="bg-white dark:bg-surface-800 p-3 text-center">
                                        <div
                                            class="text-[10px] uppercase tracking-wide text-[var(--text-color-secondary)] mb-1">
                                            Bitiş</div>
                                        <div class="font-bold text-sm text-[var(--text-color)]">{{ tank.bitisStok |
                                            number:'1.0-0' }} L</div>
                                    </div>
                                    <div class="bg-white dark:bg-surface-800 p-3 text-center"
                                        *ngIf="tank.sevkiyatMiktar > 0">
                                        <div class="text-[10px] uppercase tracking-wide text-green-600 mb-1">Sevkiyat
                                        </div>
                                        <div class="font-bold text-sm text-green-600">+{{ tank.sevkiyatMiktar |
                                            number:'1.0-0' }} L</div>
                                    </div>
                                    <div class="bg-white dark:bg-surface-800 p-3 text-center"
                                        [class.col-span-2]="tank.sevkiyatMiktar <= 0">
                                        <div class="text-[10px] uppercase tracking-wide text-red-600 mb-1">Satılan</div>
                                        <div class="font-bold text-sm text-red-600">-{{ tank.satilanMiktar |
                                            number:'1.0-0' }} L</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Empty State Mobile -->
                        <div *ngIf="tankEnvanter.length === 0"
                            class="text-center py-8 text-[var(--text-color-secondary)]">
                            <i class="pi pi-database text-4xl mb-2 opacity-50"></i>
                            <p class="text-sm">Tank envanter verisi bulunamadı</p>
                        </div>
                    </div>

                    <!-- DESKTOP VIEW: Original Card Grid -->
                    <div class="hidden md:grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-4">
                        <div *ngFor="let tank of tankEnvanter"
                            class="p-4 border rounded-lg bg-white dark:bg-surface-800 shadow-sm hover:shadow-md transition-shadow">
                            <div class="flex items-center justify-between mb-3">
                                <h4 class="font-bold text-lg text-[var(--text-color)]">
                                    Tank {{ tank.tankNo }} - {{ tank.tankAdi }}
                                </h4>
                                <p-tag [value]="tank.yakitTipi"
                                    [severity]="tank.yakitTipi === 'MOTORIN' ? 'info' : (tank.yakitTipi === 'BENZIN' ? 'success' : 'warning')">
                                </p-tag>
                            </div>

                            <div class="space-y-2 text-sm">
                                <div
                                    class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                    <span class="text-[var(--text-color-secondary)]">Başlangıç Stok:</span>
                                    <span class="font-bold text-[var(--text-color)]">{{ tank.baslangicStok |
                                        number:'1.0-0' }} L</span>
                                </div>

                                <div class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700"
                                    *ngIf="tank.sevkiyatMiktar > 0">
                                    <span class="text-[var(--text-color-secondary)]">Sevkiyat:</span>
                                    <span class="font-bold text-green-600">+{{ tank.sevkiyatMiktar | number:'1.0-0' }}
                                        L</span>
                                </div>

                                <div
                                    class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                    <span class="text-[var(--text-color-secondary)]">Satılan:</span>
                                    <span class="font-bold text-red-600">-{{ tank.satilanMiktar | number:'1.0-0' }}
                                        L</span>
                                </div>

                                <div
                                    class="flex justify-between items-center py-2 border-b border-gray-200 dark:border-gray-700">
                                    <span class="text-[var(--text-color-secondary)]">Bitiş Stok:</span>
                                    <span class="font-bold text-[var(--text-color)]">{{ tank.bitisStok | number:'1.0-0'
                                        }} L</span>
                                </div>

                                <!-- Fark Gösterimi -->
                                <div class="mt-3 p-3 rounded-lg" [ngClass]="{
                                    'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800': Math.abs(tank.farkMiktar) <= 20,
                                    'bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                    'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800': Math.abs(tank.farkMiktar) > 50
                                }">
                                    <div class="flex items-center justify-between mb-1">
                                        <span class="font-semibold text-sm" [ngClass]="{
                                            'text-green-700 dark:text-green-400': Math.abs(tank.farkMiktar) <= 20,
                                            'text-yellow-700 dark:text-yellow-400': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                            'text-red-700 dark:text-red-400': Math.abs(tank.farkMiktar) > 50
                                        }">
                                            <i class="pi" [ngClass]="{
                                                'pi-check-circle': Math.abs(tank.farkMiktar) <= 20,
                                                'pi-exclamation-triangle': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                                'pi-times-circle': Math.abs(tank.farkMiktar) > 50
                                            }"></i>
                                            {{ Math.abs(tank.farkMiktar) <= 20 ? 'Normal' : (Math.abs(tank.farkMiktar)
                                                <=50 ? 'Dikkat' : 'Uyarı' ) }} </span>
                                                <span class="font-bold text-lg" [ngClass]="{
                                            'text-green-700 dark:text-green-400': Math.abs(tank.farkMiktar) <= 20,
                                            'text-yellow-700 dark:text-yellow-400': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                            'text-red-700 dark:text-red-400': Math.abs(tank.farkMiktar) > 50
                                        }">
                                                    {{ tank.farkMiktar >= 0 ? '+' : '' }}{{ tank.farkMiktar |
                                                    number:'1.0-0' }} L
                                                </span>
                                    </div>
                                    <p class="text-xs" [ngClass]="{
                                        'text-green-600 dark:text-green-400': Math.abs(tank.farkMiktar) <= 20,
                                        'text-yellow-600 dark:text-yellow-400': Math.abs(tank.farkMiktar) > 20 && Math.abs(tank.farkMiktar) <= 50,
                                        'text-red-600 dark:text-red-400': Math.abs(tank.farkMiktar) > 50
                                    }">
                                        {{ Math.abs(tank.farkMiktar) <= 20 ? '✓ Tank ölçümleri doğru, kayıp/kaçak yok' :
                                            (Math.abs(tank.farkMiktar) <=50 ? '⚠ Küçük fark tespit edildi'
                                            : '⚠ Önemli fark! Kontrol gerekli' ) }} </p>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="tankEnvanter.length === 0"
                            class="col-span-full text-center py-8 text-[var(--text-color-secondary)]">
                            <i class="pi pi-info-circle text-4xl mb-2"></i>
                            <p>Bu vardiya için tank envanter verisi bulunamadı.</p>
                        </div>
                    </div>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>

    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-center md:justify-end w-full">
            <p-button label="Kapat" icon="pi pi-times" severity="danger" styleClass="px-6"
                (onClick)="detayVisible = false"></p-button>
        </div>
    </ng-template>
</p-dialog>