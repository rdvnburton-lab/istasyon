<div class="stok-page p-4">
    <p-toast></p-toast>

    <!-- Header & Filters -->
    <div class="card mb-6 p-6 rounded-2xl bg-white shadow-sm border border-gray-100">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 m-0 flex items-center gap-3">
                    <span class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                        <i class="pi pi-chart-pie text-blue-600 text-xl"></i>
                    </span>
                    YakÄ±t Stok YÃ¶netimi
                </h1>
                <p class="text-gray-500 mt-1 ml-13">GeliÅŸmiÅŸ vardiya stok analizi ve trendler</p>
            </div>

            <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-xl">
                <i class="pi pi-calendar text-gray-400 ml-2"></i>
                <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label" (onChange)="onDateChange()"
                    styleClass="w-36 border-0 bg-transparent shadow-none" [style]="{'box-shadow': 'none'}"></p-select>
                <div class="w-px h-6 bg-gray-300"></div>
                <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label" (onChange)="onDateChange()"
                    styleClass="w-32 border-0 bg-transparent shadow-none" [style]="{'box-shadow': 'none'}"></p-select>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center py-12">
        <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
    </div>

    <div *ngIf="!loading" class="animate-fade-in">

        <!-- DASHBOARD KPIS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Total Stock -->
            <div
                class="p-5 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-database text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-indigo-100 text-sm font-medium mb-1">Toplam AnlÄ±k Stok</div>
                    <div class="text-4xl font-bold mb-2">{{ totalCurrentStock | number:'1.0-0' }} <span
                            class="text-lg opacity-70">Lt</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-clock"></i> <span>Tank Verisi</span>
                    </div>
                </div>
            </div>

            <!-- Monthly Sales -->
            <div
                class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-shopping-cart text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-emerald-100 text-sm font-medium mb-1">AylÄ±k Toplam SatÄ±ÅŸ</div>
                    <div class="text-4xl font-bold mb-2">{{ totalMonthlySales | number:'1.0-0' }} <span
                            class="text-lg opacity-70">Lt</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-chart-line"></i> <span>{{ selectedMonth.label }} ayÄ±na ait</span>
                    </div>
                </div>
            </div>

            <!-- Days Remaining -->
            <div
                class="p-5 bg-gradient-to-br from-orange-500 to-pink-500 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-hourglass text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-orange-100 text-sm font-medium mb-1">Tahmini Stok Ã–mrÃ¼</div>
                    <div class="text-4xl font-bold mb-2">~{{ estimatedDaysLeft }} <span
                            class="text-lg opacity-70">GÃ¼n</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-calendar"></i> <span>Ort. SatÄ±ÅŸa GÃ¶re</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- TANK DETAILS LIST (Moved to top) -->
        <div *ngIf="xmlStokVerileri.length > 0" class="mb-6">
            <h2 class="text-lg font-bold text-gray-700 mb-4 px-1 flex items-center gap-2">
                <i class="pi pi-list text-gray-400"></i>
                DetaylÄ± Tank Durumu
            </h2>

            <div class="card p-6 bg-gray-50 border border-gray-200 rounded-2xl">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6">
                    <div *ngFor="let item of xmlStokVerileri"
                        class="p-5 rounded-2xl border-l-4 bg-white shadow-sm hover:shadow-md transition-all"
                        [style.border-left-color]="item.renk || '#666'">

                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-xl text-gray-800 m-0">{{ item.yakitTipi }}</h4>
                                <div *ngIf="item.tanimli === false" class="mt-1">
                                    <span
                                        class="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded-md border border-red-100 font-bold flex items-center gap-1 w-max">
                                        <i class="pi pi-exclamation-triangle"></i> TanÄ±msÄ±z ÃœrÃ¼n (Sisteme Ekleyin)
                                    </span>
                                </div>
                            </div>
                            <span
                                class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full font-medium flex items-center gap-1">
                                <i class="pi pi-history text-[10px]"></i> {{ item.kayitSayisi }} Vardiya
                            </span>
                        </div>

                        <div class="text-center py-6 bg-gray-50/50 rounded-xl mb-4 border border-gray-100">
                            <div class="text-xs text-gray-400 mb-1">Mevcut Stok</div>
                            <span class="text-4xl font-bold" [style.color]="item.renk || '#666'">
                                {{ item.sonStok > 0 ? (item.sonStok | number:'1.0-0') : '0' }}
                            </span>
                            <span *ngIf="item.sonStok > 0" class="text-gray-500 text-lg ml-1">Lt</span>
                        </div>

                        <!-- Tahmini GÃ¼n GÃ¶sterimi -->
                        <div class="text-center mb-4" *ngIf="item.tahminiGun !== undefined && item.sonStok > 0">
                            <span class="text-sm font-bold px-3 py-1.5 rounded-lg inline-flex items-center gap-1"
                                [class.bg-green-100]="item.tahminiGun > 7" [class.text-green-700]="item.tahminiGun > 7"
                                [class.bg-yellow-100]="item.tahminiGun <= 7 && item.tahminiGun > 3"
                                [class.text-yellow-700]="item.tahminiGun <= 7 && item.tahminiGun > 3"
                                [class.bg-red-100]="item.tahminiGun <= 3" [class.text-red-700]="item.tahminiGun <= 3">
                                <i class="pi pi-hourglass"></i>~ {{ item.tahminiGun }} GÃ¼n Yeter
                            </span>
                        </div>

                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="p-3 bg-green-50 rounded-xl">
                                <div class="text-green-600 text-[10px] mb-1 font-bold uppercase tracking-wide">YÃ¼kle
                                </div>
                                <div class="font-bold text-gray-800 text-sm">{{ item.toplamSevkiyat | number:'1.2-2' }}
                                </div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-xl">
                                <div class="text-red-500 text-[10px] mb-1 font-bold uppercase tracking-wide">Sat</div>
                                <div class="font-bold text-gray-800 text-sm">{{ item.toplamSatis | number:'1.2-2' }}
                                </div>
                            </div>
                            <div class="p-3 bg-gray-100 rounded-xl">
                                <div class="text-gray-500 text-[10px] mb-1 font-bold uppercase tracking-wide">Fark</div>
                                <div class="font-bold text-sm" [class.text-green-600]="item.toplamFark >= 0"
                                    [class.text-red-600]="item.toplamFark < 0">
                                    {{ item.toplamFark | number:'1.2-2' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ðŸ”¥ LIVE TANK LEVELS - MINIMAL SINGLE ROW -->
        <div *ngIf="latestShiftTanks.length > 0" class="mb-6">
            <!-- Title Outside Card -->
            <div class="flex items-center justify-between mb-3 px-1">
                <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2">
                    <span
                        class="w-7 h-7 rounded-lg bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
                        <i class="pi pi-database text-white text-xs"></i>
                    </span>
                    GÃ¼ncel Tank Seviyeleri
                </h2>
                <div class="flex items-center gap-1.5 text-[10px] text-gray-400">
                    <span class="relative flex h-1.5 w-1.5">
                        <span
                            class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-1.5 w-1.5 bg-green-500"></span>
                    </span>
                    Son GÃ¼ncelleme: {{ latestShiftDate | date:'dd.MM.yyyy' }}
                </div>
            </div>

            <!-- Tank Cards -->
            <div class="card p-4 bg-white rounded-xl border border-gray-100 shadow-sm">
                <div class="flex flex-wrap gap-3">
                    <div *ngFor="let tank of latestShiftTanks"
                        class="flex-1 min-w-[140px] max-w-[200px] p-3 rounded-xl border transition-all hover:shadow-md"
                        [style.border-color]="(tank.renk || '#6366f1') + '30'"
                        [style.background]="(tank.renk || '#6366f1') + '08'">

                        <!-- Header Row -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-1.5">
                                <span
                                    class="w-5 h-5 rounded text-[9px] font-bold flex items-center justify-center text-white"
                                    [style.background]="tank.renk || '#6366f1'">
                                    {{ tank.tankNo }}
                                </span>
                                <span class="text-xs font-bold text-gray-700 truncate">{{ tank.tankAdi || 'Tank'
                                    }}</span>
                            </div>
                            <span class="text-[9px] px-1.5 py-0.5 rounded font-medium"
                                [style.background]="(tank.renk || '#6366f1') + '20'"
                                [style.color]="tank.renk || '#6366f1'">
                                {{ tank.yakitTipi }}
                            </span>
                        </div>

                        <!-- Progress Bar -->
                        <div class="h-2 bg-gray-200 rounded-full overflow-hidden mb-2">
                            <div class="h-full rounded-full transition-all duration-500"
                                [style.width.%]="getTankFillPercentage(tank.bitisStok)"
                                [style.background]="'linear-gradient(90deg, ' + (tank.renk || '#6366f1') + ' 0%, ' + (tank.renk || '#6366f1') + 'CC 100%)'">
                            </div>
                        </div>

                        <!-- Value Row with Sevkiyat Indicator -->
                        <div class="flex items-center justify-between">
                            <div>
                                <span class="text-lg font-bold" [style.color]="tank.renk || '#6366f1'">
                                    {{ tank.bitisStok | number:'1.0-0' }}
                                </span>
                                <span class="text-[10px] text-gray-400 font-normal ml-1">Lt</span>
                            </div>
                            <!-- Stok GiriÅŸi Ä°ndikatÃ¶rÃ¼ -->
                            <span *ngIf="tank.sevkiyatMiktar > 0"
                                class="text-[9px] px-1.5 py-0.5 rounded bg-green-100 text-green-700 font-bold flex items-center gap-1">
                                <i class="pi pi-arrow-up text-[8px]"></i>
                                +{{ tank.sevkiyatMiktar | number:'1.0-0' }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div *ngIf="vardiyaHareketleri.length > 0" class="mb-8">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Stock Trend Chart -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-3 px-1 flex items-center gap-2">
                        <i class="pi pi-chart-line text-blue-500"></i> Stok Seviyesi DeÄŸiÅŸimi
                    </h3>
                    <div class="card p-4 bg-white rounded-2xl shadow-sm border border-gray-100 h-[320px]">
                        <p-chart type="line" [data]="stockTrendData" [options]="chartOptions" height="100%"></p-chart>
                    </div>
                </div>

                <!-- Daily Sales Chart -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-3 px-1 flex items-center gap-2">
                        <i class="pi pi-chart-bar text-green-500"></i> GÃ¼nlÃ¼k SatÄ±ÅŸ Hareketi
                    </h3>
                    <div class="card p-4 bg-white rounded-2xl shadow-sm border border-gray-100 h-[320px]">
                        <p-chart type="bar" [data]="dailySalesData" [options]="barChartOptions" height="100%"></p-chart>
                    </div>
                </div>
            </div>
        </div>



        <!-- SHIFT MOVEMENTS TABLE -->
        <div *ngIf="vardiyaHareketleri.length > 0" class="mt-8">
            <h2 class="text-lg font-bold text-gray-700 mb-4 px-1 flex items-center gap-2">
                <i class="pi pi-history text-gray-400"></i>
                Vardiya BazlÄ± Hareketler
            </h2>
            <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl overflow-hidden">
                <p-table [value]="vardiyaHareketleri" [rows]="10" [paginator]="true" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Tarih</th>
                            <th>Vardiya ID</th>
                            <th>Tank DetaylarÄ±</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-v>
                        <tr>
                            <td class="font-medium text-gray-600">{{ v.tarih | date:'dd.MM.yyyy HH:mm' }}</td>
                            <td><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">#{{
                                    v.vardiyaId }}</span></td>
                            <td>
                                <div class="flex flex-wrap gap-2">
                                    <div *ngFor="let t of v.tanklar"
                                        class="text-[10px] border px-2 py-1 rounded-lg flex items-center gap-2"
                                        [style.border-color]="t.renk + '40'" [style.background-color]="t.renk + '0A'">
                                        <span class="w-2 h-2 rounded-full" [style.background-color]="t.renk"></span>
                                        <span class="font-bold text-gray-700">{{ t.tankAdi }}:</span>
                                        <span class="text-gray-600">{{ t.satilanMiktar | number:'1.2-2' }} Lt
                                            SatÄ±ÅŸ</span>
                                        <span *ngIf="t.sevkiyatMiktar > 0" class="text-green-600 font-bold">+{{
                                            t.sevkiyatMiktar | number:'1.2-2' }} Lt</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>

        <div *ngIf="xmlStokVerileri.length === 0"
            class="card text-center py-12 mb-8 bg-gray-50 border-dashed border-2 border-gray-200 rounded-xl">
            <i class="pi pi-info-circle text-4xl mb-3 text-gray-300"></i>
            <p class="text-gray-500 m-0">Bu dÃ¶nem iÃ§in hesaplanmÄ±ÅŸ stok verisi bulunamadÄ±.</p>
        </div>
    </div>
</div>