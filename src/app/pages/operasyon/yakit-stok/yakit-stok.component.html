<div class="stok-page">
    <p-toast></p-toast>
    <p-confirmDialog></p-confirmDialog>

    <!--MOBILE NATIVE VIEW-->
    <div class="rapor-page block md:hidden">
        <!-- Mobile Native Header -->
        <div class="mobile-page-header">
            <div class="page-title-row">
                <div>
                    <h1 class="page-title">Yakıt Stok</h1>
                    <p class="page-subtitle">Stok takibi ve yakıt girişleri</p>
                </div>
            </div>
        </div>

        <!-- Segment Control -->
        <div class="segment-container">
            <div class="segment-control">
                <button *ngFor="let item of tabOptions" class="segment-btn" [class.active]="activeTab === item.value"
                    (click)="activeTab = item.value; onTabChange(null)">
                    <i [class]="item.icon"></i>
                    <span>{{ item.label }}</span>
                </button>
            </div>
        </div>

        <!-- CONTENT CONTAINER -->
        <div class="content-wrapper px-4 pb-4">
            <!-- TAB 0: ÖZET (Cards) -->
            <div *ngIf="activeTab === '0'" class="animate-fade-in space-y-4">
                <!-- Mobile Date Filter for Özet -->
                <div class="filter-container mb-4 bg-white p-3 rounded-xl border border-gray-100">
                    <div class="flex gap-2">
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Ay</div>
                            <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label"
                                (onChange)="loadData()" styleClass="w-full text-sm"
                                [style]="{'min-width': '140px'}"></p-select>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Yıl</div>
                            <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label"
                                (onChange)="loadData()" styleClass="w-full text-sm"
                                [style]="{'min-width': '100px'}"></p-select>
                        </div>
                    </div>
                </div>

                <!-- Aylık Stok Kartları - 3'lü yatay düzen -->
                <div *ngIf="aylikRapor.length > 0" class="grid grid-cols-1 gap-4">
                    <div *ngFor="let item of aylikRapor"
                        class="stok-card bg-white rounded-xl shadow-sm border-l-4 overflow-hidden"
                        [style.border-left-color]="item.renk || '#666'">
                        <div class="p-4">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <div class="text-lg font-bold text-gray-800">{{ item.yakitAdi }}</div>
                                    <div class="text-xs text-gray-400">{{ selectedMonth.label }} {{ selectedYear.label
                                        }}</div>
                                </div>
                                <span *ngIf="item.kilitli"
                                    class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">
                                    <i class="pi pi-lock text-xs"></i>
                                </span>
                            </div>

                            <!-- Ana Stok Değeri -->
                            <div class="text-center py-4 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl mb-3">
                                <span class="text-3xl font-bold" [style.color]="item.renk || '#333'">
                                    {{ item.kalanStok | number:'1.0-0' }}
                                </span>
                                <span class="text-gray-500 text-sm ml-1">Litre</span>
                            </div>

                            <!-- Detaylı Bilgiler -->
                            <div class="grid grid-cols-3 gap-2 text-center text-sm">
                                <div class="p-2 bg-gray-50 rounded-lg">
                                    <div class="text-gray-400 text-xs">Devir</div>
                                    <div class="font-semibold text-gray-700">{{ item.devirStok | number:'1.0-0' }}</div>
                                </div>
                                <div class="p-2 bg-green-50 rounded-lg">
                                    <div class="text-green-500 text-xs">Giriş</div>
                                    <div class="font-semibold text-green-600">+{{ item.ayGiris | number:'1.0-0' }}</div>
                                </div>
                                <div class="p-2 bg-red-50 rounded-lg">
                                    <div class="text-red-400 text-xs">Satış</div>
                                    <div class="font-semibold text-red-600">-{{ item.aySatis | number:'1.0-0' }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div *ngIf="aylikRapor.length === 0 && !loading" class="empty-state text-center py-8">
                    <i class="pi pi-info-circle text-2xl mb-2 text-gray-400"></i>
                    <p class="text-gray-500">Bu dönem için stok verisi bulunamadı.</p>
                </div>

                <!-- XML Kaynaklı Stok Özeti (Motorin/Benzin) -->
                <div *ngIf="xmlStokVerileri.length > 0" class="mt-4">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="pi pi-database text-blue-600"></i>
                        <span class="font-bold text-gray-700">Vardiya Verileri (Otomatik)</span>
                    </div>
                    <div class="grid grid-cols-1 gap-3">
                        <div *ngFor="let item of xmlStokVerileri"
                            class="p-4 rounded-xl border-l-4 bg-gradient-to-r from-blue-50 to-indigo-50"
                            [class.border-blue-500]="item.yakitTipi === 'MOTORIN'"
                            [class.border-green-500]="item.yakitTipi === 'BENZIN'">
                            <div class="flex justify-between items-center mb-2">
                                <span class="font-bold text-gray-800">{{ item.yakitTipi }}</span>
                                <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full">
                                    {{ item.kayitSayisi }} Vardiya
                                </span>
                            </div>
                            <div class="text-center py-3 bg-white rounded-lg mb-2">
                                <span class="text-2xl font-bold" [class.text-blue-600]="item.yakitTipi === 'MOTORIN'"
                                    [class.text-green-600]="item.yakitTipi === 'BENZIN'">
                                    {{ item.sonStok | number:'1.0-0' }}
                                </span>
                                <span class="text-gray-500 text-sm ml-1">Litre</span>
                            </div>
                            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                                <div class="p-2 bg-white rounded-lg">
                                    <div class="text-gray-400">Sevkiyat</div>
                                    <div class="font-bold text-green-600">+{{ item.toplamSevkiyat | number:'1.0-0' }}
                                    </div>
                                </div>
                                <div class="p-2 bg-white rounded-lg">
                                    <div class="text-gray-400">Satış</div>
                                    <div class="font-bold text-red-600">-{{ item.toplamSatis | number:'1.0-0' }}</div>
                                </div>
                                <div class="p-2 bg-white rounded-lg">
                                    <div class="text-gray-400">Fark</div>
                                    <div class="font-bold" [class.text-green-600]="item.toplamFark >= 0"
                                        [class.text-red-600]="item.toplamFark < 0">
                                        {{ item.toplamFark | number:'1.0-0' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Fatura Stok Durumu (FIFO) Paneli -->
                <div *ngIf="faturaStokDurumu.length > 0"
                    class="mt-4 p-4 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-xl border border-purple-200">
                    <div class="flex items-center gap-2 mb-3">
                        <i class="pi pi-file text-purple-600"></i>
                        <span class="font-bold text-purple-800">Fatura Stok Durumu (FIFO)</span>
                    </div>

                    <div class="space-y-2 max-h-60 overflow-y-auto">
                        <div *ngFor="let f of faturaStokDurumu"
                            class="p-2 bg-white rounded-lg border shadow-sm flex justify-between items-center"
                            [class.opacity-50]="f.tamamlandi">
                            <div>
                                <div class="font-medium text-gray-800">{{ f.faturaNo }}</div>
                                <div class="text-xs text-gray-500">{{ f.yakitAdi }} • {{ f.faturaTarihi |
                                    date:'dd/MM/yyyy' }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-sm">
                                    <span class="text-gray-500">{{ f.kalanMiktar | number:'1.0-0' }}</span>
                                    <span class="text-gray-400">/</span>
                                    <span class="font-medium">{{ f.girenMiktar | number:'1.0-0' }}</span>
                                    <span class="text-gray-500"> Lt</span>
                                </div>
                                <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="h-full bg-purple-500 rounded-full" [style.width.%]="f.tuketimYuzdesi">
                                    </div>
                                </div>
                            </div>
                            <i *ngIf="f.tamamlandi" class="pi pi-check-circle text-green-500 ml-2"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB 1: GEÇMİŞ (Date & List) -->
            <div *ngIf="activeTab === '1'" class="animate-fade-in">
                <!-- Mobile Date Filter -->
                <div class="filter-container mb-4 bg-white p-3 rounded-xl border border-gray-100">
                    <div class="flex gap-2 mb-2">
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Ay</div>
                            <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label"
                                (onChange)="onDateChange()" styleClass="w-full text-sm"
                                [style]="{'min-width': '140px'}"></p-select>
                        </div>
                        <div class="flex-1">
                            <div class="text-xs text-gray-500 mb-1">Yıl</div>
                            <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label"
                                (onChange)="onDateChange()" styleClass="w-full text-sm"
                                [style]="{'min-width': '100px'}"></p-select>
                        </div>
                    </div>
                </div>

                <div class="vardiya-list space-y-3">
                    <ng-container *ngFor="let fis of girisler">
                        <!-- Invoice Card (Similar to Shift Card) -->
                        <div class="vardiya-card bg-white border border-gray-200 rounded-xl overflow-hidden">
                            <div class="p-3 bg-gray-50 flex justify-between items-center border-b border-gray-100"
                                (click)="toggleRow(fis.faturaNo)">
                                <div class="flex flex-col">
                                    <span class="font-bold text-gray-800">{{ fis.faturaNo }}</span>
                                    <span class="text-xs text-gray-500">{{ fis.tarih | date:'dd.MM.yyyy HH:mm' }}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="font-bold text-gray-900">{{ fis.toplamTutar |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                    <!-- Mobile Actions (Stop Propagation required) -->
                                    <div class="flex gap-1" (click)="$event.stopPropagation()">
                                        <button pButton icon="pi pi-pencil"
                                            class="p-button-rounded p-button-text p-button-info p-button-sm"
                                            (click)="editFatura(fis)"></button>
                                        <button pButton icon="pi pi-trash"
                                            class="p-button-rounded p-button-text p-button-danger p-button-sm"
                                            (click)="deleteFatura(fis.faturaNo)"></button>
                                    </div>
                                    <i [class]="expandedRows[fis.faturaNo] ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                                        class="text-gray-400"></i>
                                </div>
                            </div>

                            <!-- Additional Info (If present) -->
                            <div *ngIf="fis.gelisYontemi || fis.plaka || fis.urunGirisTarihi"
                                class="mx-3 mb-2 p-2 bg-blue-50/50 rounded-lg border border-dashed border-blue-100 text-[10px]">
                                <div class="flex flex-wrap gap-x-3 gap-y-1">
                                    <div *ngIf="fis.gelisYontemi" class="flex items-center gap-1">
                                        <span class="text-gray-400">Yöntem:</span>
                                        <span class="font-medium text-gray-700">{{ fis.gelisYontemi }}</span>
                                    </div>
                                    <div *ngIf="fis.plaka" class="flex items-center gap-1">
                                        <span class="text-gray-400">Plaka:</span>
                                        <span class="font-medium text-gray-700">{{ fis.plaka }}</span>
                                    </div>
                                    <div *ngIf="fis.urunGirisTarihi" class="flex items-center gap-1">
                                        <span class="text-gray-400">Ürün Giriş:</span>
                                        <span class="font-medium text-gray-700">{{ fis.urunGirisTarihi |
                                            date:'dd.MM.yyyy HH:mm' }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Items List (Details) -->
                            <div *ngIf="expandedRows[fis.faturaNo]" class="p-3 space-y-2 bg-white animate-fade-in">
                                <div *ngFor="let item of fis.kalemler"
                                    class="flex justify-between items-center py-2 border-b border-gray-50 last:border-0">
                                    <div class="flex flex-col">
                                        <span class="font-medium text-sm text-gray-700">{{ item.yakitAd }}</span>
                                        <span class="text-xs text-gray-500">{{ item.litre | number }} Lt x {{
                                            item.birimFiyat | currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-semibold text-gray-800">{{ item.toplamTutar |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </ng-container>

                    <div *ngIf="girisler.length === 0" class="no-entries text-center py-6 text-gray-500">
                        Bu ay için fatura kaydı bulunamadı.
                    </div>
                </div>
            </div>

            <!-- TAB 2: EKLE (Form) -->
            <div *ngIf="activeTab === '2'" class="animate-fade-in">
                <div class="card p-4 rounded-2xl bg-white border border-gray-100 shadow-sm">
                    <div class="space-y-4">
                        <!-- Invoice Header -->
                        <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                            <div class="mb-2">
                                <span class="font-bold text-sm text-gray-700">Yeni Fatura</span>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1">Tarih</label>
                                    <p-datepicker [(ngModel)]="yeniFatura.tarih" dateFormat="dd.mm.yy"
                                        [showIcon]="false" [showTime]="true" hourFormat="24" appendTo="body"
                                        styleClass="w-full p-inputtext-sm"></p-datepicker>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1">Fatura No</label>
                                    <input pInputText [(ngModel)]="yeniFatura.faturaNo" class="w-full p-inputtext-sm"
                                        placeholder="Fatura No" />
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1">Geliş
                                        Yöntemi</label>
                                    <p-select [options]="gelisYontemleri" [(ngModel)]="yeniFatura.gelisYontemi"
                                        placeholder="Seçin" styleClass="w-full p-inputtext-sm"
                                        appendTo="body"></p-select>
                                </div>
                                <div>
                                    <label class="block text-xs font-semibold text-gray-500 mb-1">Araç Plaka</label>
                                    <input pInputText [(ngModel)]="yeniFatura.plaka" class="w-full p-inputtext-sm"
                                        placeholder="34 ABC 123" />
                                </div>
                            </div>

                            <div class="mb-1">
                                <label class="block text-xs font-semibold text-gray-500 mb-1">Ürün Giriş
                                    Tarihi</label>
                                <p-datepicker [(ngModel)]="yeniFatura.urunGirisTarihi" dateFormat="dd.mm.yy"
                                    [showIcon]="false" [showTime]="true" hourFormat="24" appendTo="body"
                                    placeholder="Opsiyonel" styleClass="w-full p-inputtext-sm"></p-datepicker>
                            </div>
                        </div>

                        <!-- Items -->
                        <div class="space-y-3">
                            <label class="block text-sm font-bold text-gray-700">Yakıt Kalemleri</label>

                            <div *ngFor="let item of yeniFatura.kalemler; let i = index"
                                class="p-3 border border-blue-100 rounded-xl relative bg-blue-50/30">
                                <button *ngIf="yeniFatura.kalemler.length > 1" (click)="removeItem(i)"
                                    class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-6 h-6 flex items-center justify-center shadow-sm">
                                    <i class="pi pi-times text-xs"></i>
                                </button>

                                <div class="grid grid-cols-1 gap-3">
                                    <div class="field">
                                        <p-select [options]="yakitList" [(ngModel)]="item.yakitId" optionLabel="ad"
                                            optionValue="id" placeholder="Yakıt Seçin" styleClass="w-full"
                                            appendTo="body"></p-select>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="field">
                                            <label class="text-xs text-gray-500 block mb-1">Miktar (Lt)</label>
                                            <p-inputNumber [(ngModel)]="item.litre" mode="decimal"
                                                [minFractionDigits]="2" [maxFractionDigits]="2" [min]="0"
                                                (onInput)="calculateItemTotal(item)" styleClass="w-full"
                                                inputStyleClass="w-full" locale="tr-TR"
                                                placeholder="0,00"></p-inputNumber>
                                        </div>
                                        <div class="field">
                                            <label class="text-xs text-gray-500 block mb-1">Birim Fiyat</label>
                                            <p-inputNumber [(ngModel)]="item.birimFiyat" mode="currency" currency="TRY"
                                                locale="tr-TR" [minFractionDigits]="2"
                                                (onInput)="calculateItemTotal(item)" styleClass="w-full"
                                                inputStyleClass="w-full" placeholder="0,00 ₺"></p-inputNumber>
                                        </div>
                                    </div>
                                    <div class="flex justify-between items-center pt-2 border-t border-blue-100">
                                        <span class="text-xs text-gray-500">Ara Toplam</span>
                                        <span class="font-bold text-gray-900">{{ item.toplamTutar |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                    </div>
                                </div>
                            </div>

                            <button pButton label="Yeni Kalem Ekle" icon="pi pi-plus"
                                class="p-button-outlined p-button-sm w-full" (click)="addItem()"></button>
                        </div>

                        <!-- Footer -->
                        <div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center mt-4">
                            <span class="font-semibold text-blue-900">Genel Toplam</span>
                            <span class="text-xl font-bold text-blue-700">
                                {{ invoiceTotal | currency:'TRY':'symbol-narrow':'1.2-2':'tr-TR' }}
                            </span>
                        </div>
                        <div class="flex gap-2 pt-2">
                            <button pButton [label]="editingFaturaNo ? 'Güncelle' : 'Faturayı Kaydet'"
                                class="p-button-primary w-full" (click)="saveGiris()" [loading]="loading"></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DESKTOP VIEW -->
    <div class="grid grid-cols-12 gap-6 hidden md:grid">
        <!-- Header Card -->
        <div class="col-span-12">
            <div class="card">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-[var(--text-color)] m-0">
                            <i class="pi pi-server mr-2 text-blue-500"></i>Yakıt Stok Yönetimi
                        </h2>
                        <p class="text-[var(--text-color-secondary)] mt-2">
                            Stok durumu takibi ve yeni yakıt girişi
                        </p>
                    </div>
                    <div>
                        <p-selectButton [options]="tabOptions" [(ngModel)]="activeTab" optionLabel="label"
                            optionValue="value" (onChange)="onTabChange($event)">
                            <ng-template let-item pTemplate="item">
                                <div class="flex items-center gap-2 px-2">
                                    <i [class]="item.icon"></i>
                                    <span>{{item.label}}</span>
                                </div>
                            </ng-template>
                        </p-selectButton>
                    </div>
                </div>
            </div>
        </div>

        <!-- Desktop Content - Özet -->
        <div *ngIf="activeTab === '0'" class="col-span-12">
            <!-- Desktop Date Filter for Özet -->
            <div class="card mb-6">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <i class="pi pi-calendar text-blue-500"></i>
                        <span class="font-semibold text-[var(--text-color)]">Dönem Seçimi</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label"
                            (onChange)="loadData()" styleClass="w-40" [style]="{'min-width': '160px'}"></p-select>
                        <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label"
                            (onChange)="loadData()" styleClass="w-28" [style]="{'min-width': '100px'}"></p-select>
                    </div>
                </div>
            </div>

            <!-- Desktop Aylık Stok Kartları - 3 sütun -->
            <div *ngIf="aylikRapor.length > 0" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div *ngFor="let item of aylikRapor"
                    class="card mb-0 h-full p-0 overflow-hidden border-l-4 hover:shadow-lg transition-shadow"
                    [style.border-left-color]="item.renk || '#666'">
                    <div class="p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="text-xl font-bold text-gray-800 m-0">{{ item.yakitAdi }}</h3>
                                <p class="text-xs text-gray-400 m-0">{{ selectedMonth.label }} {{ selectedYear.label }}
                                </p>
                            </div>
                            <span *ngIf="item.kilitli"
                                class="text-xs bg-orange-100 text-orange-600 px-2 py-1 rounded-full">
                                <i class="pi pi-lock text-xs mr-1"></i>Kilitli
                            </span>
                        </div>

                        <!-- Ana Stok Değeri -->
                        <div class="text-center py-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-2xl mb-4">
                            <span class="text-4xl font-bold" [style.color]="item.renk || '#333'">
                                {{ item.kalanStok | number:'1.0-0' }}
                            </span>
                            <span class="text-gray-500 text-lg ml-1">Lt</span>
                        </div>

                        <!-- Detaylı Bilgiler -->
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <div class="text-gray-400 text-xs mb-1">Devir</div>
                                <div class="font-bold text-gray-700">{{ item.devirStok | number:'1.0-0' }}</div>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl">
                                <div class="text-green-500 text-xs mb-1">Giriş</div>
                                <div class="font-bold text-green-600">+{{ item.ayGiris | number:'1.0-0' }}</div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-xl">
                                <div class="text-red-400 text-xs mb-1">Satış</div>
                                <div class="font-bold text-red-600">-{{ item.aySatis | number:'1.0-0' }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div *ngIf="aylikRapor.length === 0 && !loading" class="card text-center py-12">
                <i class="pi pi-info-circle text-4xl mb-3 text-gray-300"></i>
                <p class="text-gray-500 m-0">Bu dönem için stok verisi bulunamadı.</p>
            </div>

            <!-- Desktop XML Kaynaklı Stok Özeti (Motorin/Benzin) -->
            <div *ngIf="xmlStokVerileri.length > 0"
                class="mt-6 card p-6 bg-gradient-to-br from-blue-50/50 to-indigo-50/50 border border-blue-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-blue-200">
                    <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center">
                        <i class="pi pi-database text-blue-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-blue-900 m-0">Vardiya Tank Verileri (Otomatik)</h3>
                        <p class="text-blue-700 text-sm m-0">XML dosyalarından gelen anlık stok durumu</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div *ngFor="let item of xmlStokVerileri" class="p-5 rounded-2xl border-l-4 bg-white shadow-sm"
                        [class.border-blue-500]="item.yakitTipi === 'MOTORIN'"
                        [class.border-green-500]="item.yakitTipi === 'BENZIN'">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="font-bold text-xl text-gray-800 m-0">{{ item.yakitTipi }}</h4>
                            <span class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded-full">
                                {{ item.kayitSayisi }} Vardiya
                            </span>
                        </div>
                        <div class="text-center py-6 bg-gradient-to-br from-gray-50 to-gray-100 rounded-xl mb-4">
                            <span class="text-4xl font-bold" [class.text-blue-600]="item.yakitTipi === 'MOTORIN'"
                                [class.text-green-600]="item.yakitTipi === 'BENZIN'">
                                {{ item.sonStok | number:'1.0-0' }}
                            </span>
                            <span class="text-gray-500 text-lg ml-1">Litre</span>
                        </div>
                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="p-3 bg-green-50 rounded-xl">
                                <div class="text-green-500 text-xs mb-1">Sevkiyat</div>
                                <div class="font-bold text-green-600">+{{ item.toplamSevkiyat | number:'1.0-0' }}</div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-xl">
                                <div class="text-red-400 text-xs mb-1">Satış</div>
                                <div class="font-bold text-red-600">-{{ item.toplamSatis | number:'1.0-0' }}</div>
                            </div>
                            <div class="p-3 bg-gray-50 rounded-xl">
                                <div class="text-gray-400 text-xs mb-1">Fark</div>
                                <div class="font-bold" [class.text-green-600]="item.toplamFark >= 0"
                                    [class.text-red-600]="item.toplamFark < 0">
                                    {{ item.toplamFark | number:'1.0-0' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Desktop Fatura Stok Durumu (FIFO) Paneli -->
            <div *ngIf="faturaStokDurumu.length > 0"
                class="mt-6 card p-6 bg-gradient-to-br from-purple-50/50 to-indigo-50/50 border border-purple-200">
                <div class="flex items-center gap-3 mb-4 pb-3 border-b border-purple-200">
                    <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center">
                        <i class="pi pi-file text-purple-600 text-xl"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-purple-900 m-0">Fatura Stok Durumu (FIFO)</h3>
                        <p class="text-purple-700 text-sm m-0">Hangi faturadan ne kadar stok kaldı</p>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr class="bg-purple-50 text-purple-800">
                                <th class="text-left p-3 rounded-tl-lg">Fatura No</th>
                                <th class="text-left p-3">Yakıt</th>
                                <th class="text-left p-3">Tarih</th>
                                <th class="text-right p-3">Giren</th>
                                <th class="text-right p-3">Kalan</th>
                                <th class="text-center p-3 rounded-tr-lg">Durum</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let f of faturaStokDurumu" class="border-b border-gray-100 hover:bg-gray-50"
                                [class.opacity-50]="f.tamamlandi">
                                <td class="p-3 font-medium">{{ f.faturaNo }}</td>
                                <td class="p-3">{{ f.yakitAdi }}</td>
                                <td class="p-3 text-gray-500">{{ f.faturaTarihi | date:'dd/MM/yyyy' }}</td>
                                <td class="p-3 text-right">{{ f.girenMiktar | number:'1.0-0' }} Lt</td>
                                <td class="p-3 text-right font-bold" [class.text-green-600]="f.kalanMiktar > 0"
                                    [class.text-gray-400]="f.kalanMiktar <= 0">
                                    {{ f.kalanMiktar | number:'1.0-0' }} Lt
                                </td>
                                <td class="p-3 text-center">
                                    <div class="inline-flex items-center gap-2">
                                        <div class="w-20 h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="h-full bg-purple-500 rounded-full transition-all"
                                                [style.width.%]="f.tuketimYuzdesi"></div>
                                        </div>
                                        <span *ngIf="f.tamamlandi" class="text-green-500">
                                            <i class="pi pi-check-circle"></i>
                                        </span>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Desktop Content - Geçmiş -->
        <div *ngIf="activeTab === '1'" class="col-span-12">
            <div class="card">
                <!-- Filter Header -->
                <div
                    class="flex flex-col xl:flex-row justify-between items-start gap-4 mb-6 pb-4 border-b border-gray-100">
                    <div class="flex flex-wrap items-center gap-3">
                        <!-- Filter Type Selector -->
                        <p-selectButton [options]="filterOptions" [(ngModel)]="filterType" optionLabel="label"
                            optionValue="value" (onChange)="onFilterTypeChange()"></p-selectButton>

                        <!-- Month/Year Filters -->
                        <ng-container *ngIf="filterType === 'MONTH'">
                            <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label"
                                (onChange)="onDateChange()" styleClass="w-40"
                                [style]="{'min-width': '160px'}"></p-select>
                            <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label"
                                (onChange)="onDateChange()" styleClass="w-28"
                                [style]="{'min-width': '100px'}"></p-select>
                        </ng-container>

                        <!-- Year Filter -->
                        <ng-container *ngIf="filterType === 'YEAR'">
                            <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label"
                                (onChange)="onDateChange()" styleClass="w-28"
                                [style]="{'min-width': '100px'}"></p-select>
                        </ng-container>

                        <!-- Range Filter -->
                        <ng-container *ngIf="filterType === 'RANGE'">
                            <p-datepicker [(ngModel)]="rangeDates" selectionMode="range" [readonlyInput]="true"
                                placeholder="Tarih Aralığı Seçin" (ngModelChange)="onDateChange()" [showIcon]="true"
                                appendTo="body"></p-datepicker>
                        </ng-container>
                    </div>

                    <!-- Totals Display -->
                    <div class="flex gap-4 bg-blue-50 px-4 py-2 rounded-xl border border-blue-100 whitespace-nowrap">
                        <div class="text-right">
                            <div class="text-xs text-blue-600 font-semibold uppercase tracking-wider">Toplam Litre
                            </div>
                            <div class="text-lg font-bold text-gray-800">{{ listTotalLitre | number }} Lt</div>
                        </div>
                        <div class="w-px bg-blue-200"></div>
                        <div class="text-right">
                            <div class="text-xs text-blue-600 font-semibold uppercase tracking-wider">Toplam Tutar
                            </div>
                            <div class="text-lg font-bold text-gray-800">{{ listTotalTutar |
                                currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                        </div>
                    </div>
                </div>

                <!-- Cards Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4">
                    <div *ngFor="let fis of girisler"
                        class="border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow bg-white relative">
                        <!-- Card Header -->
                        <div class="flex justify-between items-start mb-3 pb-3 border-b border-gray-100">
                            <div>
                                <div class="text-xs text-gray-500 mb-1">Fatura No</div>
                                <div class="font-bold text-lg text-gray-800">{{ fis.faturaNo }}</div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-500 mb-1">Tarih</div>
                                <div class="font-medium text-gray-700">{{ fis.tarih | date:'dd.MM.yyyy HH:mm' }}
                                </div>
                            </div>
                        </div>

                        <!-- Main Stats -->
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div class="bg-gray-50 p-2 rounded-lg text-center">
                                <div class="text-xs text-gray-500">Tutar</div>
                                <div class="font-bold text-blue-600">{{ fis.toplamTutar |
                                    currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
                            </div>
                            <div class="bg-gray-50 p-2 rounded-lg text-center">
                                <div class="text-xs text-gray-500">Miktar</div>
                                <div class="font-bold text-gray-700">{{ fis.toplamLitre | number }} Lt</div>
                            </div>
                        </div>

                        <!-- Additional Info (If present) -->
                        <div *ngIf="fis.gelisYontemi || fis.plaka || fis.urunGirisTarihi"
                            class="mb-4 p-2 bg-gray-50 rounded-lg border border-dashed border-gray-200 text-xs">
                            <div class="flex flex-wrap gap-x-4 gap-y-1">
                                <div *ngIf="fis.gelisYontemi" class="flex items-center gap-1">
                                    <span class="text-gray-400">Yöntem:</span>
                                    <span class="font-medium text-gray-700">{{ fis.gelisYontemi }}</span>
                                </div>
                                <div *ngIf="fis.plaka" class="flex items-center gap-1">
                                    <span class="text-gray-400">Plaka:</span>
                                    <span class="font-medium text-gray-700">{{ fis.plaka }}</span>
                                </div>
                                <div *ngIf="fis.urunGirisTarihi" class="flex items-center gap-1">
                                    <span class="text-gray-400">Ürün Giriş:</span>
                                    <span class="font-medium text-gray-700">{{ fis.urunGirisTarihi |
                                        date:'dd.MM.yyyy
                                        HH:mm' }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Items List -->
                        <div class="space-y-2 mb-4">
                            <div *ngFor="let item of fis.kalemler" class="flex justify-between items-center text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-3 h-3 rounded-full border border-gray-200 shadow-sm"
                                        [style.background-color]="item.yakitRenk"></div>
                                    <span class="text-gray-700 font-medium">{{ item.yakitAd }}</span>
                                </div>
                                <div class="flex items-center gap-3">
                                    <div
                                        class="bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm font-mono text-gray-800">
                                        {{ item.litre | number }} <span class="text-gray-400 text-xs ml-1">Lt</span>
                                    </div>
                                    <span class="text-gray-400 text-xs">x {{ item.birimFiyat | number:'1.2-2'
                                        }}</span>
                                </div>
                            </div>
                        </div>

                        <!-- Footer / Actions -->
                        <div class="flex justify-between items-center pt-2 border-t border-gray-100">
                            <div class="text-xs text-gray-400">
                                <i class="pi pi-user mr-1"></i>{{ fis.kaydeden }}
                            </div>
                            <div class="flex gap-1">
                                <button pButton icon="pi pi-pencil"
                                    class="p-button-text p-button-rounded p-button-info p-button-sm"
                                    (click)="editFatura(fis)"></button>
                                <button pButton icon="pi pi-trash"
                                    class="p-button-text p-button-rounded p-button-danger p-button-sm"
                                    (click)="deleteFatura(fis.faturaNo)"></button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Empty State -->
                <div *ngIf="girisler.length === 0 && !loading" class="text-center py-12 text-gray-400"
                    class="empty-state">
                    <i class="pi pi-inbox text-4xl mb-3"></i>
                    <p>Kayıt bulunamadı.</p>
                </div>
            </div>
        </div>

        <!-- Desktop Content - Ekle -->
        <div *ngIf="activeTab === '2'" class="col-span-12 lg:col-span-6 lg:col-start-4">
            <div class="card p-6">
                <!-- Desktop Form -->
                <div class="mb-6 pb-4 border-b border-gray-100">
                    <span class="font-bold text-lg">Yeni Fatura Girişi</span>
                </div>

                <div class="flex gap-4 mb-3">
                    <div class="flex-1">
                        <label class="block font-bold mb-2">Tarih</label>
                        <p-datepicker [(ngModel)]="yeniFatura.tarih" dateFormat="dd.mm.yy" [showIcon]="true"
                            [showTime]="true" hourFormat="24" styleClass="w-full"></p-datepicker>
                    </div>
                    <div class="flex-1">
                        <label class="block font-bold mb-2">Fatura No</label>
                        <input pInputText [(ngModel)]="yeniFatura.faturaNo" class="w-full" />
                    </div>
                </div>

                <div class="flex gap-4 mb-6">
                    <div class="flex-1">
                        <label class="block font-bold mb-2">Geliş Yöntemi</label>
                        <p-select [options]="gelisYontemleri" [(ngModel)]="yeniFatura.gelisYontemi" placeholder="Seçin"
                            styleClass="w-full"></p-select>
                    </div>
                    <div class="flex-1">
                        <label class="block font-bold mb-2">Araç Plaka</label>
                        <input pInputText [(ngModel)]="yeniFatura.plaka" class="w-full" placeholder="34 ABC 123" />
                    </div>
                    <div class="flex-1">
                        <label class="block font-bold mb-2">Ürün Giriş Tarihi</label>
                        <p-datepicker [(ngModel)]="yeniFatura.urunGirisTarihi" dateFormat="dd.mm.yy" [showIcon]="true"
                            [showTime]="true" hourFormat="24" styleClass="w-full"
                            placeholder="Opsiyonel"></p-datepicker>
                    </div>
                </div>

                <div *ngFor="let item of yeniFatura.kalemler; let i = index"
                    class="mb-4 p-4 bg-gray-50 rounded-xl border border-gray-200">
                    <div class="flex justify-between mb-2">
                        <span class="font-bold text-gray-700">Kalem #{{i+1}}</span>
                        <button *ngIf="yeniFatura.kalemler.length > 1" pButton icon="pi pi-times"
                            class="p-button-danger p-button-text p-button-sm" (click)="removeItem(i)"></button>
                    </div>
                    <div class="grid grid-cols-12 gap-3">
                        <div class="col-span-12 md:col-span-4">
                            <label class="block text-sm font-semibold mb-1">Yakıt</label>
                            <p-select [options]="yakitList" [(ngModel)]="item.yakitId" optionLabel="ad" optionValue="id"
                                styleClass="w-full" appendTo="body"></p-select>
                        </div>
                        <div class="col-span-6 md:col-span-4">
                            <label class="block text-sm font-semibold mb-1">Miktar</label>
                            <p-inputNumber [(ngModel)]="item.litre" (onInput)="calculateItemTotal(item)"
                                styleClass="w-full" inputStyleClass="w-full" mode="decimal" [minFractionDigits]="2"
                                [maxFractionDigits]="2" [min]="0" locale="tr-TR" placeholder="0,00"></p-inputNumber>
                        </div>
                        <div class="col-span-6 md:col-span-4">
                            <label class="block text-sm font-semibold mb-1">Birim Fiyat</label>
                            <p-inputNumber [(ngModel)]="item.birimFiyat" mode="currency" currency="TRY"
                                (onInput)="calculateItemTotal(item)" styleClass="w-full" inputStyleClass="w-full"
                                locale="tr-TR" [minFractionDigits]="2" placeholder="0,00 ₺"></p-inputNumber>
                        </div>
                    </div>
                </div>

                <div class="flex justify-center my-4">
                    <button pButton label="Yeni Kalem Ekle" icon="pi pi-plus" class="p-button-outlined"
                        (click)="addItem()"></button>
                </div>

                <div class="bg-blue-50 p-4 rounded-xl flex justify-between items-center mb-4">
                    <span class="font-bold text-blue-900">Genel Toplam</span>
                    <span class="text-2xl font-bold text-blue-700">{{ invoiceTotal |
                        currency:'TRY':'symbol-narrow':'1.2-2'
                        }}</span>
                </div>

                <button pButton label="Faturayı Kaydet" class="w-full p-button-lg" (click)="saveGiris()"
                    [loading]="loading"></button>
            </div>
        </div>
    </div>

    <!-- Edit Dialog -->
    <p-dialog [(visible)]="displayEditModal" [header]="'Fatura Düzenle: ' + editingFaturaNo" [modal]="true"
        [style]="{width: '90vw', maxWidth: '800px'}" [draggable]="false" [resizable]="false" appendTo="body"
        (onHide)="resetForm()">

        <div class="p-4 pt-0">
            <!-- Date / Fatura No row -->
            <div class="flex flex-wrap gap-4 mb-4">
                <div class="flex-1 min-w-[200px]">
                    <label class="block font-bold mb-2">Tarih</label>
                    <p-datepicker [(ngModel)]="yeniFatura.tarih" dateFormat="dd.mm.yy" [showIcon]="true"
                        [showTime]="true" hourFormat="24" styleClass="w-full"></p-datepicker>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block font-bold mb-2">Fatura No</label>
                    <input pInputText [(ngModel)]="yeniFatura.faturaNo" class="w-full" />
                </div>
            </div>

            <!-- Optional fields row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="flex-1">
                    <label class="block font-bold mb-2">Geliş Yöntemi</label>
                    <p-select [options]="gelisYontemleri" [(ngModel)]="yeniFatura.gelisYontemi" placeholder="Seçin"
                        styleClass="w-full"></p-select>
                </div>
                <div class="flex-1">
                    <label class="block font-bold mb-2">Araç Plaka</label>
                    <input pInputText [(ngModel)]="yeniFatura.plaka" class="w-full" placeholder="34 ABC 123" />
                </div>
                <div class="flex-1">
                    <label class="block font-bold mb-2">Ürün Giriş Tarihi</label>
                    <p-datepicker [(ngModel)]="yeniFatura.urunGirisTarihi" dateFormat="dd.mm.yy" [showIcon]="true"
                        [showTime]="true" hourFormat="24" styleClass="w-full" placeholder="Opsiyonel"></p-datepicker>
                </div>
            </div>

            <!-- Items -->
            <div class="space-y-4 mb-6">
                <h3 class="font-bold border-b pb-2 mb-4 text-gray-700">Yakıt Kalemleri</h3>
                <div *ngFor="let item of yeniFatura.kalemler; let i = index"
                    class="p-4 bg-gray-50 rounded-xl border border-gray-200 relative mb-4">
                    <button *ngIf="yeniFatura.kalemler.length > 1" (click)="removeItem(i)"
                        class="absolute -top-2 -right-2 bg-red-100 text-red-500 rounded-full w-6 h-6 flex items-center justify-center shadow-sm z-10 hover:bg-red-200 transition-colors">
                        <i class="pi pi-times text-xs"></i>
                    </button>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-gray-400">Yakıt Türü</label>
                            <p-select [options]="yakitList" [(ngModel)]="item.yakitId" optionLabel="ad" optionValue="id"
                                styleClass="w-full"></p-select>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-gray-400">Litre</label>
                            <p-inputNumber [(ngModel)]="item.litre" (ngModelChange)="calculateItemTotal(item)"
                                mode="decimal" [minFractionDigits]="2" styleClass="w-full"></p-inputNumber>
                        </div>
                        <div class="flex flex-col gap-2">
                            <label class="text-xs font-bold text-gray-400">Birim Fiyat</label>
                            <p-inputNumber [(ngModel)]="item.birimFiyat" (ngModelChange)="calculateItemTotal(item)"
                                mode="decimal" [minFractionDigits]="2" [maxFractionDigits]="4"
                                styleClass="w-full"></p-inputNumber>
                        </div>
                    </div>
                </div>
                <button pButton label="Yeni Satır Ekle" icon="pi pi-plus" class="p-button-outlined p-button-sm w-full"
                    (click)="addItem()"></button>
            </div>

            <!-- Total and Save -->
            <div
                class="flex flex-col sm:flex-row justify-between items-center bg-gray-100 p-4 rounded-xl border border-gray-200 gap-4">
                <div class="text-center sm:text-left">
                    <span class="text-gray-500 text-sm">Toplam Fatura Tutarı:</span>
                    <div class="text-2xl font-black text-gray-800">{{ invoiceTotal |
                        currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                </div>
                <div class="flex flex-col sm:flex-row gap-2 w-full sm:w-auto">
                    <button pButton label="Güncelle" icon="pi pi-check" class="p-button-success order-1 sm:order-2"
                        [loading]="loading" (click)="saveGiris()"></button>
                    <button pButton label="Vazgeç" class="p-button-text p-button-secondary order-2 sm:order-1"
                        (click)="resetForm()"></button>
                </div>
            </div>
        </div>
    </p-dialog>

</div>