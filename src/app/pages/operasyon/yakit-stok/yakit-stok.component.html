<div class="stok-page p-4">
    <p-toast></p-toast>

    <!-- Header & Filters -->
    <div class="card mb-6 p-6 rounded-2xl bg-white shadow-sm border border-gray-100">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-800 m-0 flex items-center gap-3">
                    <span class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                        <i class="pi pi-chart-pie text-blue-600 text-xl"></i>
                    </span>
                    Yakıt Stok Yönetimi
                </h1>
                <p class="text-gray-500 mt-1 ml-13">Gelişmiş vardiya stok analizi ve trendler</p>
            </div>

            <div class="flex items-center gap-3 bg-gray-50 p-2 rounded-xl">
                <i class="pi pi-calendar text-gray-400 ml-2"></i>
                <p-select [options]="months" [(ngModel)]="selectedMonth" optionLabel="label" (onChange)="onDateChange()"
                    styleClass="w-36 border-0 bg-transparent shadow-none" [style]="{'box-shadow': 'none'}"></p-select>
                <div class="w-px h-6 bg-gray-300"></div>
                <p-select [options]="years" [(ngModel)]="selectedYear" optionLabel="label" (onChange)="onDateChange()"
                    styleClass="w-32 border-0 bg-transparent shadow-none" [style]="{'box-shadow': 'none'}"></p-select>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center py-12">
        <i class="pi pi-spin pi-spinner text-4xl text-blue-500"></i>
    </div>

    <div *ngIf="!loading" class="animate-fade-in">

        <!-- DASHBOARD KPIS -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <!-- Total Stock -->
            <div
                class="p-5 bg-gradient-to-br from-indigo-500 to-purple-600 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-database text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-indigo-100 text-sm font-medium mb-1">Toplam Anlık Stok</div>
                    <div class="text-4xl font-bold mb-2">{{ totalCurrentStock | number:'1.0-0' }} <span
                            class="text-lg opacity-70">Lt</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-clock"></i> <span>Canlı Tank Verisi</span>
                    </div>
                </div>
            </div>

            <!-- Monthly Sales -->
            <div
                class="p-5 bg-gradient-to-br from-emerald-500 to-teal-600 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-shopping-cart text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-emerald-100 text-sm font-medium mb-1">Aylık Toplam Satış</div>
                    <div class="text-4xl font-bold mb-2">{{ totalMonthlySales | number:'1.0-0' }} <span
                            class="text-lg opacity-70">Lt</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-chart-line"></i> <span>{{ selectedMonth.label }} ayına ait</span>
                    </div>
                </div>
            </div>

            <!-- Days Remaining -->
            <div
                class="p-5 bg-gradient-to-br from-orange-500 to-pink-500 text-white rounded-2xl shadow-lg relative overflow-hidden">
                <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4">
                    <i class="pi pi-hourglass text-9xl text-white"></i>
                </div>
                <div class="relative z-10">
                    <div class="text-orange-100 text-sm font-medium mb-1">Tahmini Stok Ömrü</div>
                    <div class="text-4xl font-bold mb-2">~{{ estimatedDaysLeft }} <span
                            class="text-lg opacity-70">Gün</span></div>
                    <div class="flex items-center gap-2 text-xs bg-white/20 w-max px-2 py-1 rounded-lg">
                        <i class="pi pi-calendar"></i> <span>Ort. Satışa Göre</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- CHARTS SECTION -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8" *ngIf="vardiyaHareketleri.length > 0">
            <!-- Stock Trend Chart -->
            <div class="card p-6 bg-white rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="pi pi-chart-line text-blue-500"></i> Stok Seviyesi Değişimi
                </h3>
                <div class="h-[300px]">
                    <p-chart type="line" [data]="stockTrendData" [options]="chartOptions" height="100%"></p-chart>
                </div>
            </div>

            <!-- Daily Sales Chart -->
            <div class="card p-6 bg-white rounded-2xl shadow-sm border border-gray-100">
                <h3 class="font-bold text-gray-700 mb-4 flex items-center gap-2">
                    <i class="pi pi-chart-bar text-green-500"></i> Günlük Satış Hareketi
                </h3>
                <div class="h-[300px]">
                    <p-chart type="bar" [data]="dailySalesData" [options]="chartOptions" height="100%"></p-chart>
                </div>
            </div>
        </div>

        <!-- TANK DETAILS LIST -->
        <div *ngIf="xmlStokVerileri.length > 0">
            <h2 class="text-lg font-bold text-gray-700 mb-4 px-1 flex items-center gap-2">
                <i class="pi pi-list text-gray-400"></i>
                Detaylı Tank Durumu
            </h2>

            <div class="card p-6 bg-gray-50 border border-gray-200 rounded-2xl">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-3 gap-6">
                    <div *ngFor="let item of xmlStokVerileri"
                        class="p-5 rounded-2xl border-l-4 bg-white shadow-sm hover:shadow-md transition-all"
                        [style.border-left-color]="item.renk || '#666'">

                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h4 class="font-bold text-xl text-gray-800 m-0">{{ item.yakitTipi }}</h4>
                                <div *ngIf="item.tanimli === false" class="mt-1">
                                    <span
                                        class="text-[10px] bg-red-50 text-red-600 px-2 py-0.5 rounded-md border border-red-100 font-bold flex items-center gap-1 w-max">
                                        <i class="pi pi-exclamation-triangle"></i> Tanımsız Ürün (Sisteme Ekleyin)
                                    </span>
                                </div>
                            </div>
                            <span
                                class="text-xs bg-gray-100 text-gray-500 px-3 py-1 rounded-full font-medium flex items-center gap-1">
                                <i class="pi pi-history text-[10px]"></i> {{ item.kayitSayisi }} Vardiya
                            </span>
                        </div>

                        <div class="text-center py-6 bg-gray-50/50 rounded-xl mb-4 border border-gray-100">
                            <div class="text-xs text-gray-400 mb-1">Mevcut Stok</div>
                            <span class="text-4xl font-bold" [style.color]="item.renk || '#666'">
                                {{ item.sonStok > 0 ? (item.sonStok | number:'1.0-0') : '0' }}
                            </span>
                            <span *ngIf="item.sonStok > 0" class="text-gray-500 text-lg ml-1">Lt</span>
                        </div>

                        <div class="grid grid-cols-3 gap-3 text-center">
                            <div class="p-3 bg-green-50 rounded-xl">
                                <div class="text-green-600 text-[10px] mb-1 font-bold uppercase tracking-wide">Yükle
                                </div>
                                <div class="font-bold text-gray-800 text-sm">{{ item.toplamSevkiyat | number:'1.0-0' }}
                                </div>
                            </div>
                            <div class="p-3 bg-red-50 rounded-xl">
                                <div class="text-red-500 text-[10px] mb-1 font-bold uppercase tracking-wide">Sat</div>
                                <div class="font-bold text-gray-800 text-sm">{{ item.toplamSatis | number:'1.0-0' }}
                                </div>
                            </div>
                            <div class="p-3 bg-gray-100 rounded-xl">
                                <div class="text-gray-500 text-[10px] mb-1 font-bold uppercase tracking-wide">Fark</div>
                                <div class="font-bold text-sm" [class.text-green-600]="item.toplamFark >= 0"
                                    [class.text-red-600]="item.toplamFark < 0">
                                    {{ item.toplamFark | number:'1.0-0' }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SHIFT MOVEMENTS TABLE -->
        <div *ngIf="vardiyaHareketleri.length > 0" class="mt-8">
            <h2 class="text-lg font-bold text-gray-700 mb-4 px-1 flex items-center gap-2">
                <i class="pi pi-history text-gray-400"></i>
                Vardiya Bazlı Hareketler
            </h2>
            <div class="card bg-white shadow-sm border border-gray-100 rounded-2xl overflow-hidden">
                <p-table [value]="vardiyaHareketleri" [rows]="10" [paginator]="true" styleClass="p-datatable-sm">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Tarih</th>
                            <th>Vardiya ID</th>
                            <th>Tank Detayları</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-v>
                        <tr>
                            <td class="font-medium text-gray-600">{{ v.tarih | date:'dd.MM.yyyy HH:mm' }}</td>
                            <td><span class="bg-blue-50 text-blue-600 px-2 py-1 rounded text-xs font-bold">#{{
                                    v.vardiyaId }}</span></td>
                            <td>
                                <div class="flex flex-wrap gap-2">
                                    <div *ngFor="let t of v.tanklar"
                                        class="text-[10px] border px-2 py-1 rounded-lg flex items-center gap-2"
                                        [style.border-color]="t.renk + '40'" [style.background-color]="t.renk + '0A'">
                                        <span class="w-2 h-2 rounded-full" [style.background-color]="t.renk"></span>
                                        <span class="font-bold text-gray-700">{{ t.tankAdi }}:</span>
                                        <span class="text-gray-600">{{ t.satilanMiktar | number:'1.0-1' }} Lt
                                            Satış</span>
                                        <span *ngIf="t.sevkiyatMiktar > 0" class="text-green-600 font-bold">+{{
                                            t.sevkiyatMiktar | number:'1.0-0' }} Lt</span>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>

        <div *ngIf="xmlStokVerileri.length === 0"
            class="card text-center py-12 mb-8 bg-gray-50 border-dashed border-2 border-gray-200 rounded-xl">
            <i class="pi pi-info-circle text-4xl mb-3 text-gray-300"></i>
            <p class="text-gray-500 m-0">Bu dönem için hesaplanmış stok verisi bulunamadı.</p>
        </div>
    </div>
</div>