<p-toast></p-toast>
<p-confirmDialog [style]="{width: '450px'}" [breakpoints]="{'960px': '90vw'}"></p-confirmDialog>

<div class="grid grid-cols-12 gap-6">
    <!-- Başlık -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-surface-800 dark:text-surface-100 m-0">
                        <i class="pi pi-cog mr-2 text-primary-500 animate-spin-slow"></i>Sistem Tanımları Yönetimi
                    </h2>
                    <p class="text-surface-500 mt-2">
                        Sistem genelinde kullanılan tüm kategorik tanımları buradan merkezi olarak yönetebilirsiniz.
                    </p>
                </div>
                <div class="flex gap-2">
                    <p-button label="Yeni Tanım Ekle" icon="pi pi-plus" severity="primary" (onClick)="openNew()"
                        styleClass="shadow-lg transform transition-transform hover:scale-105 active:scale-95"></p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab View Container -->
    <div class="col-span-12">
        <p-tabView (onChange)="onTabChange($event)" styleClass="custom-tabs">
            <p-tabPanel *ngFor="let tab of tabs" [leftIcon]="tab.icon">
                <ng-template pTemplate="header">
                    <span class="font-semibold">{{tab.label}}</span>
                </ng-template>

                <div
                    class="relative overflow-hidden rounded-2xl border border-surface-200 dark:border-surface-800 bg-surface-0 dark:bg-surface-900">

                    <p-table #dt [value]="definitions" [rows]="10" [paginator]="true" [rowHover]="true"
                        styleClass="p-datatable-gridlines p-datatable-sm"
                        [globalFilterFields]="['name','description','code']" responsiveLayout="stack"
                        [breakpoint]="'960px'">

                        <ng-template pTemplate="caption">
                            <div
                                class="flex flex-col md:flex-row justify-between items-center bg-surface-50 dark:bg-surface-800 p-4 border-b border-surface-200 dark:border-surface-800 gap-4">
                                <span class="text-xl font-bold">{{getCurrentTabLabel()}} Listesi ({{ definitions.length
                                    }})</span>
                                <p-iconfield>
                                    <p-inputicon class="pi pi-search" />
                                    <input pInputText type="text" placeholder="Tanımlarda ara..."
                                        (input)="dt.filterGlobal($any($event.target).value, 'contains')"
                                        class="w-full md:w-80" />
                                </p-iconfield>
                            </div>
                        </ng-template>

                        <ng-template pTemplate="header">
                            <tr class="bg-surface-50 dark:bg-surface-800">
                                <th pSortableColumn="sortOrder" style="width: 80px" class="text-center"># <p-sortIcon
                                        field="sortOrder"></p-sortIcon></th>
                                <th pSortableColumn="name">Tanım Adı <p-sortIcon field="name"></p-sortIcon></th>
                                <th pSortableColumn="code" style="width: 180px">Kod / Anahtar <p-sortIcon
                                        field="code"></p-sortIcon></th>
                                <th pSortableColumn="description" class="hidden lg:table-cell">Açıklama <p-sortIcon
                                        field="description"></p-sortIcon></th>
                                <th pSortableColumn="isActive" style="width: 110px" class="text-center">Durum
                                    <p-sortIcon field="isActive"></p-sortIcon>
                                </th>
                                <th style="width: 140px" class="text-center">İşlemler</th>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="body" let-item>
                            <tr class="group hover:bg-primary-50/10 transition-colors">
                                <td class="text-center font-mono text-surface-400">{{item.sortOrder}}</td>
                                <td>
                                    <div class="flex items-center gap-3">
                                        <div
                                            class="w-8 h-8 rounded-lg bg-primary-100 dark:bg-primary-900/30 flex items-center justify-center text-primary-600">
                                            <i [class]="tabs[tabs.indexOf(tab)].icon"></i>
                                        </div>
                                        <span
                                            class="font-bold text-surface-900 dark:text-surface-0">{{item.name}}</span>
                                    </div>
                                </td>
                                <td>
                                    <span *ngIf="item.code"
                                        class="px-2 py-1 rounded bg-surface-100 dark:bg-surface-800 text-xs font-mono border border-surface-200 dark:border-surface-700">
                                        {{item.code}}
                                    </span>
                                    <span *ngIf="!item.code" class="text-surface-300 italic text-xs">Atanmamış</span>
                                </td>
                                <td class="hidden lg:table-cell text-surface-500 text-sm italic">{{item.description ||
                                    '-'}}
                                </td>
                                <td class="text-center">
                                    <p-tag [severity]="item.isActive ? 'success' : 'danger'"
                                        [value]="item.isActive ? 'Aktif' : 'Pasif'" [rounded]="true"
                                        styleClass="text-[10px] px-3"></p-tag>
                                </td>
                                <td class="text-center">
                                    <div
                                        class="flex justify-center gap-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                        <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="info"
                                            (onClick)="editDefinition(item)" pTooltip="Düzenle"></p-button>
                                        <p-button icon="pi pi-trash" [rounded]="true" [text]="true" severity="danger"
                                            (onClick)="deleteDefinition(item)" pTooltip="Sil"></p-button>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="emptymessage">
                            <tr>
                                <td colspan="6" class="text-center py-8">
                                    <div class="flex flex-col items-center gap-2 text-surface-400">
                                        <i class="pi pi-folder-open text-4xl opacity-20"></i>
                                        <span>Bu kategori için henüz bir tanım bulunamadı.</span>
                                    </div>
                                </td>
                            </tr>
                        </ng-template>

                        <ng-template pTemplate="summary">
                            <div class="flex align-items-center justify-content-between text-xs text-surface-400 p-2">
                                Toplam {{definitions ? definitions.length : 0}} kayıt listeleniyor.
                            </div>
                        </ng-template>
                    </p-table>
                </div>
            </p-tabPanel>
        </p-tabView>
    </div>
</div>

<!-- TANIM MODAL - CLEAN & ORGANIZED DESIGN -->
<p-dialog [(visible)]="definitionDialog" [style]="{width: '500px'}" [breakpoints]="{'960px': '95vw'}" [modal]="true"
    [header]="definition.id ? 'Tanımı Düzenle' : 'Yeni Tanım Ekle'" styleClass="p-fluid">

    <div class="flex flex-col gap-5 py-2 mt-2">
        <!-- Bilgi Paneli (Kategori gösterimi) -->
        <div
            class="bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300 p-3 rounded-xl border border-primary-100 dark:border-primary-800 flex items-center gap-3">
            <i class="pi pi-info-circle text-xl"></i>
            <div>
                <span class="block font-bold text-xs uppercase tracking-wider">Kategori</span>
                <span class="text-sm font-semibold">{{getCurrentTabLabel()}}</span>
            </div>
        </div>

        <!-- Ad -->
        <div class="flex flex-col gap-2">
            <label class="font-bold text-sm text-surface-700 dark:text-surface-200">Tanım Adı</label>
            <input pInputText id="name" [(ngModel)]="definition.name" placeholder="Örn: Garanti Bankası" required
                autofocus class="w-full !rounded-xl" />
            <small class="text-red-500" *ngIf="submitted && !definition.name">Lütfen bir ad giriniz.</small>
        </div>

        <!-- Kod -->
        <div class="flex flex-col gap-2">
            <label class="font-bold text-sm text-surface-700 dark:text-surface-200 flex items-center justify-between">
                Sistem Kodu / Anahtar
                <span class="text-[10px] text-primary-500 uppercase font-bold">İleri Düzey</span>
            </label>
            <input pInputText id="code" [(ngModel)]="definition.code" placeholder="Örn: GARANTI_BBVA"
                class="w-full !rounded-xl font-mono text-xs" />

            <div
                class="bg-amber-50 dark:bg-amber-900/10 text-amber-700 dark:text-amber-300 p-3 rounded-lg border border-amber-100 dark:border-amber-900/30 flex gap-2">
                <i class="pi pi-exclamation-triangle text-lg"></i>
                <span class="text-[10px] leading-relaxed"><strong>UYARI:</strong> Bu kod sistem tarafından eşleştirme
                    için kullanılır. Değiştirilmesi raporlarda veri kaybına neden olabilir.</span>
            </div>
        </div>

        <!-- Açıklama -->
        <div class="flex flex-col gap-2">
            <label class="font-bold text-sm text-surface-700 dark:text-surface-200">Açıklama</label>
            <textarea id="description" pInputTextarea [(ngModel)]="definition.description" rows="3"
                class="w-full !rounded-xl" placeholder="İsteğe bağlı ek bilgi..."></textarea>
        </div>

        <!-- Alt Grid (Sıra ve Durum) -->
        <div class="grid grid-cols-2 gap-4">
            <div class="flex flex-col gap-2">
                <label class="font-bold text-sm text-surface-700 dark:text-surface-200">Sıralama</label>
                <p-inputNumber id="sortOrder" [(ngModel)]="definition.sortOrder" [showButtons]="true" [min]="0"
                    styleClass="w-full !rounded-xl overflow-hidden"></p-inputNumber>
            </div>
            <div class="flex flex-col gap-2">
                <label class="font-bold text-sm text-surface-700 dark:text-surface-200">Durum</label>
                <div
                    class="flex items-center h-full gap-3 p-2 bg-surface-50 dark:bg-surface-800 rounded-xl border border-surface-200 dark:border-surface-700">
                    <p-inputSwitch [(ngModel)]="definition.isActive"></p-inputSwitch>
                    <span class="text-sm font-semibold"
                        [ngClass]="definition.isActive ? 'text-green-600' : 'text-red-500'">
                        {{definition.isActive ? 'Aktif' : 'Pasif'}}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="Vazgeç" icon="pi pi-times" [text]="true" severity="secondary"
            (onClick)="hideDialog()"></p-button>
        <p-button label="Kaydet" icon="pi pi-check" severity="success" (onClick)="saveDefinition()"
            class="shadow-md"></p-button>
    </ng-template>
</p-dialog>