<p-toast></p-toast>

<div class="grid grid-cols-12 gap-6">
    <!-- Başlık -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-surface-800 dark:text-surface-100 m-0">
                        <i class="pi pi-users mr-2 text-blue-500"></i>Personel Tanımları
                    </h2>
                    <p class="text-surface-500 mt-2">
                        Personel bilgilerini görüntüleyin ve yönetin
                    </p>
                </div>
                <div class="flex gap-2">
                    <p-button label="Yeni Personel" icon="pi pi-plus" severity="success" (onClick)="openNew()">
                    </p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- Personel Listesi -->
    <div class="col-span-12">
        <!-- Desktop Table View -->
        <div class="card hidden md:block">
            <p-table [value]="personeller" [loading]="loading" [paginator]="personeller.length > 10" [rows]="10"
                styleClass="p-datatable-striped" [globalFilterFields]="filterFields" #dt>

                <ng-template pTemplate="caption">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold">Personel Listesi ({{ personeller.length }})</span>
                        <p-iconfield>
                            <p-inputicon class="pi pi-search" />
                            <input pInputText type="text" placeholder="Ara..."
                                (input)="dt.filterGlobal($any($event.target).value, 'contains')" />
                        </p-iconfield>
                    </div>
                </ng-template>

                <ng-template pTemplate="header">
                    <tr class="text-sm">
                        <th *ngIf="!isMarketSorumlusu">Otomasyon Adı</th>
                        <th>Ad Soyad</th>
                        <th>Telefon</th>
                        <th *ngIf="!isMarketSorumlusu">Key ID</th>
                        <th class="text-center">Rol</th>
                        <th class="text-center">Durum</th>
                        <th class="text-center">İşlemler</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-personel>
                    <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                        <td *ngIf="!isMarketSorumlusu">
                            <div class="flex items-center gap-3" *ngIf="personel.rol !== 'MARKET_GOREVLISI'">
                                <div class="w-10 h-10 rounded-full flex items-center justify-center"
                                    [style.background]="'linear-gradient(135deg, #6366f1 0%, #3b82f6 100%)'">
                                    <span class="text-white font-bold text-sm">{{ personel.otomasyonAdi.substring(0,
                                        2).toUpperCase() }}</span>
                                </div>
                                <span class="font-bold text-surface-800 dark:text-surface-100">{{ personel.otomasyonAdi
                                    }}</span>
                            </div>
                            <span *ngIf="personel.rol === 'MARKET_GOREVLISI'" class="text-surface-400 italic">N/A</span>
                        </td>
                        <td>
                            <span class="text-surface-800 dark:text-surface-100">{{ personel.adSoyad }}</span>
                        </td>
                        <td>
                            <span class="text-surface-800 dark:text-surface-100">{{ personel.telefon || '-' }}</span>
                        </td>
                        <td *ngIf="!isMarketSorumlusu">
                            <span class="text-surface-600 dark:text-surface-400 font-mono"
                                *ngIf="personel.rol !== 'MARKET_GOREVLISI'">{{ personel.keyId || '-' }}</span>
                            <span *ngIf="personel.rol === 'MARKET_GOREVLISI'" class="text-surface-400 italic">N/A</span>
                        </td>
                        <td class="text-center">
                            <p-tag [value]="getRolLabel(personel.rol)"
                                [severity]="getRolSeverity(personel.rol)"></p-tag>
                        </td>
                        <td class="text-center">
                            <p-tag [value]="personel.aktif ? 'Aktif' : 'Pasif'"
                                [severity]="personel.aktif ? 'success' : 'danger'" styleClass="cursor-pointer"
                                (click)="toggleAktif(personel)" pTooltip="Durumu değiştirmek için tıklayın">
                            </p-tag>
                        </td>
                        <td class="text-center">
                            <div class="flex gap-2 justify-center">
                                <button pButton pRipple icon="pi pi-pencil"
                                    class="p-button-rounded p-button-text p-button-info"
                                    (click)="editPersonel(personel)" pTooltip="Düzenle" tooltipPosition="top">
                                </button>
                                <button *ngIf="!isVardiyaSorumlusu" pButton pRipple icon="pi pi-trash"
                                    class="p-button-rounded p-button-text p-button-danger"
                                    (click)="deletePersonel(personel)" pTooltip="Sil" tooltipPosition="top">
                                </button>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td colspan="7" class="text-center py-12">
                            <div class="flex flex-col items-center">
                                <div
                                    class="w-24 h-24 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center mb-4">
                                    <i class="pi pi-users text-4xl text-surface-400"></i>
                                </div>
                                <h4 class="text-surface-600 dark:text-surface-300 m-0">Henüz personel kaydı yok</h4>
                                <p class="text-surface-400 text-sm m-0 mt-2">Yeni personel eklemek için "Yeni Personel"
                                    butonuna tıklayın</p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>
        </div>

        <!-- Mobile Card View -->
        <div class="block md:hidden">
            <!-- Search for Mobile -->
            <div class="mb-3">
                <p-iconfield styleClass="w-full">
                    <p-inputicon class="pi pi-search" />
                    <input pInputText type="text" placeholder="Personel Ara..." class="w-full"
                        (input)="dtMobile.filterGlobal($any($event.target).value, 'contains')" />
                </p-iconfield>
            </div>

            <div class="flex flex-col gap-3">
                <div *ngFor="let personel of personeller"
                    class="bg-surface-card p-4 rounded-xl shadow-sm border border-surface-200 dark:border-surface-700">
                    <div class="flex items-start justify-between mb-3">
                        <div class="flex items-center gap-3">
                            <div *ngIf="personel.rol !== 'MARKET_GOREVLISI'"
                                class="w-10 h-10 rounded-full flex items-center justify-center"
                                [style.background]="'linear-gradient(135deg, #6366f1 0%, #3b82f6 100%)'">
                                <span class="text-white font-bold text-sm">{{ personel.otomasyonAdi.substring(0,
                                    2).toUpperCase() }}</span>
                            </div>
                            <div *ngIf="personel.rol === 'MARKET_GOREVLISI'"
                                class="w-10 h-10 rounded-full bg-orange-100 dark:bg-orange-900/30 flex items-center justify-center">
                                <i class="pi pi-shopping-bag text-orange-500 text-lg"></i>
                            </div>
                            <div>
                                <h3 class="font-bold text-surface-900 dark:text-surface-0 m-0">{{ personel.adSoyad }}
                                </h3>
                                <div class="text-sm text-surface-500 flex items-center gap-1 mt-1">
                                    <i class="pi pi-id-card text-xs"></i>
                                    <span>{{ personel.otomasyonAdi || 'N/A' }}</span>
                                </div>
                            </div>
                        </div>
                        <p-tag [value]="getRolLabel(personel.rol)" [severity]="getRolSeverity(personel.rol)"
                            styleClass="text-xs"></p-tag>
                    </div>

                    <div class="grid grid-cols-2 gap-3 mb-3 text-sm">
                        <div class="bg-surface-50 dark:bg-surface-800 p-2 rounded-lg">
                            <span class="block text-surface-500 text-xs mb-1">Telefon</span>
                            <span class="font-medium text-surface-700 dark:text-surface-200">{{ personel.telefon || '-'
                                }}</span>
                        </div>
                        <div class="bg-surface-50 dark:bg-surface-800 p-2 rounded-lg">
                            <span class="block text-surface-500 text-xs mb-1">Key ID</span>
                            <span class="font-medium text-surface-700 dark:text-surface-200 font-mono">{{ personel.keyId
                                || '-' }}</span>
                        </div>
                    </div>

                    <div
                        class="flex items-center justify-between pt-3 border-t border-surface-100 dark:border-surface-700">
                        <div class="flex items-center gap-2" (click)="toggleAktif(personel)">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center transition-colors"
                                [ngClass]="personel.aktif ? 'bg-green-100 text-green-600 dark:bg-green-900/30' : 'bg-red-100 text-red-600 dark:bg-red-900/30'">
                                <i [class]="personel.aktif ? 'pi pi-check' : 'pi pi-ban'"></i>
                            </div>
                            <span class="text-sm font-medium"
                                [ngClass]="personel.aktif ? 'text-green-600' : 'text-red-600'">
                                {{ personel.aktif ? 'Aktif' : 'Pasif' }}
                            </span>
                        </div>

                        <div class="flex gap-2">
                            <button pButton pRipple icon="pi pi-pencil"
                                class="p-button-rounded p-button-text p-button-info" (click)="editPersonel(personel)">
                            </button>
                            <button *ngIf="!isVardiyaSorumlusu" pButton pRipple icon="pi pi-trash"
                                class="p-button-rounded p-button-text p-button-danger"
                                (click)="deletePersonel(personel)">
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty State Mobile -->
                <div *ngIf="personeller.length === 0 && !loading" class="text-center py-8">
                    <div
                        class="w-16 h-16 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center mx-auto mb-3">
                        <i class="pi pi-users text-2xl text-surface-400"></i>
                    </div>
                    <h4 class="text-surface-600 dark:text-surface-300 m-0">Kayıt Bulunamadı</h4>
                </div>
            </div>

            <!-- Hidden table to support filtering logic if needed, or better, use a pipe filter manually -->
            <p-table #dtMobile [value]="personeller" [globalFilterFields]="filterFields" class="hidden"></p-table>
        </div>
    </div>
</div>

<!-- Personel Ekleme/Düzenleme Dialog -->
<p-dialog [header]="editMode ? 'Personel Düzenle' : 'Yeni Personel'" [(visible)]="dialogVisible" [modal]="true"
    [style]="{width: '500px'}">

    <div class="flex flex-col gap-4">
        <div *ngIf="currentPersonel.rol !== 'MARKET_GOREVLISI'">
            <label for="otomasyonAdi" class="block text-sm font-medium mb-2">Otomasyon Adı <span
                    class="text-red-500">*</span></label>
            <input pInputText id="otomasyonAdi" [(ngModel)]="currentPersonel.otomasyonAdi" class="w-full"
                placeholder="Otomasyon sistemindeki kısa ad" [disabled]="loading || editMode" />
            <small class="text-surface-500">
                <span *ngIf="!editMode">Otomasyon dosyasında görünen kısa ad (örn: AHMET, MEHMET)</span>
                <span *ngIf="editMode" class="text-orange-500"><i class="pi pi-lock mr-1"></i>Otomasyon adı
                    değiştirilemez</span>
            </small>
        </div>

        <div>
            <label for="adSoyad" class="block text-sm font-medium mb-2">Ad Soyad <span
                    class="text-red-500">*</span></label>
            <input pInputText id="adSoyad" [(ngModel)]="currentPersonel.adSoyad" class="w-full"
                placeholder="Personelin tam adı" [disabled]="loading" />
            <small class="text-surface-500">Personelin gerçek adı ve soyadı (örn: Ahmet Yılmaz)</small>
        </div>

        <div>
            <label for="telefon" class="block text-sm font-medium mb-2">Telefon</label>
            <input pInputText id="telefon" [(ngModel)]="currentPersonel.telefon" class="w-full"
                placeholder="İletişim numarası" [disabled]="loading" />
        </div>

        <div *ngIf="currentPersonel.rol !== 'MARKET_GOREVLISI'">
            <label for="keyId" class="block text-sm font-medium mb-2">Key ID</label>
            <input pInputText id="keyId" [(ngModel)]="currentPersonel.keyId" class="w-full"
                placeholder="Otomasyon Key ID (opsiyonel)" [disabled]="loading" />
            <small class="text-surface-500">El terminali veya otomasyon sistemindeki personel kodu</small>
        </div>

        <div *ngIf="!isVardiyaSorumlusu && !isMarketSorumlusu">
            <label for="rol" class="block text-sm font-medium mb-2">Rol <span class="text-red-500">*</span></label>
            <p-select id="rol" [(ngModel)]="currentPersonel.rol" [options]="roller" optionLabel="label"
                optionValue="value" placeholder="Rol seçin" styleClass="w-full" [disabled]="loading" appendTo="body">
            </p-select>
        </div>

        <div class="flex items-center gap-2">
            <p-checkbox [(ngModel)]="currentPersonel.aktif" [binary]="true" inputId="aktif" [disabled]="loading">
            </p-checkbox>
            <label for="aktif" class="cursor-pointer">Aktif</label>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary" (onClick)="hideDialog()" [disabled]="loading">
        </p-button>
        <p-button [label]="editMode ? 'Güncelle' : 'Kaydet'" icon="pi pi-check" severity="success"
            (onClick)="savePersonel()" [loading]="loading">
        </p-button>
    </ng-template>
</p-dialog>