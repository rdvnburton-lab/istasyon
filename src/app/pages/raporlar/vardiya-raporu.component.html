<!-- MOBILE NATIVE VIEW -->
<div class="rapor-page block md:hidden">
    <!-- Mobile Native Header -->
    <div class="mobile-page-header">
        <div class="page-title-row">
            <div>
                <h1 class="page-title">Raporlar</h1>
                <p class="page-subtitle">{{ raporTuru === 'pompa' ? 'Pompa' : 'Market' }} performans özeti</p>
            </div>
        </div>
    </div>

    <!-- Segment Control (Pompa/Market) -->
    <div class="segment-container"
        *ngIf="userRole === 'admin' || userRole === 'patron' || userRole === 'istasyon_sorumlusu'">
        <div class="segment-control">
            <button *ngFor="let item of raporTurleri" class="segment-btn" [class.active]="raporTuru === item.value"
                (click)="raporTuru = $any(item.value); raporla()">
                <i [class]="item.icon"></i>
                <span>{{ item.label }}</span>
            </button>
        </div>
    </div>

    <!-- Date Filters -->
    <div class="filter-container">
        <div class="date-row">
            <div class="date-field">
                <div class="date-label">Başlangıç</div>
                <input class="date-input" type="date" [value]="baslangicTarihi | date:'yyyy-MM-dd'"
                    (change)="baslangicTarihi = $any($event.target).valueAsDate" />
            </div>
            <div class="date-field">
                <div class="date-label">Bitiş</div>
                <input class="date-input" type="date" [value]="bitisTarihi | date:'yyyy-MM-dd'"
                    (change)="bitisTarihi = $any($event.target).valueAsDate" />
            </div>
        </div>
        <div class="quick-filters">
            <button class="quick-btn" (click)="tarihAyarla('bugun')">Bugün</button>
            <button class="quick-btn" (click)="tarihAyarla('dun')">Dün</button>
            <button class="quick-btn" (click)="tarihAyarla('buAy')">Bu Ay</button>
            <button class="quick-btn active" (click)="raporla()">Raporla</button>
        </div>
    </div>

    <!-- Summary Cards - Pompa -->
    <div *ngIf="raporTuru === 'pompa'" class="summary-scroll">
        <div class="summary-card blue">
            <div class="summary-label">Toplam Vardiya</div>
            <div class="summary-value">{{ ozet.toplamVardiya }}</div>
        </div>
        <div class="summary-card green">
            <div class="summary-label">Toplam Ciro</div>
            <div class="summary-value">{{ ozet.toplamTutar | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
        </div>
        <div class="summary-card orange">
            <div class="summary-label">Toplam Litre</div>
            <div class="summary-value">{{ ozet.toplamLitre | number:'1.0-0' }} Lt</div>
        </div>
        <div class="summary-card purple">
            <div class="summary-label">Toplam Gider</div>
            <div class="summary-value">{{ ozet.toplamGider | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
        </div>
    </div>

    <!-- Summary Cards - Market -->
    <div *ngIf="raporTuru === 'market'" class="summary-scroll">
        <div class="summary-card blue">
            <div class="summary-label">Toplam Vardiya</div>
            <div class="summary-value">{{ ozet.toplamVardiya }}</div>
        </div>
        <div class="summary-card green">
            <div class="summary-label">Toplam Satış</div>
            <div class="summary-value">{{ ozet.toplamSatis | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
        </div>
        <div class="summary-card indigo">
            <div class="summary-label">Toplam Teslimat</div>
            <div class="summary-value">{{ ozet.toplamTeslimat | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
        </div>
        <div class="summary-card" [ngClass]="ozet.toplamFark < 0 ? 'red' : 'teal'">
            <div class="summary-label">Toplam Fark</div>
            <div class="summary-value">{{ ozet.toplamFark | currency:'TRY':'symbol-narrow':'1.0-0' }}</div>
        </div>
    </div>

    <!-- Vardiya Cards Section -->
    <div class="section-title">Vardiya Listesi ({{ vardiyalar.length }})</div>

    <div class="vardiya-list">
        <!-- Loading State -->
        <div *ngIf="loading" class="text-center p-4">
            <i class="pi pi-spin pi-spinner text-2xl text-[var(--primary-color)]"></i>
        </div>

        <!-- Pompa Vardiyalar -->
        <ng-container *ngIf="!loading && raporTuru === 'pompa'">
            <div *ngFor="let vardiya of vardiyalar" class="vardiya-card">
                <div class="vardiya-header" (click)="toggleRow(vardiya.vardiyaId)">
                    <div class="flex items-center gap-2">
                        <span class="vardiya-date">{{ vardiya.tarih | date:'dd.MM.yyyy HH:mm' }}</span>
                        <p-tag [value]="vardiya.durum"
                            [severity]="vardiya.durum === 'ONAYLANDI' ? 'success' : vardiya.durum === 'ACIK' ? 'info' : vardiya.durum === 'REDDEDILDI' ? 'danger' : 'warn'"
                            [style]="{fontSize: '0.7rem'}"></p-tag>
                    </div>
                    <i [class]="expandedRows[vardiya.vardiyaId] ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                        class="text-[var(--text-color-secondary)]"></i>
                </div>
                <div class="vardiya-body">
                    <div class="vardiya-field full-width">
                        <div class="field-label">Dosya Adı</div>
                        <div class="field-value">{{ vardiya.dosyaAdi }}</div>
                    </div>
                    <div class="vardiya-field">
                        <div class="field-label">Tutar</div>
                        <div class="field-value">{{ vardiya.tutar | currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                    </div>
                </div>

                <!-- Expanded Personel Detail for Mobile -->
                <div *ngIf="expandedRows[vardiya.vardiyaId]" class="personel-detay-list">
                    <div *ngFor="let pf of vardiya.personelFarklari" class="personel-row">
                        <span class="p-name">{{ pf.personelAdi }}</span>
                        <span class="p-fark"
                            [style.color]="pf.fark < -1 ? '#ef4444' : (pf.fark > 1 ? '#22c55e' : 'var(--text-color)')">
                            {{ pf.fark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                        </span>
                    </div>
                    <div *ngIf="!vardiya.personelFarklari || vardiya.personelFarklari.length === 0"
                        class="text-center text-xs text-[var(--text-color-secondary)] py-2">
                        Personel detayı bulunamadı.
                    </div>
                </div>
            </div>
        </ng-container>

        <!-- Market Vardiyalar -->
        <ng-container *ngIf="!loading && raporTuru === 'market'">
            <div *ngFor="let vardiya of vardiyalar" class="vardiya-card">
                <div class="vardiya-header">
                    <!-- Market view doesn't need expansion necessarily as per Fark Raporu structure usually being generic, but we can add it if needed. Leaving as static for market based on reference implying Focus on Shift/Personnel diffs usually related to Pompa/Fark raporu structure primarily. But let's keep it consistent if Market data supports it. Assuming generic structure for now -->
                    <span class="vardiya-date">{{ vardiya.tarih | date:'dd.MM.yyyy' }}</span>
                    <p-tag [value]="vardiya.durum"
                        [severity]="vardiya.durum === 'ONAYLANDI' ? 'success' : vardiya.durum === 'ACIK' ? 'info' : vardiya.durum === 'REDDEDILDI' ? 'danger' : 'warn'"
                        [style]="{fontSize: '0.7rem'}"></p-tag>
                </div>
                <div class="vardiya-body">
                    <div class="vardiya-field">
                        <div class="field-label">Satış</div>
                        <div class="field-value">{{ vardiya.toplamSatisTutari | currency:'TRY':'symbol-narrow':'1.2-2'
                            }}</div>
                    </div>
                    <div class="vardiya-field">
                        <div class="field-label">Teslimat</div>
                        <div class="field-value">{{ vardiya.toplamTeslimatTutari |
                            currency:'TRY':'symbol-narrow':'1.2-2' }}</div>
                    </div>
                    <div class="vardiya-field full-width">
                        <div class="field-label">Fark</div>
                        <div class="field-value" [class.positive]="vardiya.toplamFark >= 0"
                            [class.negative]="vardiya.toplamFark < 0">
                            {{ vardiya.toplamFark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                        </div>
                    </div>
                </div>
            </div>
        </ng-container>

        <!-- Empty State -->
        <div *ngIf="!loading && vardiyalar.length === 0" class="empty-state">
            <div class="empty-icon">
                <i class="pi pi-chart-bar"></i>
            </div>
            <div class="empty-title">Kayıt Bulunamadı</div>
            <div class="empty-text">Bu tarih aralığında veri bulunmuyor</div>
        </div>
    </div>
</div>

<!-- DESKTOP VIEW -->
<div class="grid grid-cols-12 gap-6 hidden md:grid">
    <!-- Başlık -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-[var(--text-color)] m-0">
                        <i class="pi pi-chart-bar mr-2 text-blue-500"></i>Vardiya Raporu
                    </h2>
                    <p class="text-[var(--text-color-secondary)] mt-2">
                        İstasyonunuzun vardiya bazlı performans özeti
                    </p>
                </div>
                <div *ngIf="userRole === 'admin' || userRole === 'patron' || userRole === 'istasyon_sorumlusu'">
                    <p-selectButton [options]="raporTurleri" [(ngModel)]="raporTuru" (onChange)="raporla()"
                        optionLabel="label" optionValue="value">
                        <ng-template let-item pTemplate="item">
                            <div class="flex items-center gap-2 px-2">
                                <i [class]="item.icon"></i>
                                <span>{{item.label}}</span>
                            </div>
                        </ng-template>
                    </p-selectButton>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtreler -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row gap-4 items-end">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="flex flex-col gap-2">
                        <label class="font-bold text-sm text-[var(--text-color)]">Başlangıç Tarihi</label>
                        <p-datePicker [(ngModel)]="baslangicTarihi" dateFormat="dd.mm.yy" [showIcon]="true"
                            inputId="baslangic" styleClass="w-full"></p-datePicker>
                    </div>
                    <div class="flex flex-col gap-2">
                        <label class="font-bold text-sm text-[var(--text-color)]">Bitiş Tarihi</label>
                        <p-datePicker [(ngModel)]="bitisTarihi" dateFormat="dd.mm.yy" [showIcon]="true" inputId="bitis"
                            styleClass="w-full"></p-datePicker>
                    </div>
                </div>
                <div class="flex gap-2">
                    <p-button label="Bugün" [text]="true" size="small" (onClick)="tarihAyarla('bugun')"></p-button>
                    <p-button label="Dün" [text]="true" size="small" (onClick)="tarihAyarla('dun')"></p-button>
                    <p-button label="Bu Ay" [text]="true" size="small" (onClick)="tarihAyarla('buAy')"></p-button>
                    <p-button label="Raporla" icon="pi pi-search" (onClick)="raporla()" severity="primary"></p-button>
                </div>
            </div>
        </div>
    </div>

    <div *ngIf="raporTuru === 'pompa'" class="col-span-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="card mb-0 h-full border-t-4 border-t-blue-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Vardiya</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-600 dark:text-blue-400">
                        <i class="pi pi-folder-open text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamVardiya}}</div>
            </div>
            <div class="card mb-0 h-full border-t-4 border-t-green-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Ciro</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-green-500/10 text-green-600 dark:text-green-400">
                        <i class="pi pi-wallet text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamTutar |
                    currency:'TRY':'symbol-narrow':'1.2-2'}}</div>
            </div>
            <div class="card mb-0 h-full border-t-4 border-t-orange-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Litre</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-orange-500/10 text-orange-600 dark:text-orange-400">
                        <i class="pi pi-database text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamLitre | number:'1.2-2'}} Lt</div>
            </div>
            <div class="card mb-0 h-full border-t-4 border-t-purple-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Gider</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-purple-500/10 text-purple-600 dark:text-purple-400">
                        <i class="pi pi-receipt text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamGider |
                    currency:'TRY':'symbol-narrow':'1.2-2'}}</div>
            </div>
        </div>
    </div>

    <!-- Market Özeti -->
    <div *ngIf="raporTuru === 'market'" class="col-span-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="card mb-0 h-full border-t-4 border-t-blue-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Vardiya</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-blue-500/10 text-blue-600 dark:text-blue-400">
                        <i class="pi pi-folder-open text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamVardiya}}</div>
            </div>
            <div class="card mb-0 h-full border-t-4 border-t-green-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Satış</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-green-500/10 text-green-600 dark:text-green-400">
                        <i class="pi pi-shopping-cart text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamSatis |
                    currency:'TRY':'symbol-narrow':'1.2-2'}}</div>
            </div>
            <div class="card mb-0 h-full border-t-4 border-t-indigo-500 p-4">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Teslimat</span>
                    <div
                        class="w-8 h-8 rounded-lg flex items-center justify-center bg-indigo-500/10 text-indigo-600 dark:text-indigo-400">
                        <i class="pi pi-truck text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold text-[var(--text-color)]">{{ozet.toplamTeslimat |
                    currency:'TRY':'symbol-narrow':'1.2-2'}}</div>
            </div>
            <div class="card mb-0 h-full border-t-4 p-4"
                [ngClass]="ozet.toplamFark < 0 ? 'border-t-red-500' : 'border-t-teal-500'">
                <div class="flex justify-between items-start mb-2">
                    <span
                        class="text-sm font-semibold text-[var(--text-color-secondary)] uppercase tracking-wider">Toplam
                        Fark</span>
                    <div class="w-8 h-8 rounded-lg flex items-center justify-center"
                        [ngClass]="ozet.toplamFark < 0 ? 'bg-red-500/10 text-red-600 dark:text-red-400' : 'bg-teal-500/10 text-teal-600 dark:text-teal-400'">
                        <i class="pi pi-percentage text-sm"></i>
                    </div>
                </div>
                <div class="text-2xl font-bold"
                    [ngClass]="ozet.toplamFark < 0 ? 'text-red-600 dark:text-red-400' : 'text-teal-600 dark:text-teal-400'">
                    {{ozet.toplamFark | currency:'TRY':'symbol-narrow':'1.2-2'}}
                </div>
            </div>
        </div>
    </div>

    <!-- Tablo -->
    <div class="col-span-12">
        <div class="card">
            <p-table [value]="vardiyalar" [paginator]="true" [rows]="10" [loading]="loading"
                styleClass="p-datatable-striped" [rowHover]="true">
                <ng-template pTemplate="caption">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold">Vardiya Listesi ({{ vardiyalar.length }})</span>
                    </div>
                </ng-template>
                <ng-template pTemplate="header">
                    <tr *ngIf="raporTuru === 'pompa'" class="text-sm">
                        <th>Tarih</th>
                        <th>Dosya Adı</th>
                        <th class="text-right">Tutar</th>
                        <th class="text-center">Durum</th>
                    </tr>
                    <tr *ngIf="raporTuru === 'market'" class="text-sm">
                        <th>Tarih</th>
                        <th class="text-right">Satış Tutarı</th>
                        <th class="text-right">Teslimat Tutarı</th>
                        <th class="text-right">Fark</th>
                        <th class="text-center">Durum</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-vardiya>
                    <tr *ngIf="raporTuru === 'pompa'"
                        class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                        <td><span class="text-[var(--text-color)] font-medium">{{vardiya.tarih |
                                date:'dd.MM.yyyy HH:mm'}}</span></td>
                        <td>{{vardiya.dosyaAdi}}</td>
                        <td class="text-right font-bold text-[var(--text-color)]">{{vardiya.tutar |
                            currency:'TRY':'symbol-narrow':'1.2-2'}}</td>
                        <td class="text-center">
                            <p-tag [value]="vardiya.durum"
                                [severity]="vardiya.durum === 'ONAYLANDI' ? 'success' : vardiya.durum === 'ACIK' ? 'info' : vardiya.durum === 'REDDEDILDI' ? 'danger' : 'warn'"></p-tag>
                        </td>
                    </tr>
                    <tr *ngIf="raporTuru === 'market'"
                        class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                        <td><span class="text-[var(--text-color)] font-medium">{{vardiya.tarih |
                                date:'dd.MM.yyyy'}}</span></td>
                        <td class="text-right font-bold text-[var(--text-color)]">
                            {{vardiya.toplamSatisTutari | currency:'TRY':'symbol-narrow':'1.2-2'}}
                        </td>
                        <td class="text-right font-bold text-[var(--primary-color)]">{{vardiya.toplamTeslimatTutari |
                            currency:'TRY':'symbol-narrow':'1.2-2'}}</td>
                        <td class="text-right font-bold" [class.text-red-500]="vardiya.toplamFark < 0"
                            [class.text-green-500]="vardiya.toplamFark >= 0">
                            {{vardiya.toplamFark | currency:'TRY':'symbol-narrow':'1.2-2'}}
                        </td>
                        <td class="text-center">
                            <p-tag [value]="vardiya.durum"
                                [severity]="vardiya.durum === 'ONAYLANDI' ? 'success' : vardiya.durum === 'ACIK' ? 'info' : vardiya.durum === 'REDDEDILDI' ? 'danger' : 'warn'"></p-tag>
                        </td>
                    </tr>
                </ng-template>
                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td [attr.colspan]="raporTuru === 'pompa' ? 4 : 5" class="text-center p-4">Bu tarih aralığında
                            kayıt bulunamadı.</td>
                    </tr>
                </ng-template>
            </p-table>
        </div>
    </div>
</div>