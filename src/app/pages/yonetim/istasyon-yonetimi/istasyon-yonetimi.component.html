<p-toast></p-toast>
<p-confirmDialog></p-confirmDialog>

<!-- MOBILE NATIVE VIEW -->
<div class="istasyon-page block md:hidden">
    <!-- Mobile Native Header -->
    <div class="mobile-page-header">
        <div class="page-title-section">
            <div>
                <h1 class="page-title">İstasyonlar</h1>
                <p class="page-subtitle">Firma ve istasyon yönetimi</p>
            </div>
            <div class="header-actions" *ngIf="isAdmin">
                <button class="add-btn firma-btn" (click)="showFirmaDialog(false)">
                    <i class="pi pi-building"></i>
                </button>
                <button class="add-btn istasyon-btn" (click)="showIstasyonDialog(false)">
                    <i class="pi pi-plus"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Firma Accordion List -->
    <div class="firma-list">
        <ng-container *ngIf="treeData.length > 0; else emptyMobile">
            <div *ngFor="let firmaNode of treeData" class="firma-card">
                <!-- Firma Header -->
                <div class="firma-header" (click)="firmaNode.expanded = !firmaNode.expanded">
                    <div class="firma-info">
                        <div class="firma-icon">
                            <i class="pi pi-building"></i>
                        </div>
                        <div class="firma-details">
                            <h3 class="firma-name">{{ firmaNode.data.ad }}</h3>
                            <p class="firma-meta">{{ firmaNode.data.patronAdi || 'Patron atanmamış' }}</p>
                        </div>
                    </div>
                    <span class="firma-badge">{{ firmaNode.children?.length || 0 }} İstasyon</span>
                    <div class="firma-actions" (click)="$event.stopPropagation()">
                        <button class="firma-action-btn" (click)="showIstasyonDialog(false, null, firmaNode.data.id)"
                            *ngIf="isAdmin">
                            <i class="pi pi-plus"></i>
                        </button>
                        <button class="firma-action-btn" (click)="showFirmaDialog(true, firmaNode.data)"
                            *ngIf="isAdmin">
                            <i class="pi pi-pencil"></i>
                        </button>
                    </div>
                    <i class="pi pi-chevron-down expand-icon" [class.expanded]="firmaNode.expanded"></i>
                </div>

                <!-- İstasyon List - Collapsible -->
                <div class="istasyon-list"
                    *ngIf="firmaNode.expanded && firmaNode.children && firmaNode.children.length > 0">
                    <div *ngFor="let istasyonNode of firmaNode.children" class="istasyon-card">
                        <div class="istasyon-header">
                            <div class="istasyon-name">
                                <i class="pi pi-map-marker"></i>
                                <span>{{ istasyonNode.data.ad }}</span>
                            </div>
                            <div class="istasyon-status">
                                <span class="status-indicator" [class.online]="istasyonNode.data.isOnline"
                                    [class.offline]="!istasyonNode.data.isOnline"></span>
                                <p-tag [value]="istasyonNode.data.aktif ? 'Aktif' : 'Pasif'"
                                    [severity]="istasyonNode.data.aktif ? 'success' : 'danger'"
                                    [style]="{fontSize: '0.65rem'}"></p-tag>
                            </div>
                        </div>

                        <div class="istasyon-body">
                            <div class="istasyon-field">
                                <div class="field-label">İstasyon Sorumlusu</div>
                                <div class="field-value">{{ istasyonNode.data.istasyonSorumlusu || '-' }}</div>
                            </div>
                            <div class="istasyon-field">
                                <div class="field-label">Vardiya Sorumlusu</div>
                                <div class="field-value">{{ istasyonNode.data.vardiyaSorumlusu || '-' }}</div>
                            </div>
                            <div class="istasyon-field">
                                <div class="field-label">Market Sorumlusu</div>
                                <div class="field-value">{{ istasyonNode.data.marketSorumlusu || '-' }}</div>
                            </div>
                            <div class="istasyon-field">
                                <div class="field-label">Cihaz Kilidi</div>
                                <div class="field-value">
                                    <span *ngIf="istasyonNode.data.registeredDeviceId" class="lock-status locked">
                                        <i class="pi pi-lock"></i> Kilitli
                                    </span>
                                    <span *ngIf="!istasyonNode.data.registeredDeviceId" class="lock-status unlocked">
                                        <i class="pi pi-lock-open"></i> Serbest
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="istasyon-actions">
                            <button class="istasyon-action-btn edit-btn"
                                (click)="showIstasyonDialog(true, istasyonNode.data)">
                                <i class="pi pi-pencil"></i> Düzenle
                            </button>
                            <button *ngIf="istasyonNode.data.registeredDeviceId" class="istasyon-action-btn unlock-btn"
                                (click)="unlockStation(istasyonNode.data)">
                                <i class="pi pi-unlock"></i> Kilidi Kaldır
                            </button>
                            <button *ngIf="isAdmin" class="istasyon-action-btn delete-btn"
                                (click)="delete(istasyonNode.data)">
                                <i class="pi pi-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Empty İstasyon -->
                <div class="istasyon-list"
                    *ngIf="firmaNode.expanded && (!firmaNode.children || firmaNode.children.length === 0)">
                    <div class="text-center p-4 text-muted-color text-sm">
                        Bu firmaya ait istasyon bulunmuyor
                    </div>
                </div>
            </div>
        </ng-container>

        <ng-template #emptyMobile>
            <div class="empty-state">
                <div class="empty-icon">
                    <i class="pi pi-building"></i>
                </div>
                <div class="empty-title">Henüz Firma Yok</div>
                <div class="empty-text">Yeni firma eklemek için + butonuna tıklayın</div>
            </div>
        </ng-template>
    </div>
</div>

<!-- DESKTOP VIEW -->
<div class="grid grid-cols-12 gap-4 hidden md:grid">
    <!-- Başlık -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h2 class="text-2xl font-bold text-surface-800 dark:text-surface-100 m-0">
                        <i class="pi pi-building mr-2 text-blue-500"></i>Firma ve İstasyon Yönetimi
                    </h2>
                    <p class="text-surface-500 mt-2">
                        Firmaları ve istasyonları görüntüleyin, yönetin
                    </p>
                </div>
                <div class="flex gap-2" *ngIf="isAdmin">
                    <p-button label="Yeni Firma" icon="pi pi-building" severity="success"
                        (onClick)="showFirmaDialog(false)"></p-button>
                    <p-button label="Yeni İstasyon" icon="pi pi-plus" severity="secondary"
                        (onClick)="showIstasyonDialog(false)"></p-button>
                </div>
            </div>
        </div>
    </div>

    <!-- İstasyon Tree Tablosu -->
    <div class="col-span-12">
        <div class="card">
            <p-treeTable [value]="treeData" [columns]="cols" selectionMode="single" styleClass="p-treetable-sm"
                [tableStyle]="{'table-layout':'fixed'}" #tt>
                <ng-template pTemplate="caption">
                    <div class="flex justify-between items-center">
                        <span class="text-xl font-bold text-surface-900 dark:text-surface-0">Firma ve İstasyon
                            Listesi</span>
                        <p-iconfield>
                            <p-inputicon class="pi pi-search" />
                            <input pInputText type="text" placeholder="Ara..."
                                (input)="tt.filterGlobal($any($event.target).value, 'contains')" />
                        </p-iconfield>
                    </div>
                </ng-template>

                <ng-template pTemplate="header" let-columns>
                    <tr>
                        <th *ngFor="let col of columns"
                            [style.width]="col.field === 'bilgi' ? '40%' : (col.field === 'yonetim' ? '35%' : '15%')">
                            {{col.header}}
                        </th>
                        <th class="text-center" style="width: 10%">İşlemler</th>
                    </tr>
                </ng-template>

                <ng-template pTemplate="body" let-rowNode let-rowData="rowData" let-columns="columns">
                    <tr [ngClass]="{'bg-blue-50/50 dark:bg-blue-900/10': rowData.type === 'firma'}"
                        class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors border-b border-surface-200 dark:border-surface-700">

                        <!-- Bilgi Kolonu -->
                        <td>
                            <p-treeTableToggler [rowNode]="rowNode"></p-treeTableToggler>
                            <div class="inline-flex items-center gap-3 align-middle">
                                <div class="w-10 h-10 rounded-lg flex items-center justify-center shrink-0"
                                    [ngClass]="rowData.type === 'firma' ? 'bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400' : 'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400'">
                                    <i
                                        [class]="rowData.type === 'firma' ? 'pi pi-building text-xl' : 'pi pi-map-marker text-xl'"></i>
                                </div>
                                <div>
                                    <div class="font-bold text-surface-900 dark:text-surface-0 text-base">{{rowData.ad}}
                                    </div>
                                    <div class="text-sm text-surface-500 dark:text-surface-400 flex items-center gap-1"
                                        *ngIf="rowData.adres">
                                        <i class="pi pi-map text-xs"></i>
                                        <span class="truncate max-w-[200px]">{{rowData.adres}}</span>
                                    </div>
                                </div>
                            </div>
                        </td>

                        <!-- Yönetim Ekibi Kolonu -->
                        <td>
                            <!-- Firma için Patron -->
                            <div *ngIf="rowData.type === 'firma'" class="flex items-center gap-2">
                                <p-avatar icon="pi pi-user" shape="circle" styleClass="bg-indigo-100 text-indigo-600"
                                    [pTooltip]="'Firma Sahibi: ' + rowData.patronAdi" tooltipPosition="top"></p-avatar>
                                <div class="flex flex-col">
                                    <span class="text-xs text-surface-500">Firma Sahibi</span>
                                    <span class="text-sm font-medium">{{rowData.patronAdi}}</span>
                                </div>
                            </div>

                            <!-- İstasyon için Sorumlular -->
                            <div *ngIf="rowData.type === 'istasyon'">
                                <p-avatarGroup styleClass="mb-1">
                                    <p-avatar icon="pi pi-user" shape="circle" size="normal"
                                        [styleClass]="rowData.istasyonSorumlusu !== '-' ? 'bg-green-100 text-green-600 cursor-pointer' : 'bg-surface-200 text-surface-400'"
                                        [pTooltip]="'İstasyon Sorumlusu: ' + rowData.istasyonSorumlusu"
                                        tooltipPosition="top"></p-avatar>
                                    <p-avatar icon="pi pi-clock" shape="circle" size="normal"
                                        [styleClass]="rowData.vardiyaSorumlusu !== '-' ? 'bg-green-100 text-green-600 cursor-pointer' : 'bg-surface-200 text-surface-400'"
                                        [pTooltip]="'Vardiya Sorumlusu: ' + rowData.vardiyaSorumlusu"
                                        tooltipPosition="top"></p-avatar>
                                    <p-avatar icon="pi pi-shopping-cart" shape="circle" size="normal"
                                        [styleClass]="rowData.marketSorumlusu !== '-' ? 'bg-green-100 text-green-600 cursor-pointer' : 'bg-surface-200 text-surface-400'"
                                        [pTooltip]="'Market Sorumlusu: ' + rowData.marketSorumlusu"
                                        tooltipPosition="top"></p-avatar>
                                </p-avatarGroup>
                                <div class="text-xs text-surface-500 mt-1"
                                    *ngIf="rowData.istasyonSorumlusu === '-' && rowData.vardiyaSorumlusu === '-' && rowData.marketSorumlusu === '-'">
                                    Henüz sorumlu atanmamış
                                </div>
                            </div>
                        </td>

                        <!-- Durum & Cihaz Kolonu -->
                        <td>
                            <div class="flex flex-col gap-2">
                                <!-- Aktif/Pasif -->
                                <div class="flex items-center gap-2">
                                    <p-tag [value]="rowData.aktif ? 'Aktif' : 'Pasif'"
                                        [severity]="rowData.aktif ? 'success' : 'danger'"
                                        styleClass="text-xs px-2 py-0.5"></p-tag>

                                    <!-- İstasyon Online Durumu -->
                                    <ng-container *ngIf="rowData.type === 'istasyon'">
                                        <div class="w-px h-4 bg-surface-300 dark:bg-surface-600 mx-1"></div>
                                        <div class="flex items-center gap-1"
                                            [pTooltip]="rowData.isOnline ? 'Çevrimiçi' : 'Çevrimdışı'"
                                            tooltipPosition="top">
                                            <div class="w-2 h-2 rounded-full"
                                                [ngClass]="rowData.isOnline ? 'bg-green-500 animate-pulse' : 'bg-gray-400'">
                                            </div>
                                            <span class="text-xs text-surface-600 dark:text-surface-400"
                                                *ngIf="rowData.isOnline">Online</span>
                                        </div>
                                    </ng-container>
                                </div>

                                <!-- Cihaz Kilidi (Sadece İstasyon) -->
                                <div *ngIf="rowData.type === 'istasyon'" class="flex items-center gap-2 text-xs">
                                    <ng-container *ngIf="rowData.registeredDeviceId">
                                        <i class="pi pi-lock text-red-500"></i>
                                        <span class="text-surface-600 dark:text-surface-400">Cihaz Kilitli</span>
                                        <button pButton icon="pi pi-unlock"
                                            class="p-button-text p-button-danger p-button-xs h-6 w-6"
                                            (click)="unlockStation(rowData)" pTooltip="Kilidi Kaldır"
                                            tooltipPosition="top"></button>
                                    </ng-container>
                                    <ng-container *ngIf="!rowData.registeredDeviceId">
                                        <i class="pi pi-lock-open text-green-500"></i>
                                        <span class="text-surface-500 dark:text-surface-400">Cihaz Serbest</span>
                                    </ng-container>
                                </div>
                            </div>
                        </td>

                        <!-- İşlemler -->
                        <td class="text-center">
                            <div class="flex gap-1 justify-center">
                                <!-- Firma İşlemleri -->
                                <ng-container *ngIf="rowData.type === 'firma'">
                                    <button pButton pRipple icon="pi pi-plus"
                                        class="p-button-rounded p-button-text p-button-success w-8 h-8"
                                        (click)="showIstasyonDialog(false, null, rowData.id)" pTooltip="İstasyon Ekle"
                                        tooltipPosition="top">
                                    </button>
                                    <button pButton pRipple icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text p-button-warning w-8 h-8"
                                        (click)="showFirmaDialog(true, rowData)" pTooltip="Firmayı Düzenle"
                                        tooltipPosition="top" *ngIf="isAdmin">
                                    </button>
                                    <button pButton pRipple icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger w-8 h-8"
                                        (click)="delete(rowData)" pTooltip="Firmayı Sil" tooltipPosition="top"
                                        *ngIf="isAdmin">
                                    </button>
                                </ng-container>

                                <!-- İstasyon İşlemleri -->
                                <ng-container *ngIf="rowData.type === 'istasyon'">
                                    <button pButton pRipple icon="pi pi-pencil"
                                        class="p-button-rounded p-button-text p-button-warning w-8 h-8"
                                        (click)="showIstasyonDialog(true, rowData)" pTooltip="İstasyonu Düzenle"
                                        tooltipPosition="top">
                                    </button>
                                    <button pButton pRipple icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger w-8 h-8"
                                        (click)="delete(rowData)" pTooltip="İstasyonu Sil" tooltipPosition="top">
                                    </button>
                                </ng-container>
                            </div>
                        </td>
                    </tr>
                </ng-template>

                <ng-template pTemplate="emptymessage">
                    <tr>
                        <td [attr.colspan]="4" class="text-center py-12">
                            <div class="flex flex-col items-center">
                                <div
                                    class="w-24 h-24 bg-surface-100 dark:bg-surface-800 rounded-full flex items-center justify-center mb-4">
                                    <i class="pi pi-building text-4xl text-surface-400"></i>
                                </div>
                                <h4 class="text-surface-600 dark:text-surface-300 m-0">Henüz firma kaydı yok</h4>
                                <p class="text-surface-400 text-sm m-0 mt-2">
                                    Yeni firma eklemek için "Yeni Firma" butonuna tıklayın
                                </p>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-treeTable>
        </div>
    </div>
</div>

<!-- Firma/İstasyon Dialog -->
<p-dialog [(visible)]="displayDialog" [header]="dialogHeader" [modal]="true" [style]="{width: '500px'}">
    <div class="flex flex-col gap-4">
        <!-- Ortak Alanlar -->
        <div>
            <label for="name" class="block text-sm font-medium mb-2">{{ isFirmaDialog ? 'Firma Adı' : 'İstasyon Adı' }}
                <span class="text-red-500">*</span></label>
            <input type="text" pInputText id="name" [(ngModel)]="name" required autofocus class="w-full" />
        </div>

        <div>
            <label for="address" class="block text-sm font-medium mb-2">Adres</label>
            <input type="text" pInputText id="address" [(ngModel)]="address" class="w-full" />
        </div>

        <!-- Firma Özel Alanlar -->
        <div *ngIf="isFirmaDialog">
            <div *ngIf="isAdmin && !isEditMode">
                <label for="patron" class="block text-sm font-medium mb-2">Firma Sahibi (Patron)</label>
                <p-select [options]="patronOptions" [(ngModel)]="selectedPatronId" optionLabel="label"
                    optionValue="value" placeholder="Seçiniz" [showClear]="true" styleClass="w-full"
                    appendTo="body"></p-select>
            </div>
            <div *ngIf="isEditMode">
                <label class="block text-sm font-medium mb-2">Firma ID</label>
                <input type="text" pInputText [value]="selectedNode?.id" [disabled]="true" class="w-full" />
            </div>
        </div>

        <!-- İstasyon Özel Alanlar -->
        <div *ngIf="!isFirmaDialog">
            <div *ngIf="!isEditMode">
                <label for="firma" class="block text-sm font-medium mb-2">Bağlı Olduğu Firma <span
                        class="text-red-500">*</span></label>
                <p-select [options]="firmaOptions" [(ngModel)]="selectedFirmaId" optionLabel="label" optionValue="value"
                    placeholder="Seçiniz" [disabled]="!!selectedFirmaId && !isAdmin" styleClass="w-full"
                    appendTo="body"></p-select>
            </div>

            <!-- Sorumlu Alanları (Sadece Düzenleme Modunda) -->
            <div *ngIf="isEditMode">
                <div>
                    <label class="block text-sm font-medium mb-2">İstasyon Sorumlusu</label>
                    <div class="flex gap-2">
                        <p-select [options]="istasyonSorumluOptions" [(ngModel)]="selectedIstasyonSorumluId"
                            optionLabel="label" optionValue="value" placeholder="Seçiniz" [showClear]="true"
                            styleClass="flex-1" appendTo="body"></p-select>
                        <button pButton type="button" icon="pi pi-plus" class="p-button-success p-button-sm"
                            (click)="showYeniSorumluDialog('istasyon sorumlusu')"
                            pTooltip="Yeni İstasyon Sorumlusu Ekle" tooltipPosition="top"></button>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Vardiya Sorumlusu</label>
                    <div class="flex gap-2">
                        <p-select [options]="vardiyaSorumluOptions" [(ngModel)]="selectedVardiyaSorumluId"
                            optionLabel="label" optionValue="value" placeholder="Seçiniz" [showClear]="true"
                            styleClass="flex-1" appendTo="body"></p-select>
                        <button pButton type="button" icon="pi pi-plus" class="p-button-success p-button-sm"
                            (click)="showYeniSorumluDialog('vardiya sorumlusu')" pTooltip="Yeni Vardiya Sorumlusu Ekle"
                            tooltipPosition="top"></button>
                    </div>
                </div>

                <div class="mt-4">
                    <label class="block text-sm font-medium mb-2">Market Sorumlusu</label>
                    <div class="flex gap-2">
                        <p-select [options]="marketSorumluOptions" [(ngModel)]="selectedMarketSorumluId"
                            optionLabel="label" optionValue="value" placeholder="Seçiniz" [showClear]="true"
                            styleClass="flex-1" appendTo="body"></p-select>
                        <button pButton type="button" icon="pi pi-plus" class="p-button-success p-button-sm"
                            (click)="showYeniSorumluDialog('market sorumlusu')" pTooltip="Yeni Market Sorumlusu Ekle"
                            tooltipPosition="top"></button>
                    </div>
                </div>
            </div>

            <!-- Yeni Ekleme Modu Bilgilendirme -->
            <div *ngIf="!isEditMode"
                class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border border-blue-200 dark:border-blue-800 mb-4">
                <div class="flex items-center gap-3">
                    <i class="pi pi-info-circle text-blue-500 text-xl"></i>
                    <div>
                        <h4 class="font-medium text-blue-700 dark:text-blue-300 m-0">Sorumlu Ataması</h4>
                        <p class="text-sm text-blue-600 dark:text-blue-400 m-0 mt-1">
                            İstasyon oluşturulduktan sonra "Düzenle" butonuna tıklayarak İstasyon, Vardiya ve Market
                            sorumlularını atayabilirsiniz.
                        </p>
                    </div>
                </div>
            </div>

            <div *ngIf="isEditMode">
                <label class="block text-sm font-medium mb-2">İstasyon ID</label>
                <input type="text" pInputText [value]="selectedNode?.id" [disabled]="true" class="w-full" />
            </div>

            <div *ngIf="isAdmin">
                <label for="apiKey" class="block text-sm font-medium mb-2">API Key (Token)</label>
                <div class="flex gap-2">
                    <input type="text" pInputText id="apiKey" [(ngModel)]="apiKey" class="flex-1" />
                    <p-button icon="pi pi-refresh" (onClick)="generateApiKey()" pTooltip="Yeni Key Oluştur"
                        tooltipPosition="top"></p-button>
                </div>
            </div>
        </div>

        <!-- Durum -->
        <div>
            <label for="aktif" class="block text-sm font-medium mb-2">Durum</label>
            <div class="flex items-center gap-2">
                <p-toggleSwitch [(ngModel)]="isActive" id="aktif"></p-toggleSwitch>
                <p-tag [value]="isActive ? 'Aktif' : 'Pasif'" [severity]="isActive ? 'success' : 'danger'"></p-tag>
            </div>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary" (onClick)="displayDialog = false"></p-button>
        <p-button label="Kaydet" icon="pi pi-check" severity="success" (onClick)="save()"></p-button>
    </ng-template>
</p-dialog>


<!-- Yeni Sorumlu Ekleme Mini Dialog -->
<p-dialog [(visible)]="yeniSorumluDialog" [header]="'Yeni ' + yeniSorumluRole + ' Ekle'" [modal]="true"
    [style]="{width: '400px'}">
    <div class="flex flex-col gap-4">
        <div>
            <label class="block text-sm font-medium mb-2">Ad Soyad <span class="text-red-500">*</span></label>
            <input type="text" pInputText [(ngModel)]="yeniSorumluAdSoyad" class="w-full" placeholder="Ad Soyad" />
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Kullanıcı Adı <span class="text-red-500">*</span></label>
            <input type="text" pInputText [(ngModel)]="yeniSorumluUsername" class="w-full"
                placeholder="Kullanıcı adı" />
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Şifre <span class="text-red-500">*</span></label>
            <input type="password" pInputText [(ngModel)]="yeniSorumluPassword" class="w-full" placeholder="Şifre" />
        </div>

        <div>
            <label class="block text-sm font-medium mb-2">Telefon</label>
            <input type="text" pInputText [(ngModel)]="yeniSorumluTelefon" class="w-full" placeholder="Telefon" />
        </div>
    </div>

    <ng-template pTemplate="footer">
        <button pButton label="İptal" icon="pi pi-times" class="p-button-text"
            (click)="yeniSorumluDialog = false"></button>
        <button pButton label="Kaydet" icon="pi pi-check" (click)="kaydetYeniSorumlu()"></button>
    </ng-template>
</p-dialog>