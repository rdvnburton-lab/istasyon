<p-toast></p-toast>

<div class="grid grid-cols-12 gap-6">
    <!-- Başlık ve Geri Dön -->
    <div class="col-span-12">
        <div class="card">
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <p-button icon="pi pi-arrow-left" severity="secondary" (onClick)="geriDon()" pTooltip="Geri Dön">
                    </p-button>
                    <div>
                        <h2 class="text-2xl font-bold text-surface-800 dark:text-surface-100 m-0">
                            <i class="pi pi-calculator mr-2 text-blue-500"></i>Pompa Mutabakatı
                        </h2>
                        <p class="text-surface-500 mt-1">Personel bazında otomasyon satışları ve pusula girişleri</p>
                    </div>
                </div>

                <div class="flex items-center gap-4" *ngIf="vardiya">
                    <div class="text-right hidden md:block">
                        <div class="text-lg font-bold text-surface-900 dark:text-surface-0">
                            {{ vardiya.baslangicTarihi | date:'dd MMMM yyyy' }}
                        </div>
                        <div class="text-sm text-surface-500 flex items-center justify-end gap-2">
                            <i class="pi pi-clock text-xs"></i>
                            <span>{{ vardiya.baslangicTarihi | date:'HH:mm' }}</span>
                            <span *ngIf="vardiya.bitisTarihi">- {{ vardiya.bitisTarihi | date:'HH:mm' }}</span>
                            <span *ngIf="!vardiya.bitisTarihi" class="text-green-500 font-medium">(Aktif)</span>
                        </div>
                    </div>
                    <div
                        class="w-12 h-12 rounded-full bg-surface-100 dark:bg-surface-800 flex items-center justify-center border border-surface-200 dark:border-surface-700">
                        <i class="pi pi-calendar text-xl text-surface-600 dark:text-surface-400"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reddedilme Uyarısı -->
    <div class="col-span-12" *ngIf="vardiya?.durum === 'REDDEDILDI' || vardiya?.durum === 3">
        <div
            class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4 flex items-start gap-4">
            <i class="pi pi-exclamation-triangle text-red-600 text-2xl mt-1"></i>
            <div>
                <h3 class="font-bold text-red-700 dark:text-red-400 m-0 text-lg">Bu vardiya reddedildi!</h3>
                <p class="text-red-600 dark:text-red-300 mt-1">
                    Red Nedeni: <span class="font-semibold">{{ vardiya.redNedeni || 'Belirtilmedi' }}</span>
                </p>
                <p class="text-sm text-red-500 mt-2">Lütfen gerekli düzeltmeleri yapıp tekrar onaya gönderiniz.</p>
            </div>
        </div>
    </div>
    <!-- Özet Kartları -->
    <div class="col-span-12">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <!-- Kart 1: Otomasyon Toplam -->
            <div
                class="relative overflow-hidden rounded-2xl p-5 backdrop-blur-xl bg-white/60 dark:bg-surface-900/60 border border-white/20 dark:border-surface-700/50 shadow-xl">
                <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full bg-blue-500/20 blur-2xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                            <i class="pi pi-database text-white text-lg"></i>
                        </div>
                        <span
                            class="text-xs font-medium px-2 py-1 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400">Otomasyon</span>
                    </div>
                    <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-1">{{ otomasyonToplam |
                        number:'1.2-2' }} ₺</div>
                    <div class="text-sm text-surface-500">Toplam Satış</div>
                </div>
            </div>

            <!-- Kart 2: Pompacı Satışları -->
            <div
                class="relative overflow-hidden rounded-2xl p-5 backdrop-blur-xl bg-white/60 dark:bg-surface-900/60 border border-white/20 dark:border-surface-700/50 shadow-xl">
                <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full bg-orange-500/20 blur-2xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-orange-500 to-orange-600 flex items-center justify-center shadow-lg">
                            <i class="pi pi-users text-white text-lg"></i>
                        </div>
                        <span
                            class="text-xs font-medium px-2 py-1 rounded-full bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400">{{
                            personelOzetler.length - (filoToplam > 0 ? 1 : 0) }} Kişi</span>
                    </div>
                    <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-1">{{ personelSatisToplam |
                        number:'1.2-2' }} ₺</div>
                    <div class="text-sm text-surface-500">Pompacı Satışları</div>
                </div>
            </div>

            <!-- Kart 3: Filo Satışları -->
            <div
                class="relative overflow-hidden rounded-2xl p-5 backdrop-blur-xl bg-white/60 dark:bg-surface-900/60 border border-white/20 dark:border-surface-700/50 shadow-xl">
                <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full bg-purple-500/20 blur-2xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center shadow-lg">
                            <i class="pi pi-truck text-white text-lg"></i>
                        </div>
                        <span
                            class="text-xs font-medium px-2 py-1 rounded-full bg-purple-100 dark:bg-purple-900/30 text-purple-600 dark:text-purple-400">Otomatik</span>
                    </div>
                    <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-1">{{ filoToplam |
                        number:'1.2-2' }} ₺</div>
                    <div class="text-sm text-surface-500">Filo Satışları</div>
                </div>
            </div>

            <!-- Kart 4: Pusula Toplam -->
            <div
                class="relative overflow-hidden rounded-2xl p-5 backdrop-blur-xl bg-white/60 dark:bg-surface-900/60 border border-white/20 dark:border-surface-700/50 shadow-xl">
                <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full bg-green-500/20 blur-2xl"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div
                            class="w-12 h-12 rounded-xl bg-gradient-to-br from-green-500 to-green-600 flex items-center justify-center shadow-lg">
                            <i class="pi pi-file text-white text-lg"></i>
                        </div>
                        <span
                            class="text-xs font-medium px-2 py-1 rounded-full bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400">{{
                            pusulalar.length }} Giriş</span>
                    </div>
                    <div class="text-2xl font-bold text-surface-900 dark:text-surface-0 mb-1">{{ pusulaToplam |
                        number:'1.2-2' }} ₺</div>
                    <div class="text-sm text-surface-500">Pusula Toplamı</div>
                </div>
            </div>

            <!-- Kart 5: Fark Durumu -->
            <div class="relative overflow-hidden rounded-2xl p-5 backdrop-blur-xl border shadow-xl" [ngClass]="{
                'bg-green-50/60 dark:bg-green-900/20 border-green-200/50 dark:border-green-800/50': Math.abs(fark) < 1,
                'bg-red-50/60 dark:bg-red-900/20 border-red-200/50 dark:border-red-800/50': fark <= -1,
                'bg-orange-50/60 dark:bg-orange-900/20 border-orange-200/50 dark:border-orange-800/50': fark >= 1
            }">
                <div class="absolute -top-10 -right-10 w-24 h-24 rounded-full blur-2xl" [ngClass]="{
                    'bg-green-500/20': Math.abs(fark) < 1,
                    'bg-red-500/20': fark <= -1,
                    'bg-orange-500/20': fark >= 1
                }"></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center shadow-lg" [ngClass]="{
                            'bg-gradient-to-br from-green-500 to-green-600': Math.abs(fark) < 1,
                            'bg-gradient-to-br from-red-500 to-red-600': fark <= -1,
                            'bg-gradient-to-br from-orange-500 to-orange-600': fark >= 1
                        }">
                            <i class="pi text-white text-lg" [ngClass]="{
                                'pi-check-circle': Math.abs(fark) < 1,
                                'pi-exclamation-circle': fark <= -1,
                                'pi-info-circle': fark >= 1
                            }"></i>
                        </div>
                        <span class="text-xs font-medium px-2 py-1 rounded-full" [ngClass]="{
                            'bg-green-100 dark:bg-green-900/30 text-green-600 dark:text-green-400': Math.abs(fark) < 1,
                            'bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400': fark <= -1,
                            'bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400': fark >= 1
                        }">{{ Math.abs(fark) < 1 ? 'Mutabık' : (fark <=-1 ? 'Eksik' : 'Fazla' ) }}</span>
                    </div>
                    <div class="text-2xl font-bold mb-1" [ngClass]="{
                        'text-green-700 dark:text-green-400': Math.abs(fark) < 1,
                        'text-red-700 dark:text-red-400': fark <= -1,
                        'text-orange-700 dark:text-orange-400': fark >= 1
                    }">{{ fark | number:'1.2-2' }} ₺</div>
                    <div class="text-sm text-surface-500">Fark Durumu</div>
                </div>
            </div>
        </div>
    </div>


    <!-- Personel Tablosu -->
    <div class="col-span-12">
        <div class="card">
            <h3 class="text-xl font-bold mb-4">Personel Bazında Satışlar ve Pusula Girişi</h3>
            <p-table [value]="personelOzetler" [loading]="loading" styleClass="p-datatable-striped">
                <ng-template pTemplate="header">
                    <tr class="text-sm">
                        <th>Personel</th>
                        <th class="text-right">Otomasyon Tutar</th>
                        <th class="text-right">Pusula Tutar</th>
                        <th class="text-right">Fark</th>
                        <th class="text-center">Durum</th>
                        <th class="text-center action-column">İşlem</th>
                    </tr>
                </ng-template>
                <ng-template pTemplate="body" let-personel>
                    <tr class="hover:bg-surface-50 dark:hover:bg-surface-800 transition-colors">
                        <td>
                            <div class="flex items-center gap-3">
                                <div
                                    class="w-10 h-10 rounded-full flex items-center justify-center bg-surface-100 dark:bg-surface-700">
                                    <i class="pi pi-user text-surface-600 dark:text-surface-400"></i>
                                </div>
                                <span class="font-medium">{{ personel.personelAdi }}</span>
                                <p-button icon="pi pi-pencil" [rounded]="true" [text]="true" severity="secondary"
                                    size="small" (onClick)="personelDuzenle(personel)"
                                    *ngIf="isEditable && personel.personelAdi !== 'FİLO SATIŞLARI'"></p-button>
                            </div>
                        </td>
                        <td class="text-right">
                            <span class="font-bold text-lg">{{ personel.toplamTutar | number:'1.2-2' }} ₺</span>
                        </td>
                        <td class="text-right">
                            <span class="font-semibold"
                                [ngClass]="isPusulaGirildi(personel.personelAdi) ? 'text-green-600' : 'text-gray-400'">
                                {{ getPusulaTutar(personel.personelAdi) | number:'1.2-2' }} ₺
                            </span>
                        </td>
                        <td class="text-right">
                            <span class="font-bold"
                                [ngClass]="getPersonelFarkClass(getPusulaFark(personel.personelAdi, personel.toplamTutar))">
                                {{ getPusulaFark(personel.personelAdi, personel.toplamTutar) | number:'1.2-2' }} ₺
                            </span>
                        </td>
                        <td class="text-center">
                            <p-tag
                                [severity]="Math.abs(getPusulaFark(personel.personelAdi, personel.toplamTutar)) < 1 ? 'success' : (getPusulaFark(personel.personelAdi, personel.toplamTutar) < 0 ? 'danger' : 'warn')"
                                [value]="Math.abs(getPusulaFark(personel.personelAdi, personel.toplamTutar)) < 1 ? 'Mutabık' : (getPusulaFark(personel.personelAdi, personel.toplamTutar) < 0 ? 'Eksik' : 'Fazla')">
                            </p-tag>
                        </td>
                        <td class="text-center action-column">
                            <div class="flex justify-center gap-2">
                                <!-- Giriş butonu: Pusula yoksa ve düzenlenebilirse -->
                                <p-button
                                    *ngIf="!isPusulaGirildi(personel.personelAdi) && personel.personelAdi !== 'FİLO SATIŞLARI'"
                                    icon="pi pi-plus" [rounded]="true" [text]="true" severity="success"
                                    (onClick)="personelSec(personel)" [disabled]="!isEditable" pTooltip="Pusula Girişi"
                                    tooltipPosition="top">
                                </p-button>

                                <!-- Düzenle butonu -->
                                <p-button
                                    *ngIf="isPusulaGirildi(personel.personelAdi) && personel.personelAdi !== 'FİLO SATIŞLARI'"
                                    icon="pi pi-pencil" [rounded]="true" [text]="true" severity="warn"
                                    (onClick)="personelSec(personel)" [disabled]="!isEditable" pTooltip="Düzenle"
                                    tooltipPosition="top">
                                </p-button>

                                <!-- Önizleme butonu -->
                                <p-button *ngIf="isPusulaGirildi(personel.personelAdi)" icon="pi pi-eye"
                                    [rounded]="true" [text]="true" severity="info" (onClick)="onizle(personel)"
                                    pTooltip="Önizleme" tooltipPosition="top">
                                </p-button>
                            </div>
                        </td>
                    </tr>
                </ng-template>
            </p-table>

            <div class="flex justify-end mt-6" *ngIf="isEditable">
                <p-button label="Mutabakatı Tamamla ve Onaya Gönder" icon="pi pi-check-circle" severity="success"
                    size="large" (onClick)="onayaGonder()" [loading]="loading"></p-button>
            </div>
        </div>
    </div>
</div>

<!-- Pusula Girişi Dialog -->
<p-dialog [header]="seciliPersonel ? seciliPersonel.personelAdi + ' - Pusula Girişi' : 'Pusula Girişi'"
    [(visible)]="pusulaDialogVisible" [modal]="true" [style]="{width: '1100px'}" [breakpoints]="{'960px': '95vw'}">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8" *ngIf="seciliPersonel">
        <!-- Sol Kolon: Form -->
        <div
            class="bg-surface-50 dark:bg-surface-800 rounded-xl p-6 border border-surface-200 dark:border-surface-700 relative shadow-sm">
            <div
                class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500 rounded-t-xl">
            </div>

            <div class="text-center mb-6">
                <div
                    class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-white dark:bg-surface-700 shadow-sm mb-3 text-indigo-600">
                    <i class="pi pi-receipt text-xl"></i>
                </div>
                <h3 class="text-lg font-bold text-surface-900 dark:text-surface-0 m-0">Pusula Önizleme</h3>
                <p class="text-sm text-surface-500 mt-1">{{ currentDate | date:'dd.MM.yyyy' }}</p>
            </div>

            <div class="space-y-4">
                <!-- Satış -->
                <div
                    class="flex justify-between items-center py-2 border-b border-dashed border-surface-300 dark:border-surface-600">
                    <span class="text-surface-600 dark:text-surface-400">Otomasyon Satış</span>
                    <span class="font-bold text-surface-900 dark:text-surface-0">{{ seciliPersonel.toplamTutar |
                        number:'1.2-2' }} ₺</span>
                </div>

                <!-- Tahsilatlar -->
                <div class="space-y-2">
                    <div class="text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Tahsilatlar</div>

                    <div class="flex justify-between items-center text-sm">
                        <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                            <div class="w-2 h-2 rounded-full bg-green-500"></div> Nakit
                        </span>
                        <span class="font-medium">{{ pusulaForm.nakit | number:'1.2-2' }} ₺</span>
                    </div>

                    <div class="flex justify-between items-center text-sm">
                        <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                            <div class="w-2 h-2 rounded-full bg-blue-500"></div> Kredi Kartı
                        </span>
                        <span class="font-medium">{{ pusulaForm.krediKarti | number:'1.2-2' }} ₺</span>
                    </div>

                    <!-- Banka Detayları -->
                    <div *ngIf="pusulaForm.krediKartiDetay && pusulaForm.krediKartiDetay.length > 0"
                        class="pl-5 space-y-1 mb-2">
                        <div *ngFor="let detay of pusulaForm.krediKartiDetay"
                            class="flex justify-between text-xs text-surface-500">
                            <span>{{ detay.banka }}</span>
                            <span>{{ detay.tutar | number:'1.2-2' }} ₺</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center text-sm">
                        <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                            <div class="w-2 h-2 rounded-full bg-yellow-500"></div> Paro Puan
                        </span>
                        <span class="font-medium">{{ pusulaForm.paroPuan | number:'1.2-2' }} ₺</span>
                    </div>

                    <div class="flex justify-between items-center text-sm">
                        <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                            <div class="w-2 h-2 rounded-full bg-purple-500"></div> Mobil Ödeme
                        </span>
                        <span class="font-medium">{{ pusulaForm.mobilOdeme | number:'1.2-2' }} ₺</span>
                    </div>
                </div>

                <!-- Toplam ve Fark -->
                <div class="pt-4 border-t border-surface-300 dark:border-surface-600">
                    <div class="flex justify-between items-center mb-3">
                        <span class="font-bold text-surface-700 dark:text-surface-200">Toplam Tahsilat</span>
                        <span class="font-bold text-lg">{{ getPusulaFormToplam() | number:'1.2-2' }} ₺</span>
                    </div>

                    <div class="p-4 rounded-xl flex justify-between items-center transition-colors duration-300"
                        [ngClass]="{
                            'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': Math.abs(getPusulaFormFark()) < 1,
                            'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': getPusulaFormFark() < -1,
                            'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400': getPusulaFormFark() > 1
                        }">
                        <div class="flex flex-col">
                            <span class="text-xs font-bold uppercase opacity-70">Fark Durumu</span>
                            <span class="font-bold text-xl">{{ getPusulaFormFark() | number:'1.2-2' }} ₺</span>
                        </div>
                        <i class="pi text-2xl" [ngClass]="{
                            'pi-check-circle': Math.abs(getPusulaFormFark()) < 1,
                            'pi-exclamation-circle': Math.abs(getPusulaFormFark()) >= 1
                        }"></i>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex flex-col gap-4">
            <!-- Otomasyon Bilgisi -->
            <div class="p-4 rounded-lg border border-blue-100 bg-blue-50/50 dark:bg-blue-900/10 dark:border-blue-800">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-sm text-blue-600 dark:text-blue-400 font-medium">Otomasyon Tutarı</div>
                        <div class="text-2xl font-bold text-blue-900 dark:text-blue-100">{{ seciliPersonel.toplamTutar |
                            number:'1.2-2' }} ₺</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-600 dark:text-blue-400">{{ seciliPersonel.toplamLitre |
                            number:'1.2-2' }} Litre</div>
                        <div class="text-xs text-blue-500">{{ seciliPersonel.islemSayisi }} işlem</div>
                    </div>
                </div>
            </div>

            <!-- Ödeme Türleri -->
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium mb-2 text-surface-700 dark:text-surface-200">
                        <i class="pi pi-money-bill mr-1 text-green-600"></i>Nakit
                    </label>
                    <p-inputNumber [(ngModel)]="pusulaForm.nakit" mode="currency" currency="TRY" locale="tr-TR"
                        styleClass="w-full" [disabled]="loading" inputStyleClass="w-full"></p-inputNumber>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-surface-700 dark:text-surface-200">
                        <i class="pi pi-credit-card mr-1 text-blue-600"></i>Kredi Kartı
                    </label>
                    <div class="flex gap-2">
                        <p-inputNumber [(ngModel)]="pusulaForm.krediKarti" mode="currency" currency="TRY" locale="tr-TR"
                            styleClass="flex-1" [readonly]="true"
                            [inputStyle]="{'background-color': 'var(--surface-100)'}"
                            inputStyleClass="w-full"></p-inputNumber>
                        <p-button icon="pi pi-list" severity="info" (onClick)="krediKartiDialogAc()"
                            pTooltip="Banka Detayları"></p-button>
                    </div>
                    <small class="text-surface-500"
                        *ngIf="pusulaForm.krediKartiDetay && pusulaForm.krediKartiDetay.length > 0">
                        {{ pusulaForm.krediKartiDetay.length }} banka detayı
                    </small>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-surface-700 dark:text-surface-200">
                        <i class="pi pi-star mr-1 text-yellow-600"></i>Paro Puan
                    </label>
                    <p-inputNumber [(ngModel)]="pusulaForm.paroPuan" mode="currency" currency="TRY" locale="tr-TR"
                        styleClass="w-full" [disabled]="loading" inputStyleClass="w-full"></p-inputNumber>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-2 text-surface-700 dark:text-surface-200">
                        <i class="pi pi-mobile mr-1 text-purple-600"></i>Mobil Ödeme
                    </label>
                    <p-inputNumber [(ngModel)]="pusulaForm.mobilOdeme" mode="currency" currency="TRY" locale="tr-TR"
                        styleClass="w-full" [disabled]="loading" inputStyleClass="w-full"></p-inputNumber>
                </div>
            </div>

            <!-- Açıklama -->
            <div>
                <label class="block text-sm font-medium mb-2 text-surface-700 dark:text-surface-200">Açıklama</label>
                <textarea pInputTextarea [(ngModel)]="pusulaForm.aciklama" rows="3" class="w-full"
                    placeholder="Varsa not ekleyin..." [disabled]="loading"></textarea>
            </div>
        </div>

        <!-- Sağ Kolon: Canlı Önizleme -->

    </div>

    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary" (onClick)="hideDialog()"
            [disabled]="loading"></p-button>
        <p-button label="Kaydet" icon="pi pi-check" severity="success" (onClick)="savePusula()"
            [loading]="loading"></p-button>
    </ng-template>
</p-dialog>

<!-- Kredi Kartı Detayları Dialog -->
<p-dialog header="Kredi Kartı Banka Detayları" [(visible)]="krediKartiDialogVisible" [modal]="true"
    [style]="{width: '500px'}">
    <div class="flex flex-col gap-4">
        <!-- Yeni Banka Ekle -->
        <div class="grid grid-cols-2 gap-2">
            <p-select [(ngModel)]="yeniKrediKarti.banka" [options]="bankalar" placeholder="Banka Seçin"
                styleClass="w-full" appendTo="body"></p-select>
            <div class="flex gap-2">
                <p-inputNumber [(ngModel)]="yeniKrediKarti.tutar" mode="currency" currency="TRY" locale="tr-TR"
                    styleClass="flex-1" placeholder="Tutar"></p-inputNumber>
                <p-button icon="pi pi-plus" severity="success" (onClick)="krediKartiEkle()"></p-button>
            </div>
        </div>

        <p-divider></p-divider>

        <!-- Eklenen Bankalar -->
        <div *ngIf="anlikKrediKartiDetaylari.length > 0">
            <h4 class="text-sm font-bold mb-2">Eklenen Bankalar</h4>
            <div class="flex flex-col gap-2">
                <div *ngFor="let detay of anlikKrediKartiDetaylari; let i = index"
                    class="flex justify-between items-center p-3 bg-surface-50 dark:bg-surface-800 rounded-lg">
                    <div>
                        <div class="font-semibold">{{ detay.banka }}</div>
                        <div class="text-sm text-surface-500">{{ detay.tutar | number:'1.2-2' }} ₺</div>
                    </div>
                    <p-button icon="pi pi-trash" severity="danger" size="small" [text]="true"
                        (onClick)="krediKartiSil(i)"></p-button>
                </div>
            </div>

            <!-- Toplam -->
            <div class="mt-4 pt-4 border-t border-surface-200 dark:border-surface-700">
                <div class="flex justify-between items-center">
                    <span class="font-bold">Toplam</span>
                    <span class="font-bold text-lg text-blue-600">{{ getAnlikKrediKartiToplam() | number:'1.2-2' }}
                        ₺</span>
                </div>
            </div>
        </div>

        <div *ngIf="anlikKrediKartiDetaylari.length === 0" class="text-center py-6 text-surface-400">
            <i class="pi pi-credit-card text-4xl mb-2"></i>
            <p>Henüz banka detayı eklenmedi</p>
        </div>
    </div>

    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary" [text]="true"
            (onClick)="krediKartiDialogVisible = false"></p-button>
        <p-button label="Onayla" icon="pi pi-check" severity="success" (onClick)="krediKartiOnayla()"></p-button>
    </ng-template>
</p-dialog>
<!-- Önizleme Dialog -->
<p-dialog [header]="onizlemeData?.personel?.personelAdi + ' - Pusula Detayı'" [(visible)]="onizlemeDialogVisible"
    [modal]="true" [style]="{width: '500px'}">
    <div *ngIf="onizlemeData" class="relative">
        <!-- Gradient Header -->
        <div class="absolute -top-6 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500">
        </div>

        <!-- Header with Icon -->
        <div class="text-center mb-4">
            <div
                class="inline-flex items-center justify-center w-12 h-12 rounded-full bg-gradient-to-br from-indigo-500 to-purple-600 shadow-lg mb-3">
                <i class="pi pi-receipt text-xl text-white"></i>
            </div>
            <p class="text-sm text-surface-500 mt-1">{{ currentDate | date:'dd.MM.yyyy' }}</p>
        </div>

        <!-- Otomasyon Satış -->
        <div
            class="flex justify-between items-center py-3 px-4 bg-blue-50 dark:bg-blue-900/20 rounded-lg mb-4 border border-blue-100 dark:border-blue-800">
            <span class="text-blue-700 dark:text-blue-300 font-medium">Otomasyon Satış</span>
            <div class="text-right">
                <span class="font-bold text-blue-900 dark:text-blue-100 text-lg">{{ onizlemeData.personel.toplamTutar |
                    number:'1.2-2' }} ₺</span>
                <div class="text-xs text-blue-600 dark:text-blue-400">{{ onizlemeData.personel.toplamLitre |
                    number:'1.2-2' }} L</div>
            </div>
        </div>

        <!-- Tahsilatlar - Normal Personel -->
        <div class="space-y-3" *ngIf="!onizlemeData.isFilo">
            <div class="text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Tahsilatlar</div>

            <div class="flex justify-between items-center text-sm">
                <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                    <div class="w-2 h-2 rounded-full bg-green-500"></div> Nakit
                </span>
                <span class="font-medium">{{ onizlemeData.pusula.nakit | number:'1.2-2' }} ₺</span>
            </div>

            <div class="flex justify-between items-center text-sm">
                <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                    <div class="w-2 h-2 rounded-full bg-blue-500"></div> Kredi Kartı
                </span>
                <span class="font-medium">{{ onizlemeData.pusula.krediKarti | number:'1.2-2' }} ₺</span>
            </div>

            <!-- Banka Detayları -->
            <div *ngIf="onizlemeData.pusula.krediKartiDetay?.length"
                class="pl-5 space-y-1 ml-2 border-l-2 border-blue-200 dark:border-blue-800">
                <div *ngFor="let detay of onizlemeData.pusula.krediKartiDetay"
                    class="flex justify-between text-xs text-surface-500">
                    <span>{{ detay.banka }}</span>
                    <span>{{ detay.tutar | number:'1.2-2' }} ₺</span>
                </div>
            </div>

            <div class="flex justify-between items-center text-sm">
                <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                    <div class="w-2 h-2 rounded-full bg-yellow-500"></div> Paro Puan
                </span>
                <span class="font-medium">{{ onizlemeData.pusula.paroPuan | number:'1.2-2' }} ₺</span>
            </div>

            <div class="flex justify-between items-center text-sm">
                <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                    <div class="w-2 h-2 rounded-full bg-purple-500"></div> Mobil Ödeme
                </span>
                <span class="font-medium">{{ onizlemeData.pusula.mobilOdeme | number:'1.2-2' }} ₺</span>
            </div>
        </div>

        <!-- Filo Detayları -->
        <div class="space-y-3" *ngIf="onizlemeData.isFilo">
            <div class="text-xs font-semibold text-surface-400 uppercase tracking-wider mb-2">Filo Satışları</div>
            <div *ngFor="let detay of onizlemeData.filoDetaylari" class="flex justify-between items-center text-sm">
                <span class="flex items-center gap-2 text-surface-700 dark:text-surface-300">
                    <div class="w-2 h-2 rounded-full bg-purple-500"></div> {{ detay.ad }}
                </span>
                <span class="font-medium">{{ detay.tutar | number:'1.2-2' }} ₺</span>
            </div>
        </div>

        <!-- Toplam ve Fark -->
        <div class="pt-4 mt-4 border-t border-surface-200 dark:border-surface-700">
            <div class="flex justify-between items-center mb-3" *ngIf="!onizlemeData.isFilo">
                <span class="font-bold text-surface-700 dark:text-surface-200">Toplam Tahsilat</span>
                <span class="font-bold text-lg">{{ (onizlemeData.pusula.nakit + onizlemeData.pusula.krediKarti +
                    onizlemeData.pusula.paroPuan + onizlemeData.pusula.mobilOdeme) | number:'1.2-2' }} ₺</span>
            </div>
            <div class="flex justify-between items-center mb-3" *ngIf="onizlemeData.isFilo">
                <span class="font-bold text-surface-700 dark:text-surface-200">Toplam Tahsilat</span>
                <span class="font-bold text-lg">{{ onizlemeData.toplamTutar | number:'1.2-2' }} ₺</span>
            </div>

            <!-- Fark Durumu Kartı -->
            <div class="p-4 rounded-xl flex justify-between items-center" [ngClass]="{
                'bg-green-100 text-green-800 dark:bg-green-900/30 dark:text-green-400': Math.abs(onizlemeData.fark) < 1,
                'bg-red-100 text-red-800 dark:bg-red-900/30 dark:text-red-400': onizlemeData.fark <= -1,
                'bg-blue-100 text-blue-800 dark:bg-blue-900/30 dark:text-blue-400': onizlemeData.fark >= 1
            }">
                <div class="flex flex-col">
                    <span class="text-xs font-bold uppercase opacity-70">Fark Durumu</span>
                    <span class="font-bold text-xl">{{ onizlemeData.fark | number:'1.2-2' }} ₺</span>
                </div>
                <i class="pi text-2xl" [ngClass]="{
                    'pi-check-circle': Math.abs(onizlemeData.fark) < 1,
                    'pi-exclamation-circle': Math.abs(onizlemeData.fark) >= 1
                }"></i>
            </div>
        </div>

        <!-- Açıklama -->
        <div *ngIf="onizlemeData.pusula?.aciklama"
            class="mt-4 p-3 bg-white dark:bg-surface-900 rounded-lg text-sm text-surface-600 dark:text-surface-400 italic border-l-4 border-indigo-500">
            "{{ onizlemeData.pusula.aciklama }}"
        </div>
    </div>

    <ng-template pTemplate="footer">
        <div class="flex justify-between w-full">
            <p-button label="Kapat" icon="pi pi-times" severity="secondary" [text]="true"
                (onClick)="onizlemeDialogVisible = false"></p-button>
            <p-button label="Düzenle" icon="pi pi-pencil" severity="info" (onClick)="onizlemeDuzenle()"
                *ngIf="isEditable && !onizlemeData?.isFilo"></p-button>
        </div>
    </ng-template>
</p-dialog>

<!-- Personel Düzenleme Dialog -->
<p-dialog header="Personel Düzenle" [(visible)]="personelDuzenleDialogVisible" [modal]="true"
    [style]="{width: '450px'}">
    <div class="field p-fluid" *ngIf="duzenlenecekPersonel">
        <label for="adSoyad" class="block mb-2 font-bold">Ad Soyad</label>
        <input type="text" pInputText id="adSoyad" [(ngModel)]="duzenlenecekPersonel.adSoyad" required autofocus
            class="w-full" />
    </div>
    <ng-template pTemplate="footer">
        <p-button label="İptal" icon="pi pi-times" severity="secondary"
            (onClick)="personelDuzenleDialogVisible = false"></p-button>
        <p-button label="Kaydet" icon="pi pi-check" severity="success" (onClick)="personelKaydet()"
            [loading]="loading"></p-button>
    </ng-template>
</p-dialog>