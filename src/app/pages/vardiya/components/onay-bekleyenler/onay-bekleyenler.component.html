<div class="card">
    <div class="flex justify-between items-center mb-8">
        <div class="font-bold text-3xl">Onay Bekleyen Mutabakatlar</div>
        <p-button icon="pi pi-refresh" label="Yenile" [text]="true" (onClick)="yukle()"></p-button>
    </div>

    <p-table [value]="vardiyalar" [tableStyle]="{ 'min-width': '50rem' }" [rows]="10" [paginator]="true">
        <ng-template pTemplate="header">
            <tr>
                <th>ID</th>
                <th>Tarih</th>
                <th>Dosya Adı</th>
                <th>Toplam Tutar</th>
                <th>İstasyon</th>
                <th>Durum</th>
                <th>İşlemler</th>
            </tr>
        </ng-template>
        <ng-template pTemplate="body" let-vardiya>
            <tr>
                <td><span class="text-muted-color">#</span>{{ vardiya.id }}</td>
                <td>{{ vardiya.baslangicTarihi | date:'dd.MM.yyyy HH:mm' }}</td>
                <td class="font-medium">{{ vardiya.dosyaAdi }}</td>
                <td class="font-bold text-lg">{{ vardiya.genelToplam | currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                <td>{{ vardiya.istasyonAdi }}</td>
                <td>
                    <p-tag [value]="'Onay Bekliyor'" severity="warning" icon="pi pi-clock"></p-tag>
                </td>
                <td>
                    <div class="flex gap-2">
                        <p-button icon="pi pi-search" label="İncele" severity="info" [rounded]="true" [outlined]="true"
                            tooltipPosition="top" pTooltip="Detayları İncele" (onClick)="incele(vardiya)"></p-button>
                    </div>
                </td>
            </tr>
        </ng-template>
        <ng-template pTemplate="emptymessage">
            <tr>
                <td colspan="7" class="text-center p-8">
                    <div class="flex flex-col items-center gap-4 text-muted-color opacity-60">
                        <i class="pi pi-check-circle text-6xl"></i>
                        <span class="font-medium text-xl">Bekleyen onay bulunmuyor. Her şey yolunda!</span>
                    </div>
                </td>
            </tr>
        </ng-template>
    </p-table>

    <!-- Detay Modalı -->
    <p-dialog [(visible)]="detayVisible" [modal]="true" [header]="'Mutabakat Detayı: ' + seciliVardiya?.dosyaAdi"
        [style]="{ width: '90vw' }" [maximizable]="true" [draggable]="false" [resizable]="false">

        <div *ngIf="seciliVardiya && genelOzet" class="flex flex-col gap-6">

            <!-- Üst Bilgi Kartları -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div
                    class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                    <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Genel Ciro</span>
                    <span class="text-3xl font-bold text-primary">{{ genelOzet.genelToplam |
                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                </div>
                <div
                    class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                    <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Toplam
                        Tahsilat</span>
                    <span class="text-3xl font-bold text-green-600">{{ (genelOzet.toplamNakit +
                        genelOzet.toplamKrediKarti + genelOzet.toplamVeresiye) | currency:'TRY':'symbol-narrow':'1.2-2'
                        }}</span>
                </div>
                <div
                    class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center">
                    <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Toplam Gider</span>
                    <span class="text-3xl font-bold text-red-500">{{ genelOzet.toplamGider |
                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                </div>
                <div
                    class="surface-card p-4 shadow-sm border border-surface-200 rounded-xl flex flex-col items-center justify-center text-center bg-gray-50 dark:bg-gray-800">
                    <span class="text-sm text-muted-color font-medium uppercase tracking-wide mb-2">Fark Durumu</span>
                    <div class="flex items-center gap-2">
                        <i class="pi pi-circle-fill text-xs"
                            [ngClass]="{'text-green-500': genelOzet.durumRenk === 'success', 'text-orange-500': genelOzet.durumRenk === 'warn', 'text-red-500': genelOzet.durumRenk === 'danger'}"></i>
                        <span class="text-3xl font-bold"
                            [ngClass]="{'text-green-600': genelOzet.durumRenk === 'success', 'text-orange-600': genelOzet.durumRenk === 'warn', 'text-red-600': genelOzet.durumRenk === 'danger'}">
                            {{ genelOzet.toplamFark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                        </span>
                    </div>
                </div>
            </div>

            <p-tabs value="0">
                <p-tablist>
                    <p-tab value="0">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-users"></i>
                            <span>Pompa & Personel</span>
                        </div>
                    </p-tab>
                    <p-tab value="1">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-shopping-cart"></i>
                            <span>Market</span>
                        </div>
                    </p-tab>
                    <p-tab value="2">
                        <div class="flex items-center gap-2">
                            <i class="pi pi-wallet"></i>
                            <span>Giderler</span>
                        </div>
                    </p-tab>
                </p-tablist>

                <p-tabpanels>
                    <!-- SEKME 1: POMPA & PERSONEL -->
                    <p-tabpanel value="0">
                        <div class="grid grid-cols-1 mt-4">
                            <p-table [value]="farkAnalizi" styleClass="p-datatable-sm p-datatable-striped"
                                [rowHover]="true">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Personel</th>
                                        <th class="text-right">Otomasyon Satış</th>
                                        <th class="text-right">Pusula Tahsilat</th>
                                        <th class="text-right">Fark</th>
                                        <th class="text-center">Durum</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-item>
                                    <tr>
                                        <td class="font-medium">{{ item.personelAdi }}</td>
                                        <td class="text-right text-muted-color">{{ item.otomasyonToplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                        <td class="text-right font-bold">{{ item.pusulaToplam |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                        <td class="text-right"
                                            [ngClass]="{'text-red-500': item.fark < -1, 'text-green-500': item.fark > 1}">
                                            {{ item.fark | currency:'TRY':'symbol-narrow':'1.2-2' }}
                                        </td>
                                        <td class="text-center">
                                            <p-tag *ngIf="item.farkDurum === 'UYUMLU'" value="Uyumlu"
                                                severity="success"></p-tag>
                                            <p-tag *ngIf="item.farkDurum === 'ACIK'" value="Açık"
                                                severity="danger"></p-tag>
                                            <p-tag *ngIf="item.farkDurum === 'FAZLA'" value="Fazla"
                                                severity="warning"></p-tag>
                                        </td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </p-tabpanel>

                    <!-- SEKME 2: MARKET -->
                    <p-tabpanel value="1">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-4" *ngIf="marketOzet">
                            <div class="flex flex-col gap-4">
                                <h3 class="text-lg font-bold border-b pb-2">Z-Raporu ve Satışlar</h3>
                                <div class="flex justify-between p-3 bg-surface-50 rounded">
                                    <span>Z Raporu Toplamı</span>
                                    <span class="font-bold">{{ marketOzet.zRaporuToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between p-3 rounded">
                                    <span>Toplam KDV</span>
                                    <span>{{ marketOzet.kdvDokum.toplam | currency:'TRY':'symbol-narrow':'1.2-2'
                                        }}</span>
                                </div>
                            </div>
                            <div class="flex flex-col gap-4">
                                <h3 class="text-lg font-bold border-b pb-2">Kasa Durumu</h3>
                                <div class="flex justify-between p-3 bg-surface-50 rounded">
                                    <span>Toplam Tahsilat (Nakit+KK)</span>
                                    <span class="font-bold text-green-600">{{ marketOzet.tahsilatToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between p-3 rounded">
                                    <span>Market Giderleri</span>
                                    <span class="text-red-500">- {{ marketOzet.giderToplam |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                                <div class="flex justify-between p-3 bg-blue-50 rounded border border-blue-100">
                                    <span class="font-bold text-blue-800">Net Kasa</span>
                                    <span class="font-bold text-blue-800">{{ marketOzet.netKasa |
                                        currency:'TRY':'symbol-narrow':'1.2-2' }}</span>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="!marketOzet" class="text-center p-8 text-muted-color">Market verisi bulunamadı.
                        </div>
                    </p-tabpanel>

                    <!-- SEKME 3: GİDERLER -->
                    <p-tabpanel value="2">
                        <div class="mt-4">
                            <p-table
                                [value]="(vardiyaOzet?.pompaOzet?.giderToplam ? [{tutar: vardiyaOzet?.pompaOzet?.giderToplam, tur: 'Pompa Giderleri'}] : [])"
                                styleClass="p-datatable-sm">
                                <ng-template pTemplate="header">
                                    <tr>
                                        <th>Gider Türü</th>
                                        <th class="text-right">Tutar</th>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="body" let-gider>
                                    <tr>
                                        <td>{{gider.tur}}</td>
                                        <td class="text-right font-bold text-red-500">{{gider.tutar |
                                            currency:'TRY':'symbol-narrow':'1.2-2'}}</td>
                                    </tr>
                                </ng-template>
                                <ng-template pTemplate="footer">
                                    <tr>
                                        <td class="text-right font-bold">Toplam Gider:</td>
                                        <td class="text-right font-bold text-red-600">{{ genelOzet.toplamGider |
                                            currency:'TRY':'symbol-narrow':'1.2-2' }}</td>
                                    </tr>
                                </ng-template>
                            </p-table>
                        </div>
                    </p-tabpanel>
                </p-tabpanels>
            </p-tabs>

            <div class="flex justify-between items-center mt-6 pt-6 border-t border-surface-200">
                <div class="text-sm text-muted-color">
                    Onaya gönderen: Sistem<br>
                    Tarih: {{ seciliVardiya.guncellemeTarihi | date:'dd.MM.yyyy HH:mm' }}
                </div>
                <div class="flex gap-3">
                    <p-button label="Reddet" icon="pi pi-times" severity="danger" [outlined]="true"
                        (onClick)="reddetDialogAc(seciliVardiya)"></p-button>
                    <p-button label="Onayla ve Kapat" icon="pi pi-check" severity="success"
                        (onClick)="onayla(seciliVardiya)"></p-button>
                </div>
            </div>
        </div>
    </p-dialog>

    <!-- Reddetme Dialog -->
    <p-dialog header="Vardiya Red İşlemi" [(visible)]="redDialogVisible" [modal]="true" [style]="{width: '450px'}">
        <div class="flex flex-col gap-4">
            <p class="text-muted-color mb-2">Bu mutabakatı reddetmek üzeresiniz. Lütfen aşağıya işlemin nedenini
                açıklayan bir not giriniz.</p>
            <div class="flex flex-col gap-2">
                <label for="neden" class="font-bold">Red Nedeni</label>
                <textarea pInputTextarea id="neden" [(ngModel)]="redNedeni" rows="4" class="w-full"
                    placeholder="Örn: Kasa sayımında eksik var, fişler kontrol edilmeli..."></textarea>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button label="İptal" icon="pi pi-times" [text]="true" (onClick)="redDialogVisible = false"></p-button>
            <p-button label="Reddet" icon="pi pi-check" severity="danger" (onClick)="reddetIslemi()"></p-button>
        </ng-template>
    </p-dialog>

    <p-confirmDialog [style]="{width: '450px'}"></p-confirmDialog>
</div>